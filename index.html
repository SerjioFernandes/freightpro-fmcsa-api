<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FreightPro - Professional Load Board System</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <!-- FontAwesome Icons -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        
        <script>
            // Backend API Configuration (auto-detect environment)
            (function configureApiBaseUrl(){
                const LOCAL_API = 'http://localhost:4000/api';
                // Primary production API on Render for Netlify
                const DEFAULT_PROD_API = 'https://freightpro-fmcsa-api.onrender.com/api';
                const storedValue = (typeof localStorage !== 'undefined') ? localStorage.getItem('FP_API_BASE_URL') : null;

                let selectedBaseUrl = storedValue && storedValue.trim();

                if (!selectedBaseUrl) {
                    const { hostname, search } = window.location;
                    // Allow quick override via URL: ?api=https://your-api
                    try {
                        const params = new URLSearchParams(search || '');
                        const apiOverride = params.get('api');
                        if (apiOverride && /^https?:\/\//i.test(apiOverride)) {
                            selectedBaseUrl = apiOverride.trim();
                        }
                    } catch(e) {}

                    if (hostname && hostname.indexOf('localhost') === 0) {
                        selectedBaseUrl = LOCAL_API;
                    } else if (hostname && hostname.includes('netlify.app')) {
                        selectedBaseUrl = DEFAULT_PROD_API;
                    } else if (hostname && hostname.includes('onrender.com')) {
                        selectedBaseUrl = `${window.location.origin.replace(/\/$/, '')}/api`;
                    } else if (hostname) {
                        selectedBaseUrl = DEFAULT_PROD_API;
                    } else {
                        selectedBaseUrl = LOCAL_API;
                    }
                }

                if (typeof window !== 'undefined') {
                    window.API_BASE_URL = selectedBaseUrl;
                    window.setFreightProApiBaseUrl = function(newUrl) {
                        if (!newUrl) return;
                        if (typeof localStorage !== 'undefined') {
                            localStorage.setItem('FP_API_BASE_URL', newUrl);
                        }
                        window.API_BASE_URL = newUrl;
                        console.info('FreightPro API base URL updated to:', newUrl);
                    };
                }

                console.info('[FreightPro] Using API base URL:', selectedBaseUrl);
            })();
            
            // Suppress Tailwind CDN warning for this static deployment
            if (typeof console !== 'undefined' && console.warn) {
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && args[0].includes && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                        return; // Suppress this specific warning for static sites
                    }
                    originalWarn.apply(console, args);
                };
            }
            
            // Minimal Tailwind config for theme colors
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: '#1a2238', // deep blue
                            secondary: '#283655', // muted blue
                            accent: '#ff6a3d', // orange accent
                            neutral: '#eaeaea'
                        }
                    }
                }
            };
        </script>
        <!-- Safe lazy-load shim for the rates analysis module. Placed in its own script tag. -->
        <script>
        (function(){
            function callIfReady(){
                if (typeof initializeRateAnalysis === 'function'){
                    try { initializeRateAnalysis(); } catch(e){ console.info('initializeRateAnalysis threw:', e); }
                    return true;
                }
                return false;
            }

            // Attempt a best-effort immediate call (for cases where rates.js was inlined earlier)
            callIfReady();

            // Wire the placeholder button to lazy-load an optional rates.js script.
        })();
        </script>
        
        <style>
                /* Inline load details: taller and scrollable so more info fits (mini-details panel) */
                .load-details {
                    max-height: 340px;
                    overflow-y: auto;
                    padding: 12px;
                    font-size: 0.95rem;
                    line-height: 1.35;
                }
                .real-time-indicator {
                    display: inline-flex;
                    align-items: center;
                    background: #10b981;
                    color: white;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 12px;
                    font-weight: bold;
                }
                .real-time-indicator::before {
                    content: '';
                    width: 6px;
                    height: 6px;
                    background: #00ff41;
                    border-radius: 50%;
                    margin-right: 4px;
                    animation: live-blink 2s ease-in-out infinite;
                }
                @keyframes live-blink {
                    0% { opacity: 1; background: #00ff41; box-shadow: 0 0 8px #00ff41, 0 0 12px #00ff41; }
                    50% { opacity: 0.4; background: #22c55e; box-shadow: 0 0 4px #22c55e; }
                    100% { opacity: 1; background: #00ff41; box-shadow: 0 0 8px #00ff41, 0 0 12px #00ff41; }
                }
                @keyframes pulse-slow {
                    0%, 100% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.05); opacity: 0.9; }
                }
                .animate-pulse-slow {
                    animation: pulse-slow 3s ease-in-out infinite;
                }
                
                /* Registration form container - 39% width */
                .registration-form-container {
                    max-width: 39% !important;
                    width: 39% !important;
                }
                .smart-search-suggestion {
                    padding: 8px 12px;
                    cursor: pointer;
                    border-bottom: 1px solid #e5e7eb;
                    transition: background-color 0.2s;
                }
                .smart-search-suggestion:hover {
                    background-color: #f3f4f6;
                }
            /* Prevent body scroll when modal/overlay active */
            .no-scroll { overflow: hidden !important; }
                .nav-item {
                    position: relative;
                    border-radius: 6px;
                    transition: all 0.2s ease;
                    font-weight: 500;
                }
                
                .nav-item:hover {
                    background-color: rgba(255, 255, 255, 0.15);
                    transform: translateY(-1px);
                }
                .nav-item.active {
                    background-color: rgba(255, 255, 255, 0.25);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                }
                
                /* Enhanced Navigation Layout */
                .desktop-nav {
                    flex: 1;
                    justify-content: center;
                    margin: 0 2rem;
                }
                
                /* Right-side Auth Buttons */
                #authButtons {
                    margin-left: auto;
                }
                
                /* Responsive Navigation */
                @media (max-width: 1024px) {
                    .desktop-nav {
                        margin: 0 1rem;
                    }
                }
                .sidebar {
                    position: fixed;
                    left: -300px;
                    top: 0;
                    width: 300px;
                    height: 100vh;
                    background: #1e3a8a;
                    transition: left 0.3s ease;
                    z-index: 1000;
                    overflow-y: auto;
                }
                .sidebar.open {
                    left: 0;
                }
                .sidebar-overlay {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100vw;
                    height: 100vh;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 999;
                    opacity: 0;
                    visibility: hidden;
                    transition: all 0.3s ease;
                }
                .sidebar-overlay.show {
                    opacity: 1;
                    visibility: visible;
                }
                
                /* USDOT Option Buttons */
                .usdot-option-btn {
                    display: flex;
                    align-items: center;
                    padding: 24px;
                    border-radius: 16px;
                    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                    border: 2px solid transparent;
                }
                
                .usdot-option-btn:hover {
                    transform: translateY(-4px) scale(1.02);
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
                    border-color: rgba(255, 255, 255, 0.3);
                }
                
                                .usdot-option-btn:active {
                    transform: translateY(-2px) scale(0.98);
                }
                @media (max-width: 768px) {
                    .desktop-nav {
                        display: none;
                    }
                }
                .rate-trend-up {
                    color: #10b981;
                }
                .rate-trend-down {
                    color: #ef4444;
                }
                .equipment-icon {
                    width: 24px;
                    height: 24px;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    border-radius: 4px;
                    font-size: 12px;
                    font-weight: bold;
                    color: white;
                }
                .equipment-van { background: #3b82f6; }
                .equipment-flatbed { background: #10b981; }
                .equipment-reefer { background: #06b6d4; }
                .equipment-stepdeck { background: #8b5cf6; }
                .equipment-lowboy { background: #f59e0b; }
                /* Billing toggle animation */
                .billing-toggle button{transition:transform .22s cubic-bezier(.2,.9,.2,1),box-shadow .22s ease,background-color .22s ease,color .22s ease}
                .billing-toggle button.billing-active{transform:translateY(0);box-shadow:0 6px 18px rgba(59,130,246,.12)}
                .equipment-tanker { background: #ef4444; }
                .equipment-container { background: #6b7280; }
                .equipment-carrier { background: #ec4899; }
                /* Make small/secondary text in the home hero match the top nav (white) */
                .hero-top p,
                .hero-top .text-sm,
                .hero-top .text-neutral-100 {
                    color: #ffffff !important;
                }
                /* Registration background: original embedded wallpaper removed; lightweight override later in the file will provide decorative background */
                .register-hero {
                    min-height: 680px;
                    padding-top: 48px;
                }
                /* Logo clickable styles */
                .logo-clickable {
                    cursor: pointer;
                    transition: all 0.2s ease;
                }
                
                .logo-clickable:hover {
                    transform: scale(1.05);
                    filter: brightness(1.1);
                }
                
                .logo-clickable:active {
                    transform: scale(0.98);
                }
                
        /* Navigation Arrow Styles - Beautiful Design */
        .nav-arrow-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 18px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        
        .nav-arrow-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.8s ease;
            z-index: -1;
        }
        
        .nav-arrow-btn:hover::before {
            left: 100%;
        }
        
        .nav-arrow-btn:hover {
            background: linear-gradient(135deg, #ff8c42, #ffa726);
            color: white;
            border-color: rgba(255, 255, 255, 0.7);
            transform: translateY(-4px) scale(1.15) rotate(2deg);
            box-shadow: 0 12px 30px rgba(255, 107, 53, 0.6);
        }
        
        .nav-arrow-btn:active {
            transform: translateY(-2px) scale(0.98);
            transition: all 0.1s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.8);
        }
        
        /* Click animation */
        .nav-arrow-btn.clicked {
            animation: navArrowClick 0.3s ease-out;
        }
        
        @keyframes navArrowClick {
            0% { transform: scale(1); }
            50% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        
        .nav-arrow-btn.disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-color: rgba(107, 114, 128, 0.4);
            color: rgba(255, 255, 255, 0.4);
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }
        
        .nav-arrow-btn.disabled:hover {
            transform: none;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Ensure proper cursor for enabled buttons */
        .nav-arrow-btn:not(.disabled) {
            cursor: pointer !important;
        }
        
        /* Beautiful animations */
        @keyframes navArrowFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-2px); }
        }
        
        @keyframes navArrowGlow {
            0%, 100% { box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4); }
            50% { box-shadow: 0 6px 25px rgba(255, 107, 53, 0.7); }
        }
        
        .nav-arrow-btn:not(.disabled) {
            animation: navArrowFloat 3s ease-in-out infinite, navArrowGlow 2s ease-in-out infinite;
        }
        
        .nav-arrow-btn:hover:not(.disabled) {
            animation: none;
        }
        
        /* Mobile Navigation Arrow Styles - Beautiful Design */
        .nav-arrow-btn-mobile {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 22px;
            font-weight: 700;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 10;
        }
        
        .nav-arrow-btn-mobile::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.8s ease;
            z-index: -1;
        }
        
        .nav-arrow-btn-mobile:hover::before {
            left: 100%;
        }
        
        .nav-arrow-btn-mobile:hover {
            background: linear-gradient(135deg, #ff8c42, #ffa726);
            color: white;
            border-color: rgba(255, 255, 255, 0.7);
            transform: translateY(-4px) scale(1.15) rotate(2deg);
            box-shadow: 0 12px 30px rgba(255, 107, 53, 0.6);
        }
        
        .nav-arrow-btn-mobile:active {
            transform: translateY(-2px) scale(0.98);
            transition: all 0.1s ease;
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.8);
        }
        
        /* Click animation for mobile */
        .nav-arrow-btn-mobile.clicked {
            animation: navArrowClick 0.3s ease-out;
        }
        
        /* Disabled state for mobile */
        .nav-arrow-btn-mobile.disabled {
            opacity: 0.3;
            cursor: not-allowed !important;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            border-color: rgba(107, 114, 128, 0.4);
            color: rgba(255, 255, 255, 0.4);
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            pointer-events: none;
        }
        
        .nav-arrow-btn-mobile.disabled:hover {
            transform: none;
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Ensure proper cursor for enabled mobile buttons */
        .nav-arrow-btn-mobile:not(.disabled) {
            cursor: pointer !important;
        }
        
        /* Beautiful animations for mobile */
        .nav-arrow-btn-mobile:not(.disabled) {
            animation: navArrowFloat 3s ease-in-out infinite, navArrowGlow 2s ease-in-out infinite;
        }
        
        .nav-arrow-btn-mobile:hover:not(.disabled) {
            animation: none;
        }
        
        /* Enhanced Registration Form Styles */
        .verification-button {
            transition: all 0.3s ease;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .verification-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .verification-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .authority-type-section {
            border: 2px solid #dbeafe;
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
        }
        
        .authority-type-section:hover {
            border-color: #93c5fd;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
        }
        
        /* Authority Verification Page Styles */
        .authority-verification-container {
            max-width: 56rem;
            margin-left: auto;
            margin-right: auto;
            padding: 1.5rem;
        }
        
        
        .manual-company-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        @media (min-width: 768px) {
            .manual-company-form {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .manual-company-input {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            background-color: rgba(249, 250, 251, 0.5);
            transition: all 0.3s ease;
        }
        
        .manual-company-input::placeholder {
            color: #9ca3af;
        }
        
        .manual-company-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        .manual-company-input:hover {
            background-color: white;
            border-color: #d1d5db;
        }
        
        .authority-nav-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: colors 0.2s ease;
            font-weight: 500;
        }
        
        .authority-nav-btn.back {
            background-color: #6b7280;
            color: white;
        }
        
        .authority-nav-btn.back:hover {
            background-color: #4b5563;
        }
        
        .authority-nav-btn.continue {
            background-color: #2563eb;
            color: white;
        }
        
        .authority-nav-btn.continue:hover {
            background-color: #1d4ed8;
        }
                /* Pricing plan button consistency */
                .pricing-card button {
                    height: 44px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 600;
                    transition: all 0.2s ease;
                }
                
                .pricing-card button:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                /* Ensure Ultima card content alignment */
                .pricing-card.relative {
                    padding-top: 1.5rem;
                }
                
                .pricing-card.relative .pt-6 {
                    padding-top: 0 !important;
                }
                
                /* Force all pricing card buttons to have exactly the same height */
                #chooseBasic, #chooseAdvanced, #chooseUltima {
                    height: 44px !important;
                    min-height: 44px !important;
                    max-height: 44px !important;
                    line-height: 44px !important;
                    padding-top: 0 !important;
                    padding-bottom: 0 !important;
                }
                
                /* Ensure Ultima card button container doesn't have extra spacing */
                .pricing-card.relative .mt-6 {
                    margin-top: 1.5rem !important;
                    padding-top: 0 !important;
                }
                
                /* Force all pricing cards to have the same content height */
                .pricing-card {
                    display: flex;
                    flex-direction: column;
                }
                
                .pricing-card > div:last-child {
                    margin-top: auto;
                }
                
                /* Ensure button containers are at the same level */
                .pricing-card .mt-6 {
                    margin-top: 1.5rem !important;
                    position: relative;
                    bottom: 0;
                }
                
                /* Billing toggle button styling */
                #billingMonthly, #billingYearly {
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                    cursor: pointer;
                    border: 2px solid transparent;
                }
                
                #billingMonthly:hover, #billingYearly:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                }
                
                #billingMonthly:active, #billingYearly:active {
                    transform: translateY(0);
                }
                
                /* Toggle container styling */
                .billing-toggle-container {
                    background: linear-gradient(145deg, #f3f4f6, #e5e7eb);
                    border: 2px solid #d1d5db;
                    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
                }
                
                /* Clean toggle styling to match the image exactly */
                #billingToggleContainer {
                    background: #facc15 !important; /* Light gray background */
                    border: none;
                    box-shadow: none;
                    transition: all 0.3s ease;
                    width: 12rem !important; /* 192px */
                    height: 3rem !important; /* 48px */
                }
                
                #billingToggleKnob {
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
                    background: #1e3d9c !important; /* Darker gray knob */
                    border: none;
                    width: 5.5rem !important; /* 88px - adjusted from inspect tools */
                    height: 2.5rem !important; /* 40px */
                    transition: all 0.3s ease;
                    position: absolute;
                    top: 0.25rem;
                    left: -1rem; /* Adjusted from inspect tools */
                    right: 0rem; /* Added from inspect tools */
                }
                
                /* Text styling */
                #monthlyLabel, #yearlyLabel {
                    font-size: 0.875rem !important; /* 14px */
                    font-weight: 600 !important; /* font-semibold */
                    line-height: 1.25rem !important;
                    white-space: nowrap;
                    transition: all 0.3s ease;
                }
                
                /* Initial state: Monthly white (selected), Yearly gray (not selected) */
                #monthlyLabel {
                    color: #ffffff !important; /* White text for selected */
                }
                
                #yearlyLabel {
                    color: #ffffff !important; /* Gray text for not selected */
                }
                #monthlyLabel, #yearlyLabel {
                    font-size: 1rem !important; /* text-base = 16px */
                    font-weight: 600 !important; /* font-semibold */
                    line-height: 1.5rem !important;
                    white-space: nowrap;
                    letter-spacing: -0.025em;
                    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                    transition: all 0.3s ease-out;
                }
                
                /* Active state text styling - more prominent */
                #monthlyLabel.active, #yearlyLabel.active {
                    color: #1e293b !important; /* slate-800 - darker, more prominent */
                    font-weight: 700 !important; /* font-bold */
                    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                    transform: scale(1.02);
                }
                
                /* Inactive state text styling - more subtle */
                #monthlyLabel.inactive, #yearlyLabel.inactive {
                    color: #64748b !important; /* slate-500 - lighter, more subtle */
                    font-weight: 500 !important; /* font-medium */
                    transform: scale(1);
                }
                
                /* Style the savings text */
                #yearlyLabel + div {
                    font-size: 0.75rem !important; /* text-xs = 12px */
                    font-weight: 700 !important; /* font-bold */
                    line-height: 1rem !important; /* mt-1 */
                }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 30px rgba(147, 51, 234, 0.8), 0 0 40px rgba(236, 72, 153, 0.6); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        .animate-glow {
            animation: glow 2s ease-in-out infinite;
        }
        
        .shadow-3xl {
            box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.25);
        }
        /* Chat panel border */
        div#fpChatPanel {
            border: 1px;
        }
        /* Chat send button offset */
        #fpChatSend{
            margin-bottom: 6.1px;
        }
    </style>
    <script>
            // Pricing guest banner: show a 6-hour promo window for visitors who are not logged in
            (function pricingGuestOffer(){
                const OFFER_KEY = 'pricingGuestOfferStart_v1';
                const EXT_KEY = 'pricingGuestOfferExt_v1';
                const DURATION_MS = 6 * 60 * 60 * 1000; // 6 hours
                const EXTRA_MS = 3 * 60 * 60 * 1000; // 3 hours one-time extension

                function now(){ return (new Date()).getTime(); }

                function getStart(){ try { return parseInt(localStorage.getItem(OFFER_KEY), 10) || 0; } catch(e){ return 0; } }
                function setStart(ts){ try { localStorage.setItem(OFFER_KEY, ''+ts); } catch(e){} }
                function getExtExpiry(){ try { return parseInt(localStorage.getItem(EXT_KEY),10) || 0; } catch(e){ return 0; } }
                function setExtExpiry(ts){ try { localStorage.setItem(EXT_KEY, ''+ts); } catch(e){} }

                function formatRemaining(ms){
                    if (ms <= 0) return '00:00:00';
                    const s = Math.floor(ms/1000);
                    const hh = String(Math.floor(s/3600)).padStart(2,'0');
                    const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
                    const ss = String(s%60).padStart(2,'0');
                    return hh+':'+mm+':'+ss;
                }

                function showBanner(remainingMs, state){
                    // state: 'active' | 'expired' | 'extended'
                    const banner = document.getElementById('pricingGuestBanner');
                    const countdown = document.getElementById('pricingCountdown');
                    const cta = document.getElementById('pricingGuestCTA');
                    const text = document.getElementById('pricingGuestText');
                    if (!banner || !countdown || !cta || !text) return;

                    if (state === 'active') {
                        countdown.textContent = formatRemaining(remainingMs);
                        text.innerHTML = 'Register within <span id="pricingCountdown">' + countdown.textContent + '</span> and get 3 months free Ultima subscription';
                        cta.textContent = 'Register Now';
                        cta.onclick = function(){ showPage('register'); };
                        banner.classList.remove('hidden');
                        return;
                    }

                    if (state === 'expired') {
                        // offer expired and no extension used yet
                        countdown.textContent = '00:00:00';
                        text.textContent = 'Offer expired — claim an extra 3 hours to register and receive the bonus';
                        cta.textContent = 'Claim 3 hours';
                        cta.onclick = function(){
                            // grant one-time extension
                            const extExpiry = now() + EXTRA_MS;
                            setExtExpiry(extExpiry);
                            // refresh UI immediately
                            updateForTiming();
                        };
                        banner.classList.remove('hidden');
                        return;
                    }

                    if (state === 'extended') {
                        countdown.textContent = formatRemaining(remainingMs);
                        text.innerHTML = 'Extra time: register within <span id="pricingCountdown">' + countdown.textContent + '</span> to claim the 3 months free Ultima subscription';
                        cta.textContent = 'Register Now';
                        cta.onclick = function(){ showPage('register'); };
                        banner.classList.remove('hidden');
                        return;
                    }

                    banner.classList.add('hidden');
                }

                function updateForTiming(){
                    // Don't show promotion banner if user is logged in
                    let isLoggedIn = false;
                    try { 
                        if (window.isSessionActive && typeof window.isSessionActive === 'function') 
                            isLoggedIn = !!window.isSessionActive(); 
                        else 
                            isLoggedIn = !!localStorage.getItem('currentUser') || !!window.currentUser; 
                    } catch(e) { isLoggedIn = false; }
                    
                    if (isLoggedIn) {
                        const banner = document.getElementById('pricingGuestBanner');
                        if (banner) banner.classList.add('hidden');
                        return; // Exit early if logged in
                    }

                    const start = getStart();
                    const extExpiry = getExtExpiry();
                    const baseExpiry = (start && start>0) ? (start + DURATION_MS) : 0;
                    const effectiveExpiry = (extExpiry && extExpiry > baseExpiry) ? extExpiry : baseExpiry;
                    const remaining = effectiveExpiry ? (effectiveExpiry - now()) : 0;

                    if (!start) return; // shouldn't happen

                    if (remaining > 0) {
                        if (effectiveExpiry === baseExpiry) {
                            showBanner(remaining, 'active');
                        } else {
                            showBanner(remaining, 'extended');
                        }
                        return;
                    }

                    // remaining <= 0
                    if (!extExpiry || extExpiry <= baseExpiry) {
                        // no extension used yet
                        showBanner(0, 'expired');
                    } else {
                        // extension existed but is now expired
                        showBanner(0, 'hidden');
                    }
                }

                function init(){
                    // 🏠 WEBSITE POLICY: ALWAYS START FROM HOME PAGE
                    // This function ensures that regardless of how users access the website,
                    // they will always see the home page first (logged in or not)
                    
                    const start = getStart();
                    // prefer the robust session detector (checks window.currentUser, localStorage and common cookies)
                    let isLoggedIn = false;
                    try { if (window.isSessionActive && typeof window.isSessionActive === 'function') isLoggedIn = !!window.isSessionActive(); else isLoggedIn = !!localStorage.getItem('currentUser'); } catch(e) { isLoggedIn = false; }
                    
                    if (isLoggedIn) { 
                        // User is already logged in - restore their session and show home page
                        const b = document.getElementById('pricingGuestBanner'); 
                        if (b) b.classList.add('hidden'); 
                        
                        // Try to auto-login the user
                        const storedUser = localStorage.getItem('currentUser');
                        if (storedUser) {
                            try {
                                window.currentUser = JSON.parse(storedUser);
                                isLoggedIn = true;
                            console.log('User auto-logged in:', window.currentUser.email);
                            } catch (e) {
                            // Session was invalid, clear it
                            localStorage.removeItem('currentUser');
                                isLoggedIn = false;
                            }
                        } else {
                            isLoggedIn = false;
                        }
                    }
                    
                    // CRITICAL: Website ALWAYS starts from home page regardless of login status
                    // This ensures consistent user experience for all visitors
                    showPage('home');
                    
                    let s = start;
                    if (!s || s <= 0) { s = now(); setStart(s); }
                    // start the ticking loop regardless of login state so guests will always have the timer available
                    updateForTiming();
                    // Ensure visibility flag exists before first use
                    if (typeof window.isPageVisible === 'undefined') {
                        window.isPageVisible = !document.hidden;
                        document.addEventListener('visibilitychange', function(){
                            window.isPageVisible = !document.hidden;
                        });
                    }
                    // Optimized timer - only update every 2 seconds instead of every second
                    const interval = setInterval(() => {
                        if (window.isPageVisible) {
                            updateForTiming();
                        }
                    }, 2000);

                    // Ensure plan buttons redirect guests to register as well
                    ['chooseBasic','chooseAdvanced','chooseUltima'].forEach(function(id){
                        const el = document.getElementById(id);
                        if (!el) return;
                        el.addEventListener('click', function(e){
                            // use session detector in case currentUser isn't populated yet
                            const logged = (window.isSessionActive && window.isSessionActive()) || !!window.currentUser;
                            if (!logged) {
                                e.preventDefault();
                                showPage('register');
                            }
                        });
                    });
                }

                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();
            })();
            </script>
            <script>
            (function attachShowPassword(){
                const EYE_SVG = '👁️';
                const EYE_SLASH_SVG = '👁️‍🗨️';
                
                function attachPasswordToggle(btnId, passId, iconId) {
                    const btn = document.getElementById(btnId);
                    const pass = document.getElementById(passId);
                    const icon = document.getElementById(iconId);
                    if (!btn || !pass || !icon) {
                        console.warn('Password toggle elements not found:', {btnId, passId, iconId});
                        return;
                    }
                    
                    // Force set initial icon and clear any existing content
                    icon.innerHTML = '';
                    icon.innerHTML = EYE_SVG;
                    
                    // Debug log
                    console.log('Password toggle attached:', btnId, 'Icon content:', icon.innerHTML);
                    
                    btn.addEventListener('click', function(){
                        const isShown = btn.getAttribute('aria-pressed') === 'true';
                        if (isShown) {
                            pass.type = 'password';
                            btn.setAttribute('aria-pressed','false');
                            icon.innerHTML = EYE_SVG;
                            btn.title = 'Show password';
                            btn.setAttribute('aria-label','Show password');
                        } else {
                            pass.type = 'text';
                            btn.setAttribute('aria-pressed','true');
                            icon.innerHTML = EYE_SLASH_SVG;
                            btn.title = 'Hide password';
                            btn.setAttribute('aria-label','Hide password');
                        }
                        console.log('Password toggled:', isShown ? 'hidden' : 'shown', 'Icon:', icon.innerHTML);
                    }, false);
                }
                
                function attach(){
                    // Attach password toggles to all password fields
                    attachPasswordToggle('toggleShowPassword', 'loginPassword', 'toggleShowPasswordIcon');
                    attachPasswordToggle('toggleRegisterPassword', 'registerPassword', 'toggleRegisterPasswordIcon');
                    attachPasswordToggle('toggleRegisterConfirmPassword', 'registerConfirmPassword', 'toggleRegisterConfirmPasswordIcon');
                }
                
                if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach); else attach();
            })();
        </script>
        
        <script>
        // Billing toggle functionality for pricing plans
        (function billingToggle() {
            // Initialize billing toggle with Monthly selected (like Image 1)
            let isYearly = false; // Start with Monthly selected
            
            function initBillingToggle() {
                console.log('Initializing billing toggle...');
                const toggleContainer = document.getElementById('billingToggleContainer');
                const toggleKnob = document.getElementById('billingToggleKnob');
                const monthlyLabel = document.getElementById('monthlyLabel');
                const yearlyLabel = document.getElementById('yearlyLabel');
                
                console.log('Elements found:', { toggleContainer, toggleKnob, monthlyLabel, yearlyLabel });
                
                if (toggleContainer && toggleKnob && monthlyLabel && yearlyLabel) {
                    // Set initial state to Monthly (like in the image)
                    updateToggleState();
                    updatePricing();
                    
                    // Add click handler
                    toggleContainer.addEventListener('click', function() {
                        console.log('Toggle clicked! Current isYearly:', isYearly);
                        isYearly = !isYearly;
                        console.log('New isYearly:', isYearly);
                        updateToggleState();
                        updatePricing();
                    });
                    
                    console.log('Billing toggle initialized successfully!');
                } else {
                    console.error('Some toggle elements not found!');
                }
            }
            
            function updateToggleState() {
                const toggleKnob = document.getElementById('billingToggleKnob');
                const monthlyLabel = document.getElementById('monthlyLabel');
                const yearlyLabel = document.getElementById('yearlyLabel');
                
                if (toggleKnob && monthlyLabel && yearlyLabel) {
                    if (isYearly) {
                        // Yearly selected: knob on right, Yearly white text, Monthly gray text
                        toggleKnob.style.transform = 'translateX(7rem)'; // Move to right side (from inspect tools)
                        monthlyLabel.style.color = '#6b7280'; // Gray text for Monthly
                        yearlyLabel.style.color = '#ffffff'; // White text for Yearly
                        yearlyLabel.style.width = '6rem';
                        console.log('Updated to Yearly state');
                    } else {
                        // Monthly selected: knob on left, Monthly white text, Yearly gray text
                        toggleKnob.style.transform = 'translateX(1.3rem)'; // Move to left side
                        monthlyLabel.style.color = '#6b7280'; // White text for Monthly
                        yearlyLabel.style.color = '#ffffff'; // Gray text for Yearly
                        yearlyLabel.style.width = '6rem';
                        console.log('Updated to Monthly state');
                    }
                }
            }
            
            function updatePricing() {
                const pricingData = {
                    basic: { monthly: 0, yearly: 0 },
                    advanced: { monthly: 19, yearly: 199 },
                    ultima: { monthly: 79, yearly: 799 }
                };
                
                const planPrices = document.querySelectorAll('.plan-price');
                console.log('Found plan prices:', planPrices.length);
                
                planPrices.forEach(priceElement => {
                    const plan = priceElement.getAttribute('data-plan');
                    const planData = pricingData[plan];
                    
                    if (planData) {
                        if (isYearly) {
                            priceElement.innerHTML = `$${planData.yearly}<span class="text-sm font-medium">/year</span>`;
                        } else {
                            priceElement.innerHTML = `$${planData.monthly}<span class="text-sm font-medium">/mo</span>`;
                        }
                        console.log(`Updated ${plan} price to ${isYearly ? 'yearly' : 'monthly'}`);
                    }
                });
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    initBillingToggle();
                    updateNavigation(); // Update navigation on page load
                    
                    // Initialize profile form
                    const profileForm = document.getElementById('profileForm');
                    if (profileForm) {
                        profileForm.addEventListener('submit', handleProfileUpdate);
                    }
                });
            } else {
                initBillingToggle();
                updateNavigation(); // Update navigation on page load
                
                // Initialize profile form
                const profileForm = document.getElementById('profileForm');
                if (profileForm) {
                    profileForm.addEventListener('submit', handleProfileUpdate);
                }
            }
        })();
        </script>
    <style>
        /* Inline load details: taller and scrollable so more info fits (mini-details panel) */
        .load-details {
            max-height: 340px;
            overflow-y: auto;
            padding: 12px;
            font-size: 0.95rem;
            line-height: 1.35;
        }
        .real-time-indicator {
            display: inline-flex;
            align-items: center;
            background: #10b981;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .real-time-indicator::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #00ff41;
            border-radius: 50%;
            margin-right: 4px;
            animation: live-blink 2s ease-in-out infinite;
        }
        .smart-search-suggestion {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s;
        }
        .smart-search-suggestion:hover {
            background-color: #f3f4f6;
        }
    /* Prevent body scroll when modal/overlay active */
    .no-scroll { overflow: hidden !important; }
        .nav-item {
            position: relative;
            border-radius: 6px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-1px);
        }
        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.25);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .sidebar {
            position: fixed;
            left: -300px;
            top: 0;
            width: 300px;
            height: 100vh;
            background: #1e3a8a;
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .sidebar.open {
            left: 0;
        }
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        @media (max-width: 768px) {
            .desktop-nav {
                display: none;
            }
        }
        .rate-trend-up {
            color: #10b981;
        }
        .rate-trend-down {
            color: #ef4444;
        }
        .equipment-icon {
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .equipment-van { background: #3b82f6; }
        .equipment-flatbed { background: #10b981; }
        .equipment-reefer { background: #06b6d4; }
        .equipment-stepdeck { background: #8b5cf6; }
        .equipment-lowboy { background: #f59e0b; }
        /* Billing toggle animation */
        .billing-toggle button{transition:transform .22s cubic-bezier(.2,.9,.2,1),box-shadow .22s ease,background-color .22s ease,color .22s ease}
        .billing-toggle button.billing-active{transform:translateY(0);box-shadow:0 6px 18px rgba(59,130,246,.12)}
        .equipment-tanker { background: #ef4444; }
        /* Make small/secondary text in the home hero match the top nav (white) */
        .hero-top p,
        .hero-top .text-sm,
        .hero-top .text-neutral-100 {
            color: #ffffff !important;
        }
        /* Registration background: single-file embedded SVG highway + truck wallpaper (no external files) */
        .register-hero {
            /* linear tint on top of the embedded SVG data URI */
                background-size: contain;
                /* Make the embedded SVG scale to fit and keep the register panel visible
                    Use 'contain' so the illustration scales down instead of cropping,
                    position it toward the top/center, and avoid fixed attachment which
                    can make the image appear oversized on some viewports. */
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center top;
                min-height: 680px;
                padding-top: 48px;
                background-attachment: scroll;
                background-blend-mode: overlay;
        }
    .register-panel {
            background-color: rgba(255,255,255,0.95);
            -webkit-backdrop-filter: blur(4px);
            backdrop-filter: blur(4px);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 10px 24px rgba(2,6,23,0.2);
            max-width: 720px;
        }
    /* Pricing cards */
    .pricing-card { border-radius: 12px; box-shadow: 0 12px 30px rgba(2,6,23,0.12); }
    .pricing-badge { background: linear-gradient(90deg,#f59e0b,#ffb86b); color: #1f2937; padding: 4px 8px; border-radius: 9999px; font-weight: 700; font-size: 0.75rem; }
        @media (max-width: 900px) {
            .register-hero { background-position: center top; background-attachment: scroll; }
            .register-panel { margin: 0 16px; width: calc(100% - 32px); }
        }
    </style>
    <!-- Fallback override to ensure .register-hero CSS is valid and page parsing doesn't fail.
         The embedded image (data URI) may be very large; this lighter rule provides a safe gradient
         until the image is intentionally re-embedded. -->
    <style>
        /* Lightweight override to replace very large embedded wallpaper with a small SVG+gradient.
           This keeps the page decorative while avoiding editor/liner issues caused by huge data URIs. */
        .register-hero {
            background-image: linear-gradient(180deg, rgba(10,47,97,0.62), rgba(16,185,129,0.20)),
                url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='1600' height='900'><rect width='100%25' height='100%25' fill='%2314253b'/><g stroke='%2316b58f' stroke-opacity='0.06' stroke-width='6'><path d='M0 650 L1600 250'/></g></svg>") !important;
            background-size: cover !important;
            background-position: center !important;
            background-attachment: scroll !important;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Subscription overlay (glass black) -->
    <div id="subscriptionOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-full w-full mx-4 p-6 text-center">
            <h3 id="subscriptionOverlayTitle" class="text-xl font-bold mb-2">you are already using our Ultima subscription</h3>
            <p id="subscriptionOverlaySubtitle" class="text-gray-700 mb-6">3 months to expire free Ultima subscribtion</p>
            <div class="flex justify-center">
                <button id="subscriptionOverlayClose" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Browser-style Navigation System - COMPLETELY REWRITTEN
        if (typeof window.navigationHistory === 'undefined') {
            window.navigationHistory = [];
        }
        if (typeof window.currentHistoryIndex === 'undefined') {
            window.currentHistoryIndex = -1;
        }
        navigationHistory = window.navigationHistory;
        currentHistoryIndex = window.currentHistoryIndex;
        
        // Initialize navigation history
        function initNavigation() {
            if (navigationHistory.length === 0) {
                navigationHistory = ['home'];
                currentHistoryIndex = 0;
            }
            
            // Wait for DOM to be ready and then override showPage
            setTimeout(() => {
                overrideShowPage();
                updateNavigationArrowButtons();
            }, 1000);
        }
        
        // Navigate to a page and add to history (not used anymore, kept for reference)
        function navigateToPage(pageName) {
            // Remove any forward history when navigating to a new page
            if (currentHistoryIndex < navigationHistory.length - 1) {
                navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
            }
            
            // Add new page to history
            navigationHistory.push(pageName);
            currentHistoryIndex = navigationHistory.length - 1;
            
            // Show the page
            showPage(pageName);
            
            // Update navigation buttons
            updateNavigationArrowButtons();
            
            // Update current page indicator
            updateCurrentPageIndicator(pageName);
        }
        
        // Go back to previous page
        function navigateBack() {
            if (currentHistoryIndex > 0) {
                // Add click feedback
                const backBtn = document.getElementById('navBackBtn');
                const mobileBackBtn = document.getElementById('mobileNavBackBtn');
                
                if (backBtn) {
                    backBtn.classList.add('clicked');
                    setTimeout(() => backBtn.classList.remove('clicked'), 300);
                }
                if (mobileBackBtn) {
                    mobileBackBtn.classList.add('clicked');
                    setTimeout(() => mobileBackBtn.classList.remove('clicked'), 300);
                }
                
                currentHistoryIndex--;
                const pageName = navigationHistory[currentHistoryIndex];
                
                // Call the original showPage function directly
                if (window.showPage && typeof window.showPage === 'function') {
                    // Temporarily disable our override to avoid infinite loop
                    const tempShowPage = window.showPage;
                    window.showPage = window._originalShowPage || tempShowPage;
                    
                    // Show the page
                    window.showPage(pageName);
                    
                    // Re-enable our override
                    window.showPage = tempShowPage;
                }
                
                updateNavigationArrowButtons();
                updateCurrentPageIndicator(pageName);
            }
        }
        
        // Go forward to next page
        function navigateForward() {
            console.log('🔜 Navigate Forward called. Current index:', currentHistoryIndex, 'History:', navigationHistory);
            if (currentHistoryIndex < navigationHistory.length - 1) {
                // Add click feedback
                const forwardBtn = document.getElementById('navForwardBtn');
                const mobileForwardBtn = document.getElementById('mobileNavForwardBtn');
                
                if (forwardBtn) {
                    forwardBtn.classList.add('clicked');
                    setTimeout(() => forwardBtn.classList.remove('clicked'), 300);
                }
                if (mobileForwardBtn) {
                    mobileForwardBtn.classList.add('clicked');
                    setTimeout(() => mobileForwardBtn.classList.remove('clicked'), 300);
                }
                
                currentHistoryIndex++;
                const pageName = navigationHistory[currentHistoryIndex];
                console.log('🔄 Going forward to:', pageName);
                
                // Call the original showPage function directly
                if (window.showPage && typeof window.showPage === 'function') {
                    // Temporarily disable our override to avoid infinite loop
                    const tempShowPage = window.showPage;
                    window.showPage = window._originalShowPage || tempShowPage;
                    
                    // Show the page
                    window.showPage(pageName);
                    
                    // Re-enable our override
                    window.showPage = tempShowPage;
                }
                
                updateNavigationArrowButtons();
                updateCurrentPageIndicator(pageName);
            }
        }
        
        // Make functions globally accessible
        window.navigateBack = navigateBack;
        window.navigateForward = navigateForward;
        
        
        

        

        
        // Update navigation arrow button states
        function updateNavigationArrowButtons() {
            const backBtn = document.getElementById('navBackBtn');
            const forwardBtn = document.getElementById('navForwardBtn');
            const mobileBackBtn = document.getElementById('mobileNavBackBtn');
            const mobileForwardBtn = document.getElementById('mobileNavForwardBtn');
            
            // Update desktop buttons
            if (backBtn) {
                if (currentHistoryIndex > 0) {
                    backBtn.classList.remove('disabled');
                } else {
                    backBtn.classList.add('disabled');
                }
            }
            
            // Update mobile buttons
            if (mobileBackBtn) {
                if (currentHistoryIndex > 0) {
                    mobileBackBtn.classList.remove('disabled');
                } else {
                    mobileBackBtn.classList.add('disabled');
                }
            }
            
            // Update desktop buttons
            if (forwardBtn) {
                if (currentHistoryIndex < navigationHistory.length - 1) {
                    forwardBtn.classList.remove('disabled');
                } else {
                    forwardBtn.classList.add('disabled');
                }
            }
            
            // Update mobile buttons
            if (mobileForwardBtn) {
                if (currentHistoryIndex < navigationHistory.length - 1) {
                    mobileForwardBtn.classList.remove('disabled');
                } else {
                    mobileForwardBtn.classList.add('disabled');
                }
            }
        }
        
        // Update current page indicator
        function updateCurrentPageIndicator(pageName) {
            const indicator = document.getElementById('currentPageIndicator');
            const mobileIndicator = document.getElementById('mobileCurrentPageIndicator');
            
            const pageNames = {
                'home': 'Home',
                'loadboard': 'Load Board',
                'rates': 'Rate Analysis',
                'pricing': 'Pricing',
                'login': 'Login',
                'register': 'Register',
                'profile': 'Profile',
                'admin': 'Admin'
            };
            
            const displayName = pageNames[pageName] || pageName;
            
            if (indicator) {
                indicator.textContent = displayName;
            }
            
            if (mobileIndicator) {
                mobileIndicator.textContent = displayName;
            }
        }
        
        // We'll override showPage after it's defined
        // originalShowPage is already declared at the top
        
        // Function to override showPage (called after original is defined)
        function overrideShowPage() {
            if (window.showPage && typeof window.showPage === 'function') {
                // Store the original function
                window._originalShowPage = window.showPage;
                
                // Create our new showPage function
                window.showPage = function(pageName) {
                    // Call the original function first
                    if (window._originalShowPage) {
                        window._originalShowPage(pageName);
                    }
                    
                    // Add to navigation history if it's a new navigation
                    if (navigationHistory.length === 0 || navigationHistory[currentHistoryIndex] !== pageName) {
                        // Remove any forward history when navigating to a new page
                        if (currentHistoryIndex < navigationHistory.length - 1) {
                            navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
                        }
                        navigationHistory.push(pageName);
                        currentHistoryIndex = navigationHistory.length - 1;
                        
                        updateNavigationArrowButtons();
                        updateCurrentPageIndicator(pageName);
                    }
                };
                
                // Also override any direct onclick calls to showPage
                setTimeout(() => {
                    const navLinks = document.querySelectorAll('a[onclick*="showPage"], button[onclick*="showPage"]');
                    
                    navLinks.forEach(link => {
                        const onclick = link.getAttribute('onclick');
                        if (onclick && onclick.includes('showPage')) {
                            // Link is already tracked
                        }
                    });
                }, 2000);
                
            } else {
                // Retry after a short delay
                setTimeout(overrideShowPage, 500);
            }
        }
        
        // Helpful session detection used by multiple pieces of UI.
        // Returns true if there's strong evidence the visitor is logged in.
        window.isSessionActive = function(){
            try {
                if (window.currentUser) return true;
                try { if (localStorage.getItem('currentUser')) return true; } catch(e){}
                const ab = document.getElementById('authButtons');
                if (ab) {
                    const text = (ab.textContent||'').toLowerCase();
                    if (text.includes('logout')) return true;
                    if (ab.querySelector && ab.querySelector('button[onclick*=\"logout\"]')) return true;
                }
                const cookie = document.cookie || '';
                if (cookie && cookie.length) {
                    const likely = ['session','PHPSESSID','sid','auth','token'];
                    for (let n of likely) if (cookie.indexOf(n+'=') !== -1) return true;
                }
            } catch(e){}
            return false;
        };
        // safeFetch: wrapper around fetch that never throws and returns null on network failures.
        // Use this when calling local server-side PHP endpoints on static hosts (file:// / Netlify) so the UI can
        // gracefully fallback to localStorage/mock data instead of crashing with CORS or network errors.
        window.safeFetch = async function(url, opts) {
            try {
                // If running from file: protocol we can't reach server-side PHP; short-circuit
                if (location.protocol === 'file:') {
                    // Running from file:// — not a server environment. Use debug level to reduce console noise.
                    if (console && console.debug) console.debug('safeFetch: running from file://, skipping network request to', url);
                    return null;
                }
                const resp = await fetch(url, opts);
                return resp;
            } catch (e) {
                // Network failures are expected on static file hosting — debug-level log only.
                if (console && console.debug) console.debug('safeFetch failed for', url, e);
                return null;
            }
        };
    </script>


    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <!-- Mobile Sidebar -->
    <div id="sidebar" class="sidebar">
        <div class="p-6">
            <div class="flex items-center justify-between mb-8">
                <h2 class="text-xl font-bold text-white logo-clickable" onclick="showPage('home'); toggleSidebar()">FreightPro</h2>
                <button onclick="toggleSidebar()" class="text-white hover:text-gray-300">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <nav class="space-y-2">
                <!-- Mobile Navigation Arrows -->
                <div class="flex justify-center space-x-3 mb-6">
                    <button onclick="navigateBack(); toggleSidebar()" class="nav-arrow-btn-mobile disabled" id="mobileNavBackBtn" title="Go back">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button onclick="navigateForward(); toggleSidebar()" class="nav-arrow-btn-mobile disabled" id="mobileNavForwardBtn" title="Go forward">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="text-center mb-4">
                    <div class="text-xs text-gray-300 opacity-70 mb-1">Current Page</div>
                    <div id="mobileCurrentPageIndicator" class="text-sm font-medium text-white">Home</div>
                </div>
                
                <button onclick="showPage('home'); toggleSidebar()" class="nav-item w-full text-left text-white px-4 py-3">
                    <i class="fas fa-home mr-3"></i>Home
                </button>
                <button onclick="showPage('loadboard'); toggleSidebar(); initializeLoadBoard();" class="nav-item w-full text-left text-white px-4 py-3">
                    <i class="fas fa-truck mr-3"></i>Load Board
                </button>
                <button id="mobilePostLoadBtn" onclick="showPostLoadPage(); toggleSidebar();" class="nav-item w-full text-left text-white px-4 py-3 hidden">
                    <i class="fas fa-plus-circle mr-3"></i>Post Load
                </button>
                
                <button onclick="showPage('rates'); toggleSidebar()" class="nav-item w-full text-left text-white px-4 py-3">
                    <i class="fas fa-chart-line mr-3"></i>Rate Analysis
                </button>
                <button onclick="showPage('pricing'); toggleSidebar()" class="nav-item w-full text-left text-white px-4 py-3">
                    <i class="fas fa-tags mr-3"></i>Pricing
                </button>
                <button onclick="showPage('profile'); toggleSidebar()" class="nav-item w-full text-left text-white px-4 py-3">
                    <i class="fas fa-user mr-3"></i>Profile
                </button>
            </nav>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-gradient-to-r from-blue-900 via-blue-800 to-blue-900 text-white shadow-xl sticky top-0 z-50 border-b border-blue-700">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-3">
                <!-- Left Side: Logo, Navigation Arrows, and Menu -->
                <div class="flex items-center space-x-4">
                    <button onclick="toggleSidebar()" class="md:hidden text-white hover:text-gray-300">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    <div class="flex items-center space-x-2 logo-clickable" onclick="showPage('home')">
                        <i class="fas fa-truck text-xl"></i>
                        <h1 class="text-xl font-bold">FreightPro</h1>
                        <span class="real-time-indicator">LIVE</span>
                    </div>
                    
                    <!-- Browser-style Navigation Arrows -->
                    <div class="flex items-center space-x-3 mx-6">
                        <button id="navBackBtn" class="nav-arrow-btn disabled" title="Go back to previous page">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button id="navForwardBtn" class="nav-arrow-btn disabled" title="Go forward to next page">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Desktop Navigation Menu -->
                    <div class="desktop-nav hidden lg:flex space-x-1">
                        <button onclick="showPage('home')" class="nav-item text-white text-sm px-3 py-2">
                            <i class="fas fa-home mr-1"></i>Home
                        </button>
                        <button onclick="showPage('loadboard'); initializeLoadBoard();" class="nav-item text-white text-sm px-3 py-2">
                            <i class="fas fa-truck mr-1"></i>Load Board
                        </button>
                        <button id="desktopPostLoadBtn" onclick="showPostLoadPage();" class="nav-item text-white text-sm px-3 py-2 hidden">
                            <i class="fas fa-plus mr-1"></i>Post Load
                        </button>
                        <button onclick="showPage('rates')" class="nav-item text-white text-sm px-3 py-2">
                            <i class="fas fa-chart-line mr-1"></i>Rates
                        </button>
                        <button onclick="showPage('pricing')" class="nav-item text-white text-sm px-3 py-2">
                            <i class="fas fa-tags mr-1"></i>Pricing
                        </button>
                    </div>
                </div>
                
                <!-- Right Side: Auth Buttons and User Info -->
                <div class="flex items-center space-x-3">
                    <!-- Auth Buttons (shown when not logged in) -->
                    <div id="authButtons" class="flex items-center space-x-2">
                        <button onclick="showPage('login')" class="bg-blue-700 hover:bg-blue-600 px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-sign-in-alt mr-1"></i>Login
                        </button>
                        <button onclick="showPage('register')" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-user-plus mr-1"></i>Register
                        </button>
                    </div>
                    
                    <!-- User Info (shown when logged in) -->
                    <div id="userInfo" class="flex items-center space-x-3 hidden">
                        <!-- User info will be populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </nav>
    <!-- Home Page -->
    <div id="home" class="page">
        <!-- Hero Section with 4K American truck background -->
        <div class="relative overflow-hidden" style="background: linear-gradient(rgba(26,34,56,0.7),rgba(236, 238, 241, 0.7)), url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat; min-height: 420px;">
            <div class="max-w-7xl mx-auto px-4 text-center relative z-10 py-20 md:py-28">
                <h1 class="text-5xl md:text-6xl font-extrabold mb-6 text-white drop-shadow-lg">American's Freight Network</h1>
                <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto text-white drop-shadow">Connect carriers and shippers with the most comprehensive real-time load board and transportation solutions powered by FreightPro</p>
                <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <button onclick="showPage('register')" class="bg-accent hover:bg-white/20 hover:backdrop-blur-sm hover:border hover:border-white/30 px-8 py-4 rounded-lg text-lg font-semibold transition-all duration-300 text-white shadow-lg">
                        <i class="fas fa-rocket mr-2"></i>Get Started Free
                    </button>
                    <button onclick="showPage('loadboard'); initializeLoadBoard();" class="bg-transparent border-2 border-white hover:bg-white hover:text-primary px-8 py-4 rounded-lg text-lg font-semibold transition-colors text-white shadow-lg">
                        <i class="fas fa-search mr-2"></i>Browse Loads
                    </button>
                </div>
            </div>
            <div class="absolute inset-0 bg-gradient-to-b from-transparent to-primary opacity-80 pointer-events-none"></div>
        </div>

        <!-- Real-time Stats -->
        <div class="py-16 bg-white">
            <div class="max-w-7xl mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold mb-4">Live Platform Statistics</h2>
                    <div class="real-time-indicator mx-auto">Updated every 5 seconds</div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-lg">
                        <div id="liveCarriers" class="text-3xl font-bold text-blue-600 mb-2">1,247,892</div>
                        <div class="text-gray-600">Active Carriers</div>
                        <div class="text-sm text-green-600 mt-1">↗ +127 today</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-lg">
                        <div id="liveShippers" class="text-3xl font-bold text-green-600 mb-2">85,432</div>
                        <div class="text-gray-600">Active Shippers</div>
                        <div class="text-sm text-green-600 mt-1">↗ +23 today</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-lg">
                        <div id="liveFreightValue" class="text-3xl font-bold text-purple-600 mb-2">$180.2B</div>
                        <div class="text-gray-600">Annual Freight Value</div>
                        <div class="text-sm text-green-600 mt-1">↗ +$2.1M today</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-lg">
                        <div id="liveLoads" class="text-3xl font-bold text-orange-600 mb-2">2,847</div>
                        <div class="text-gray-600">Available Loads</div>
                        <div class="text-sm text-green-600 mt-1">↗ +156 today</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="py-16 bg-gray-50 relative">
            <!-- Background truck illustration -->
            <div class="absolute right-0 top-1/2 transform -translate-y-1/2 opacity-5">
                <svg width="400" height="300" viewBox="0 0 400 300">
                    <!-- Large semi-truck illustration -->
                    <g transform="translate(50,100)">
                        <!-- Trailer -->
                        <rect x="0" y="40" width="200" height="80" rx="8" fill="#3b82f6" stroke="#1e40af" stroke-width="2"/>
                        <rect x="10" y="50" width="180" height="60" rx="4" fill="#60a5fa" opacity="0.3"/>
                        
                        <!-- Cab -->
                        <rect x="205" y="30" width="80" height="90" rx="10" fill="#1e40af" stroke="#1e3a8a" stroke-width="2"/>
                        <rect x="215" y="40" width="60" height="40" rx="5" fill="#93c5fd" opacity="0.4"/>
                        
                        <!-- Wheels -->
                        <circle cx="40" cy="130" r="15" fill="#374151" stroke="#111827" stroke-width="2"/>
                        <circle cx="40" cy="130" r="8" fill="#6b7280"/>
                        <circle cx="80" cy="130" r="15" fill="#374151" stroke="#111827" stroke-width="2"/>
                        <circle cx="80" cy="130" r="8" fill="#6b7280"/>
                        <circle cx="160" cy="130" r="15" fill="#374151" stroke="#111827" stroke-width="2"/>
                        <circle cx="160" cy="130" r="8" fill="#6b7280"/>
                        <circle cx="245" cy="130" r="15" fill="#374151" stroke="#111827" stroke-width="2"/>
                        <circle cx="245" cy="130" r="8" fill="#6b7280"/>
                        <circle cx="270" cy="130" r="15" fill="#374151" stroke="#111827" stroke-width="2"/>
                        <circle cx="270" cy="130" r="8" fill="#6b7280"/>
                        
                        <!-- Details -->
                        <rect x="220" y="45" width="15" height="8" rx="2" fill="#fbbf24"/>
                        <rect x="240" y="45" width="15" height="8" rx="2" fill="#fbbf24"/>
                        <rect x="260" y="70" width="20" height="3" rx="1" fill="#ef4444"/>
                    </g>
                </svg>
            </div>
            
            <div class="max-w-7xl mx-auto px-4 relative z-10">
                <h2 class="text-3xl font-bold text-center mb-12">Platform Features</h2>
                <div class="grid md:grid-cols-3 gap-8">
                    <div class="bg-white text-center p-8 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                        <!-- Smart Load Board SVG Icon -->
                        <div class="mb-6 flex justify-center">
                            <svg width="80" height="80" viewBox="0 0 80 80">
                                <rect x="10" y="20" width="60" height="40" rx="4" fill="#3b82f6" opacity="0.1"/>
                                <rect x="15" y="25" width="50" height="30" rx="2" fill="#3b82f6" opacity="0.2"/>
                                <circle cx="25" cy="35" r="3" fill="#3b82f6"/>
                                <circle cx="35" cy="35" r="3" fill="#10b981"/>
                                <circle cx="45" cy="35" r="3" fill="#f59e0b"/>
                                <circle cx="55" cy="35" r="3" fill="#ef4444"/>
                                <path d="M20 45 L60 45" stroke="#3b82f6" stroke-width="2"/>
                                <path d="M20 50 L50 50" stroke="#6b7280" stroke-width="1"/>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Smart Load Board</h3>
                        <p class="text-gray-600 mb-4">AI-powered load matching with real-time updates and Google Maps integration</p>
                        <ul class="text-sm text-gray-500 space-y-1">
                            <li>• Real-time load updates</li>
                            <li>• Smart search suggestions</li>
                            <li>• Interactive route mapping</li>
                        </ul>
                    </div>
                    <div class="bg-white text-center p-8 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                        <!-- Rate Analysis SVG Icon -->
                        <div class="mb-6 flex justify-center">
                            <svg width="80" height="80" viewBox="0 0 80 80">
                                <rect x="10" y="10" width="60" height="50" rx="4" fill="#10b981" opacity="0.1"/>
                                <path d="M15 50 L25 40 L35 45 L45 30 L55 35 L65 25" stroke="#10b981" stroke-width="3" fill="none"/>
                                <circle cx="25" cy="40" r="2" fill="#10b981"/>
                                <circle cx="35" cy="45" r="2" fill="#10b981"/>
                                <circle cx="45" cy="30" r="2" fill="#10b981"/>
                                <circle cx="55" cy="35" r="2" fill="#10b981"/>
                                <text x="40" y="70" text-anchor="middle" fill="#10b981" font-size="12" font-weight="bold">$$$</text>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Live Rate Analysis</h3>
                        <p class="text-gray-600 mb-4">Real-time market rates and pricing intelligence with trend analysis</p>
                        <ul class="text-sm text-gray-500 space-y-1">
                            <li>• Live rate updates</li>
                            <li>• Market trend analysis</li>
                            <li>• Competitive pricing insights</li>
                        </ul>
                    </div>
                    <div class="bg-white text-center p-8 rounded-lg shadow-lg hover:shadow-xl transition-shadow">
                        <!-- Route Insights SVG Icon (non-tracking) -->
                        <div class="mb-6 flex justify-center">
                            <svg width="80" height="80" viewBox="0 0 80 80">
                                <rect x="10" y="20" width="60" height="40" rx="4" fill="#1e40af" opacity="0.08"/>
                                <path d="M18 50 L30 36 L42 44 L54 30" stroke="#1e40af" stroke-width="2" fill="none"/>
                                <circle cx="30" cy="36" r="3" fill="#1e40af"/>
                                <circle cx="42" cy="44" r="3" fill="#10b981"/>
                                <circle cx="54" cy="30" r="3" fill="#f59e0b"/>
                                <text x="40" y="68" text-anchor="middle" fill="#1e40af" font-size="11">Route Insights</text>
                            </svg>
                        </div>
                        <h3 class="text-xl font-semibold mb-4">Route Insights</h3>
                        <p class="text-gray-600 mb-4">Optimized routing, ETA predictions, and automated notifications — no live-map dependency</p>
                        <ul class="text-sm text-gray-500 space-y-1">
                            <li>• ETA predictions & alerts</li>
                            <li>• Automated notifications to partners</li>
                            <li>• Route optimization suggestions</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Dashboard Section (shown only when logged in) -->
        <div id="userDashboardSection" class="py-16 bg-gradient-to-br from-blue-50 to-indigo-100 hidden">
            <div class="max-w-7xl mx-auto px-4">
                <div class="text-center mb-12">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Welcome to Your Dashboard</h2>
                    <p class="text-lg text-gray-600">Manage your freight operations and view your account information</p>
                </div>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Quick Profile Card -->
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <div class="flex items-center mb-4">
                            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl" id="dashboardUserInitials">U</div>
                            <div class="ml-4">
                                <h3 class="text-lg font-semibold text-gray-800" id="dashboardUserName">User Name</h3>
                                <p class="text-sm text-gray-600" id="dashboardUserCompany">Company Name</p>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Account Type:</span>
                                <span class="font-semibold text-blue-600" id="dashboardAccountType">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">USDOT:</span>
                                <span class="font-semibold" id="dashboardUSDOT">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">MC Number:</span>
                                <span class="font-semibold" id="dashboardMC">-</span>
                            </div>
                        </div>
                        <button onclick="showPage('profile')" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                            <i class="fas fa-user mr-2"></i>View Full Profile
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-bolt mr-2 text-yellow-500"></i>Quick Actions
                        </h3>
                        <div class="space-y-3">
                            <button onclick="showPage('loadboard'); initializeLoadBoard();" class="w-full text-left bg-gray-50 hover:bg-gray-100 p-3 rounded-lg transition-colors">
                                <i class="fas fa-search mr-3 text-blue-600"></i>Browse Loads
                            </button>
                            <button onclick="showPage('postload')" class="w-full text-left bg-gray-50 hover:bg-gray-100 p-3 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-3 text-green-600"></i>Post a Load
                            </button>
                            <button onclick="showPage('rates')" class="w-full text-left bg-gray-50 hover:bg-gray-100 p-3 rounded-lg transition-colors">
                                <i class="fas fa-chart-line mr-3 text-purple-600"></i>Rate Analysis
                            </button>
                        </div>
                    </div>

                    <!-- Account Statistics -->
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-shadow">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">
                            <i class="fas fa-chart-bar mr-2 text-orange-500"></i>Your Stats
                        </h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="text-center">
                                <div class="text-2xl font-bold text-blue-600" id="dashboardLoadsPosted">0</div>
                                <div class="text-sm text-gray-600">Loads Posted</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-green-600" id="dashboardLoadsBooked">0</div>
                                <div class="text-sm text-gray-600">Loads Booked</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-purple-600" id="dashboardRevenue">$0</div>
                                <div class="text-sm text-gray-600">Revenue</div>
                            </div>
                            <div class="text-center">
                                <div class="text-2xl font-bold text-orange-600" id="dashboardRating">5.0</div>
                                <div class="text-sm text-gray-600">Rating</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posted Loads Section -->
                <div class="mt-12">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800" id="postedLoadsTitle">
                                <i class="fas fa-truck mr-2 text-blue-600"></i>Your Posted Loads
                            </h3>
                            <button onclick="showPage('postload')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Post New Load
                            </button>
                        </div>
                        
                        <div id="postedLoadsContainer">
                            <!-- Posted loads will be populated here -->
                        </div>
                        
                        <div id="noPostedLoads" class="text-center py-8 text-gray-500">
                            <i class="fas fa-truck text-4xl mb-4 text-gray-300"></i>
                            <p class="text-lg mb-2">No loads posted yet</p>
                            <p class="text-sm">Start by posting your first load to get carriers interested</p>
                            <button onclick="showPage('postload')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Post Your First Load
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

                    <!-- Account Type Selection Page -->
    <!-- Registration Page -->
    <div id="register" class="page hidden">
        <div class="min-h-screen flex items-center justify-center py-4 px-4 bg-gray-50 relative overflow-hidden">
            <!-- Premium background pattern -->
            <div class="absolute inset-0 opacity-5">
                <svg viewBox="0 0 1200 800" class="w-full h-full">
                    <!-- Elegant logistics pattern -->
                    <defs>
                        <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
                            <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#3b82f6" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#grid)"/>
                    <!-- Premium truck silhouettes -->
                    <g opacity="0.3">
                        <rect x="200" y="150" width="80" height="30" rx="3" fill="#3b82f6"/>
                        <rect x="285" y="140" width="25" height="40" rx="3" fill="#1e40af"/>
                        <circle cx="220" cy="185" r="6" fill="#374151"/>
                        <circle cx="250" cy="185" r="6" fill="#374151"/>
                        <circle cx="295" cy="185" r="6" fill="#374151"/>
                    </g>
                    <g opacity="0.2" transform="translate(600,300)">
                        <rect x="0" y="20" width="90" height="35" rx="4" fill="#3b82f6"/>
                        <rect x="95" y="10" width="30" height="45" rx="4" fill="#1e40af"/>
                        <circle cx="25" cy="60" r="7" fill="#374151"/>
                        <circle cx="55" cy="60" r="7" fill="#374151"/>
                        <circle cx="110" cy="60" r="7" fill="#374151"/>
                    </g>
                </svg>
            </div>

            <!-- Premium registration card -->
            <div class="max-w-full w-full space-y-8 relative z-10">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-10 backdrop-blur-sm">
                    <div class="text-center">
                        <!-- Premium FreightPro register icon -->
                        <div class="mb-8 flex justify-center">
                            <div class="relative">
                                <!-- Premium gradient circle with enhanced styling -->
                                <div class="w-28 h-28 rounded-full bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 flex items-center justify-center shadow-2xl border-4 border-white/20 relative overflow-hidden">
                                    <!-- Glassmorphism overlay -->
                                    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm rounded-full"></div>
                                    <!-- Professional truck icon with premium styling -->
                                    <svg width="60" height="60" viewBox="0 0 60 60" fill="none" class="relative z-10">
                                        <!-- Enhanced truck design -->
                                        <g filter="drop-shadow(0 2px 4px rgba(0,0,0,0.1))">
                                            <!-- Main truck trailer with premium styling -->
                                            <rect x="6" y="22" width="32" height="18" rx="3" fill="white" opacity="0.95" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                            <!-- Truck cab with enhanced details -->
                                            <rect x="38" y="18" width="16" height="22" rx="3" fill="white" opacity="0.95" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                            <!-- Premium windshield with reflection -->
                                            <rect x="40" y="20" width="12" height="10" rx="2" fill="#60a5fa" opacity="0.4"/>
                                            <rect x="41" y="21" width="4" height="8" rx="1" fill="white" opacity="0.6"/>
                                            <!-- Enhanced front bumper -->
                                            <rect x="54" y="22" width="3" height="14" rx="1.5" fill="white" opacity="0.9"/>
                                            <!-- Premium grille design -->
                                            <rect x="51" y="25" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="27" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="29" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="31" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <!-- Premium wheels with enhanced styling -->
                                            <circle cx="16" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="16" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="16" cy="42" r="2" fill="#374151"/>
                                            <circle cx="16" cy="42" r="0.8" fill="#9ca3af"/>
                                            <circle cx="28" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="28" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="28" cy="42" r="2" fill="#374151"/>
                                            <circle cx="28" cy="42" r="0.8" fill="#9ca3af"/>
                                            <circle cx="46" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="46" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="46" cy="42" r="2" fill="#374151"/>
                                            <circle cx="46" cy="42" r="0.8" fill="#9ca3af"/>
                                            <!-- Premium headlights -->
                                            <circle cx="54" cy="24" r="2" fill="#fbbf24" opacity="0.9" filter="drop-shadow(0 0 3px #fbbf24)"/>
                                            <circle cx="54" cy="34" r="2" fill="#f87171" opacity="0.8" filter="drop-shadow(0 0 3px #f87171)"/>
                                            <!-- FreightPro premium branding -->
                                            <rect x="10" y="26" width="20" height="6" rx="2" fill="rgba(59,130,246,0.15)" stroke="rgba(59,130,246,0.3)" stroke-width="0.5"/>
                                            <text x="20" y="30" font-family="Arial, sans-serif" font-size="4" font-weight="bold" fill="#2563eb" text-anchor="middle" opacity="0.8">FreightPro</text>
                                        </g>
                                    </svg>
                                </div>
                                <!-- Premium glow effects -->
                                <div class="absolute inset-0 rounded-full bg-blue-400 opacity-20 blur-xl animate-pulse"></div>
                                <div class="absolute inset-2 rounded-full bg-white opacity-10 blur-lg"></div>
                            </div>
                        </div>
                        
                        <!-- Premium title styling -->
                        <div class="space-y-2 mb-8">
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-gray-900 bg-clip-text text-transparent">Create Account</h2>
                            <p class="text-lg text-gray-500 font-medium">Join the FreightPro network today</p>
                            <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full mx-auto mt-4"></div>
                        </div>
                    </div>
                    
                    <!-- Account Type Selection Section -->
        <div id="accountTypeSelectionSection" class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Choose Your Account Type</h3>
                        <div class="grid md:grid-cols-3 gap-8 mb-6 max-w-6xl mx-auto">
                            <!-- Shipper Account -->
                            <div class="bg-gradient-to-br from-green-50 to-emerald-100 border-2 border-green-200 rounded-xl p-8 hover:border-green-400 hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105" onclick="selectAccountType('shipper')">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <i class="fas fa-boxes text-white text-3xl"></i>
                                    </div>
                                    <h4 class="text-2xl font-bold text-green-800 mb-3">Shipper</h4>
                                    <p class="text-green-700 text-base mb-4">I have freight that needs to move</p>
                                    <div class="text-sm text-green-600 space-y-2">
                                        <div>✓ No USDOT/MC required</div>
                                        <div>✓ Focus on accurate load details</div>
                                        <div>✓ Work with licensed brokers & carriers</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Carrier Account -->
                            <div class="bg-gradient-to-br from-blue-50 to-cyan-100 border-2 border-blue-200 rounded-xl p-8 hover:border-blue-400 hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105" onclick="selectAccountType('carrier')">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <i class="fas fa-truck text-white text-3xl"></i>
                                    </div>
                                    <h4 class="text-2xl font-bold text-blue-800 mb-3">Carrier</h4>
                                    <p class="text-blue-700 text-base mb-4">I operate the trucks that haul freight</p>
                                    <div class="text-sm text-blue-600 space-y-2">
                                        <div>✓ USDOT number always required</div>
                                        <div>✓ MC authority required for interstate moves until Oct 1, 2025</div>
                                        <div>✓ After Oct 1, 2025 USDOT becomes the primary identifier</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Broker Account -->
                            <div class="bg-gradient-to-br from-purple-50 to-violet-100 border-2 border-purple-200 rounded-xl p-8 hover:border-purple-400 hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105" onclick="selectAccountType('broker')">
                                <div class="text-center">
                                    <div class="w-20 h-20 bg-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                                        <i class="fas fa-handshake text-white text-3xl"></i>
                                    </div>
                                    <h4 class="text-2xl font-bold text-purple-800 mb-3">Broker</h4>
                                    <p class="text-purple-700 text-base mb-4">I arrange transportation between shippers and carriers</p>
                                    <div class="text-sm text-purple-600 space-y-2">
                                        <div>✓ USDOT number required</div>
                                        <div>✓ MC authority required until Oct 1, 2025 (USDOT-only after)</div>
                                        <div>✓ Connect shippers & carriers compliantly</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Type Status -->
                        <div id="accountTypeStatus" class="text-center p-4 bg-gray-100 rounded-lg hidden">
                            <p class="text-lg font-semibold text-gray-800">
                                Selected: <span id="selectedAccountTypeDisplay" class="text-blue-600"></span>
                            </p>
                            <button onclick="changeAccountType()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                                Change Account Type
                            </button>
                        </div>
                        
                        
                                            </div>
                        
                        <!-- Step 1: USDOT Question -->
                        <div id="usdotQuestionSection" class="hidden">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">USDOT Number Question</h3>
                            <p class="text-lg text-gray-600 text-center mb-8">Do you have a USDOT number?</p>
                            <div class="max-w-2xl mx-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <button type="button" onclick="selectUSDOTOption('yes')" 
                                        class="usdot-option-btn bg-green-600 hover:bg-green-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-check-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">Yes, I have USDOT</div>
                                            <div class="text-sm opacity-90">Required for Carriers, Optional for Brokers</div>
                                        </div>
                                    </button>
                                    <button type="button" onclick="selectUSDOTOption('no')" 
                                        class="usdot-option-btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-times-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">No USDOT Number</div>
                                            <div class="text-sm opacity-90">Brokers can proceed without USDOT</div>
                                        </div>
                                    </button>
                                </div>
                                <div class="text-center">
                                    <button type="button" onclick="goBackToAccountType()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-arrow-left mr-2"></i>Back to Account Type
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Broker MC Question -->
                        <div id="brokerMCQuestionSection" class="hidden">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Broker Authority Question</h3>
                            <p class="text-lg text-gray-600 text-center mb-8">Do you have an MC number?</p>
                            <div class="max-w-2xl mx-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <button type="button" onclick="handleBrokerMCResponse(true)" 
                                        class="usdot-option-btn bg-green-600 hover:bg-green-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-check-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">Yes, I have MC Number</div>
                                            <div class="text-sm opacity-90">Provide both USDOT and MC numbers</div>
                                        </div>
                                    </button>
                                    <button type="button" onclick="handleBrokerMCResponse(false)" 
                                        class="usdot-option-btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-times-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">No MC Number</div>
                                            <div class="text-sm opacity-90">Check USDOT availability</div>
                                        </div>
                                    </button>
                                </div>
                                <div class="text-center">
                                    <button type="button" class="bg-gray-300 text-gray-500 px-6 py-3 rounded-lg cursor-not-allowed" disabled>
                                        <i class="fas fa-arrow-left mr-2"></i>Back to Account Type
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Broker USDOT Question -->
                        <div id="brokerUSDOTQuestionSection" class="hidden">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Broker USDOT Question</h3>
                            <p class="text-lg text-gray-600 text-center mb-8">Do you have a USDOT number?</p>
                            <div class="max-w-2xl mx-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <button type="button" onclick="handleBrokerUSDOTResponse(true)" 
                                        class="usdot-option-btn bg-green-600 hover:bg-green-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-check-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">Yes, I have USDOT</div>
                                            <div class="text-sm opacity-90">Provide USDOT number only</div>
                                        </div>
                                    </button>
                                    <button type="button" onclick="handleBrokerUSDOTResponse(false)" 
                                        class="usdot-option-btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-times-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">No USDOT Number</div>
                                            <div class="text-sm opacity-90">Proceed to registration</div>
                                        </div>
                                    </button>
                                </div>
                                <div class="text-center">
                                    <button type="button" onclick="goBackToAccountType()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-arrow-left mr-2"></i>Back to Account Type
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Carrier Authority Question -->
                        <div id="carrierAuthorityQuestionSection" class="hidden">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Carrier Authority Question</h3>
                            <p class="text-lg text-gray-600 text-center mb-8">Do you have an MC number?</p>
                            <div class="max-w-2xl mx-auto">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                                    <button type="button" onclick="handleCarrierAuthorityResponse(true)" 
                                        class="usdot-option-btn bg-green-600 hover:bg-green-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-check-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">Yes, I have MC Number</div>
                                            <div class="text-sm opacity-90">Provide both USDOT and MC numbers</div>
                                        </div>
                                    </button>
                                    <button type="button" onclick="handleCarrierAuthorityResponse(false)" 
                                        class="usdot-option-btn bg-blue-600 hover:bg-blue-700 text-white px-8 py-6 rounded-xl transition-all duration-300 hover:scale-105">
                                        <i class="fas fa-times-circle mr-3 text-xl"></i>
                                        <div class="text-left">
                                            <div class="font-semibold text-lg">No MC Number</div>
                                            <div class="text-sm opacity-90">Provide USDOT number only</div>
                                        </div>
                                    </button>
                                </div>
                                <div class="text-center">
                                    <button type="button" onclick="goBackToAccountType()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                        <i class="fas fa-arrow-left mr-2"></i>Back to Account Type
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Step 2: Authority Verification -->
                        <div id="authorityVerificationSection" class="hidden">
                            <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Authority Verification Required</h3>
                            <p class="text-lg text-gray-600 text-center mb-8">Please provide your authority information for verification</p>
                            
                            <!-- Authority Verification Form -->
                            <div class="max-w-4xl mx-auto">
                                <form id="authorityVerificationForm" class="space-y-6">
                                    <!-- Hidden account type field -->
                                    <input type="hidden" name="accountType" id="authorityAccountTypeField" value="">
                                    
                                    <!-- Hidden fields -->
                                    <input type="hidden" name="hasUSDOT" id="hasUSDOTField" value="">
                                    
                                    <!-- Authority Information Grid -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- USDOT Number Field (shown only if user has USDOT) -->
                                        <div id="usdotFieldContainer" class="group">
                                            <label for="authorityUSDOT" class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                                <i class="fas fa-certificate mr-2 text-blue-500"></i>USDOT Number *
                                            </label>
                                            <div class="relative">
                                                <input type="text" id="authorityUSDOT" name="usdot" required
                                                    class="block w-full px-4 py-3 pr-24 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                           focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                           transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                    placeholder="e.g., 1234567"
                                                    maxlength="8"
                                                    pattern="[0-9]{7,8}">
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">7-8 digit USDOT number (e.g., 1234567, 12345678)</p>
                                        </div>
                                        
                                        <!-- MC Number Field -->
                                        <div id="mcFieldContainer" class="group">
                                            <label for="authorityMC" class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                                <i class="fas fa-id-badge mr-2 text-blue-500"></i>MC Number
                                                <span id="authorityMCRequiredLabel" class="text-red-500">*</span>
                                            </label>
                                            <div class="relative">
                                                <input type="text" id="authorityMC" name="mc"
                                                class="block w-full px-4 py-3 pr-24 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                placeholder="Enter MC number (any format)">
                                            </div>
                                            <p class="text-xs text-gray-500 mt-1">Enter MC number in any format (e.g., MC123456, MC-123456, 123456)</p>
                                        </div>
                                    </div>
                                    
                                    <!-- Company Information -->
                                    <div id="companyInfoSection">
                                        <div class="p-6 bg-blue-50 border border-blue-200 rounded-xl">
                                            <h4 class="text-lg font-semibold text-blue-800 mb-4">
                                                <i class="fas fa-building mr-2"></i>Company Information
                                            </h4>
                                            <p class="text-blue-700 mb-4">Please provide your company information:</p>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                <div class="group">
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        <i class="fas fa-building mr-2 text-blue-500"></i>Company Legal Name *
                                                    </label>
                                                    <input type="text" name="companyLegalName" required
                                                        class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                               focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                               transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                        placeholder="Enter company legal name">
                                                </div>
                                                
                                                <div class="group">
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        <i class="fas fa-map-marker-alt mr-2 text-blue-500"></i>Business Address *
                                                    </label>
                                                    <input type="text" name="companyAddress" required
                                                        class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                               focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                               transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                        placeholder="Enter business address">
                                                </div>
                                                
                                                <div class="group">
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        <i class="fas fa-phone mr-2 text-blue-500"></i>Phone Number *
                                                    </label>
                                                    <input type="tel" name="companyPhone" required
                                                        class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                               focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                               transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                        placeholder="Enter phone number">
                                                </div>
                                                
                                                <div class="group">
                                                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                        <i class="fas fa-envelope mr-2 text-blue-500"></i>Work Email *
                                                    </label>
                                                    <input type="email" name="companyEmail" required
                                                        class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                                               focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                                               transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                                        placeholder="Enter company email">
                                                </div>
                                            </div>
                                            
                                            <!-- Submit Company Info Button -->
                                            <div class="mt-4 pt-4 border-t border-blue-200">
                                                <button type="button" onclick="proceedToRegistration()" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                                    <i class="fas fa-arrow-right mr-2"></i>Continue to Registration
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Navigation Buttons -->
                                    <div class="flex justify-start pt-6">
                                        <button type="button" onclick="goBackToUSDOTQuestion()" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition-colors">
                                            <i class="fas fa-arrow-left mr-2"></i>Back to USDOT Question
                                        </button>
                                    </div>
                                </form>
                        </div>
                    </div>
                    
                    <!-- REGISTRATION FORM SECTION START -->
                    <div id="registrationFormSection" class="hidden">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Complete Your Registration</h3>
                        
                        <!-- Registration form container with 39% width -->
                        <div class="registration-form-container max-w-md mx-auto">
                            <!-- Premium registration form -->
                            <form class="space-y-6" id="registerForm">
                                <!-- REGISTRATION FORM START -->
                                <!-- UNIQUE ID: REG_FORM_001 -->
                                <!-- Hidden account type field -->
                                <input type="hidden" name="accountType" id="accountTypeField" value="">
                                <input type="hidden" name="authorityType" id="authorityTypeField" value="">
                                
                                <div class="space-y-6">
                                    <!-- Company Name Field -->
                                    <div class="group">
                                        <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                            <i class="fas fa-building mr-2 text-blue-500"></i>Company Name *
                                        </label>
                            <input type="text" name="company" required 
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Enter your company name">
                        </div>
                        
                                                    <!-- Work Email Field -->
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                    <i class="fas fa-envelope mr-2 text-blue-500"></i>Work Email *
                            </label>
                            <input type="email" name="email" required 
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                    placeholder="Enter your company work email">
                                <p class="text-xs text-gray-500 mt-1">Please use your company email address, not personal email</p>
                        </div>

                        <!-- Phone Number Field -->
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-phone mr-2 text-blue-500"></i>Phone Number *
                            </label>
                            <input type="tel" name="phone" required
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Enter your contact phone (e.g., 555-123-4567)"
                                autocomplete="tel">
                            <p class="text-xs text-gray-500 mt-1">Include country/area code. Numbers only; no extensions.</p>
                        </div>
                        
                        <!-- Username Field -->
                        <!-- Password Field -->
                        <div class="group relative">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-lock mr-2 text-blue-500"></i>Password *
                            </label>
                            <input type="password" name="password" id="registerPassword" required 
                                class="block w-full px-4 py-3 pr-12 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Create a secure password"
                                oninput="validatePassword(this.value)">
                            <button type="button" id="toggleRegisterPassword" aria-pressed="false" aria-label="Show password" 
                                class="absolute right-3 top-11 p-1 text-gray-400 hover:text-blue-500 transition-colors" title="Show password">
                                <span id="toggleRegisterPasswordIcon">👁️</span>
                            </button>
                            <div id="passwordValidation" class="mt-2 text-xs space-y-1">
                                <div id="passwordLength" class="text-gray-500">• At least 6 characters</div>
                                <div id="passwordStrength" class="text-gray-500">• Mix of letters and numbers recommended</div>
                            </div>
                        </div>
                        <!-- Confirm Password Field -->
                        <div class="group relative">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-shield-alt mr-2 text-blue-500"></i>Confirm Password *
                            </label>
                            <input type="password" name="confirmPassword" id="registerConfirmPassword" required 
                                class="block w-full px-4 py-3 pr-12 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Confirm your password">
                            <button type="button" id="toggleRegisterConfirmPassword" aria-pressed="false" aria-label="Show password" 
                                class="absolute right-3 top-11 p-1 text-gray-400 hover:text-blue-500 transition-colors" title="Show password">
                                <span id="toggleRegisterConfirmPasswordIcon">👁️</span>
                            </button>
                        </div>
                        
                        <!-- Account Type Field -->
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-briefcase mr-2 text-blue-500"></i>Account Type *
                            </label>
                            <select name="accountType" id="accountTypeSelect" required 
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300 cursor-pointer"
                                onchange="toggleEINField()">
                                <option value="">Select your account type</option>
                                <option value="shipper">📦 Shipper - I need to ship freight</option>
                                <option value="carrier">🚛 Carrier - I transport freight</option>
                                <option value="broker">🤝 Broker - I connect shippers & carriers</option>
                            </select>
                        </div>

                        <!-- EIN Field (only for brokers and carriers) -->
                        <div class="group" id="einFieldGroup" style="display: none;">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-id-card mr-2 text-blue-500"></i>EIN (Employer Identification Number) *
                            </label>
                            <input type="text" name="ein" id="einInput" 
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Enter EIN (e.g., 89-4521364)"
                                pattern="^\d{2}-\d{7}$"
                                title="EIN must be in format: XX-XXXXXXX">
                            <p class="text-xs text-gray-500 mt-1">Required for brokers and carriers. Format: XX-XXXXXXX</p>
                        </div>
                        

                        <!-- Enhanced Terms and conditions -->
                        <div class="flex items-start space-x-3 p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                            <input type="checkbox" required class="mt-1 h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500" id="termsCheckbox">
                            <label for="termsCheckbox" class="text-sm text-gray-600 leading-relaxed">
                                I agree to the <button type="button" onclick="showPage('terms')" class="text-blue-600 hover:text-blue-800 font-semibold underline bg-transparent border-none p-0 cursor-pointer">Terms of Service</button> and 
                                <button type="button" onclick="showPage('privacy')" class="text-blue-600 hover:text-blue-800 font-semibold underline bg-transparent border-none p-0 cursor-pointer">Privacy Policy</button>. 
                                I understand that FreightPro will use my information to provide freight logistics services.
                            </label>
                        </div>
                        
                        <!-- Professional Registration Notice -->
                        <div class="p-4 bg-green-50 border border-green-200 rounded-xl">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-shield-alt text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="text-sm font-semibold text-green-800 mb-1">Professional Verification</h4>
                                    <p class="text-xs text-green-700">
                                        Your registration will be verified to ensure a professional and trustworthy freight network.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Premium submit button -->
                    <div class="pt-6">
                        <button type="submit" class="group relative w-full flex justify-center items-center py-4 px-6 border border-transparent rounded-xl text-lg font-semibold text-white 
                                     bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 
                                     hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 
                                     focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 
                                     transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl
                                     shadow-lg overflow-hidden">
                            <!-- Animated background -->
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-400/0 via-white/20 to-blue-400/0 transform -skew-x-12 translate-x-[-100%] group-hover:translate-x-[200%] transition-transform duration-1000"></div>
                            <i class="fas fa-rocket mr-3 text-xl relative"></i>
                            <span class="relative">Create My FreightPro Account</span>
                        </button>
                        
                        <!-- Sign in link -->
                        <div class="text-center mt-6">
                            <p class="text-gray-600">
                                Already have an account? 
                                <button type="button" onclick="showPage('login')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Sign in here
                                </button>
                            </p>
                        </div>
                        
                        <!-- Terms and Privacy Links -->
                        <div class="text-center mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-500">
                                By signing in, you agree to our 
                                <button type="button" onclick="showPage('terms')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Terms of Service
                                </button> 
                                and 
                                <button type="button" onclick="showPage('privacy')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Privacy Policy
                                </button>
                            </p>
                        </div>
                    </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Pricing / Subscription Page -->
    <div id="pricing" class="page hidden">
        <div class="max-w-7xl mx-auto px-6 py-16">
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-extrabold text-yellow-400">Plans built for freight teams</h2>
                <p class="text-yellow-400 mt-3 max-w-2xl mx-auto">Choose a plan that fits your workflow — from free load browsing to enterprise-grade priority routing and insights.</p>

                <!-- Billing toggle (Monthly selected like Image 1) -->
                <div class="mt-6 inline-flex items-center">
                    <div class="relative bg-gray-200 rounded-full p-1 w-48 h-12 flex items-center cursor-pointer" id="billingToggleContainer">
                        <!-- Sliding knob (darker gray, positioned over Monthly) -->
                        <div class="absolute left-1 top-1 w-20 h-10 bg-gray-400 rounded-full shadow-md transition-all duration-300 ease-out transform" id="billingToggleKnob"></div>
                        
                        <!-- Monthly option (left side, white text - selected) -->
                        <div class="relative z-10 flex-1 flex items-center justify-center">
                            <span class="text-sm font-semibold text-white transition-colors duration-300" id="monthlyLabel">Monthly</span>
                        </div>
                        
                        <!-- Yearly option (right side, gray text - not selected) -->
                        <div class="relative z-10 flex-1 flex items-center justify-center">
                            <span class="text-sm font-semibold text-gray-500 transition-colors duration-300" id="yearlyLabel">Yearly</span>
                        </div>
                    </div>
                </div>

                <!-- Guest offer banner (shows only when not logged in) -->
                <div id="pricingGuestBanner" class="mt-6 mx-auto max-w-2xl bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-lg p-3 hidden">
                    <div class="flex items-center justify-between">
                        <div>
                            <strong>Limited offer:</strong>
                            <span id="pricingGuestText">Register within <span id="pricingCountdown">06:00:00</span> and get 3 months free Ultima subscription</span>
                        </div>
                        <div>
                            <button id="pricingGuestCTA" class="px-3 py-1 bg-yellow-500 text-white rounded">Register Now</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid gap-8 md:grid-cols-3">
                <!-- Basic -->
                <div class="pricing-card bg-white p-6 text-center rounded-lg">
                    <div class="flex flex-col h-full">
                        <div class="flex-1">
                            <div class="flex items-center justify-center mb-4">
                                <div class="pricing-badge">Free</div>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">Basic</h3>
                            <div class="text-3xl font-bold my-3"><span class="plan-price" data-plan="basic">$0<span class="text-sm font-medium">/mo</span></span></div>
                            <p class="text-gray-600">Ideal for independent carriers and small teams</p>
                            <ul class="text-sm text-gray-600 mt-4 space-y-2 text-left">
                                <li>• Full access to public load board</li>
                                <li>• Email support</li>
                                <li>• Basic search & filters</li>
                            </ul>
                        </div>
                        <div class="mt-6">
                            <button id="chooseBasic" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 px-4 py-2 rounded">Start Free</button>
                        </div>
                    </div>
                </div>

                <!-- Advanced -->
                <div class="pricing-card bg-gradient-to-br from-blue-50 to-white p-6 text-center rounded-lg border border-blue-100">
                    <div class="flex flex-col h-full">
                        <div class="flex-1">
                            <div class="flex items-center justify-center mb-4">
                                <div class="pricing-badge">Popular</div>
                            </div>
                            <h3 class="text-xl font-semibold mb-2">Advanced</h3>
                            <div class="text-3xl font-bold my-3"><span class="plan-price" data-plan="advanced">$19<span class="text-sm font-medium">/mo</span></span></div>
                            <p class="text-gray-700">Advanced tools for growing fleets</p>
                            <ul class="text-sm text-gray-700 mt-4 space-y-2 text-left">
                                <li>• Priority load matching</li>
                                <li>• Advanced analytics & export</li>
                                <li>• Smart alerts & routing</li>
                            </ul>
                        </div>
                        <div class="mt-6">
                            <button id="chooseAdvanced" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Choose Advanced</button>
                        </div>
                    </div>
                </div>

                <!-- Ultima (Featured) -->
                <div class="pricing-card relative p-6 text-center rounded-lg bg-gradient-to-br from-yellow-50 to-white border-2 border-yellow-400">
                    <div class="absolute -top-4 left-1/2 transform -translate-x-1/2">
                        <div class="pricing-badge">Ultima</div>
                    </div>
                    <div class="flex flex-col h-full">
                        <div class="flex-1">
                            <h3 class="text-xl font-semibold mb-2">Ultima</h3>
                            <div class="text-3xl font-bold my-3"><span class="plan-price" data-plan="ultima">$79<span class="text-sm font-medium">/mo</span></span></div>
                            <p class="text-gray-700">Everything included plus enterprise support</p>
                            <ul class="text-sm text-gray-700 mt-4 space-y-2 text-left">
                                <li>• Dedicated account manager</li>
                                <li>• Exportable analytics & SLA</li>
                                <li>• Phone support & priority routing</li>
                            </ul>
                        </div>
                        <div class="mt-6">
                            <button id="chooseUltima" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">Get Ultima</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Login Page -->
    <div id="login" class="page hidden">
        <div class="min-h-screen flex items-center justify-center py-4 px-4 bg-gray-50 relative overflow-hidden">
            <!-- Premium background pattern -->
            <div class="absolute inset-0 opacity-5">
                <svg viewBox="0 0 1200 800" class="w-full h-full">
                    <!-- Elegant logistics pattern -->
                    <defs>
                        <pattern id="loginGrid" width="100" height="100" patternUnits="userSpaceOnUse">
                            <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#3b82f6" stroke-width="1"/>
                        </pattern>
                    </defs>
                    <rect width="100%" height="100%" fill="url(#loginGrid)"/>
                    <!-- Premium truck silhouettes -->
                    <g opacity="0.3">
                        <rect x="300" y="200" width="80" height="30" rx="3" fill="#3b82f6"/>
                        <rect x="385" y="190" width="25" height="40" rx="3" fill="#1e40af"/>
                        <circle cx="320" cy="235" r="6" fill="#374151"/>
                        <circle cx="350" cy="235" r="6" fill="#374151"/>
                        <circle cx="395" cy="235" r="6" fill="#374151"/>
                    </g>
                    <g opacity="0.2" transform="translate(700,350)">
                        <rect x="0" y="20" width="90" height="35" rx="4" fill="#3b82f6"/>
                        <rect x="95" y="10" width="30" height="45" rx="4" fill="#1e40af"/>
                        <circle cx="25" cy="60" r="7" fill="#374151"/>
                        <circle cx="55" cy="60" r="7" fill="#374151"/>
                        <circle cx="110" cy="60" r="7" fill="#374151"/>
                    </g>
                </svg>
            </div>

            <!-- Premium login card -->
            <div class="max-w-md w-full space-y-8 relative z-10">
                <div class="bg-white rounded-2xl shadow-2xl border border-gray-100 p-10 backdrop-blur-sm">
                    <div class="text-center">
                        <!-- Premium FreightPro login icon -->
                        <div class="mb-8 flex justify-center">
                            <div class="relative">
                                <!-- Premium gradient circle with enhanced styling -->
                                <div class="w-28 h-28 rounded-full bg-gradient-to-br from-blue-500 via-blue-600 to-blue-700 flex items-center justify-center shadow-2xl border-4 border-white/20 relative overflow-hidden">
                                    <!-- Glassmorphism overlay -->
                                    <div class="absolute inset-0 bg-white/10 backdrop-blur-sm rounded-full"></div>
                                    <!-- Professional truck icon with premium styling -->
                                    <svg width="60" height="60" viewBox="0 0 60 60" fill="none" class="relative z-10">
                                        <!-- Enhanced truck design -->
                                        <g filter="drop-shadow(0 2px 4px rgba(0,0,0,0.1))">
                                            <!-- Main truck trailer with premium styling -->
                                            <rect x="6" y="22" width="32" height="18" rx="3" fill="white" opacity="0.95" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                            <!-- Truck cab with enhanced details -->
                                            <rect x="38" y="18" width="16" height="22" rx="3" fill="white" opacity="0.95" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                            <!-- Premium windshield with reflection -->
                                            <rect x="40" y="20" width="12" height="10" rx="2" fill="#60a5fa" opacity="0.4"/>
                                            <rect x="41" y="21" width="4" height="8" rx="1" fill="white" opacity="0.6"/>
                                            <!-- Enhanced front bumper -->
                                            <rect x="54" y="22" width="3" height="14" rx="1.5" fill="white" opacity="0.9"/>
                                            <!-- Premium grille design -->
                                            <rect x="51" y="25" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="27" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="29" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <rect x="51" y="31" width="3" height="1" rx="0.5" fill="#374151" opacity="0.7"/>
                                            <!-- Premium wheels with enhanced styling -->
                                            <circle cx="16" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="16" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="16" cy="42" r="2" fill="#374151"/>
                                            <circle cx="16" cy="42" r="0.8" fill="#9ca3af"/>
                                            <circle cx="28" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="28" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="28" cy="42" r="2" fill="#374151"/>
                                            <circle cx="28" cy="42" r="0.8" fill="#9ca3af"/>
                                            <circle cx="46" cy="42" r="6" fill="white" stroke="#e5e7eb" stroke-width="0.5"/>
                                            <circle cx="46" cy="42" r="4" fill="#1f2937"/>
                                            <circle cx="46" cy="42" r="2" fill="#374151"/>
                                            <circle cx="46" cy="42" r="0.8" fill="#9ca3af"/>
                                            <!-- Premium headlights -->
                                            <circle cx="54" cy="24" r="2" fill="#fbbf24" opacity="0.9" filter="drop-shadow(0 0 3px #fbbf24)"/>
                                            <circle cx="54" cy="34" r="2" fill="#f87171" opacity="0.8" filter="drop-shadow(0 0 3px #f87171)"/>
                                            <!-- FreightPro premium branding -->
                                            <rect x="10" y="26" width="20" height="6" rx="2" fill="rgba(59,130,246,0.15)" stroke="rgba(59,130,246,0.3)" stroke-width="0.5"/>
                                            <text x="20" y="30" font-family="Arial, sans-serif" font-size="4" font-weight="bold" fill="#2563eb" text-anchor="middle" opacity="0.8">FreightPro</text>
                                        </g>
                                    </svg>
                                </div>
                                <!-- Premium glow effects -->
                                <div class="absolute inset-0 rounded-full bg-blue-400 opacity-20 blur-xl animate-pulse"></div>
                                <div class="absolute inset-2 rounded-full bg-white opacity-10 blur-lg"></div>
                            </div>
                        </div>
                        
                        <!-- Premium title styling -->
                        <div class="space-y-2 mb-8">
                            <h2 class="text-4xl font-bold bg-gradient-to-r from-gray-900 via-blue-800 to-gray-900 bg-clip-text text-transparent">Welcome Back</h2>
                            <p class="text-lg text-gray-500 font-medium">Access your FreightPro account</p>
                            <div class="w-24 h-1 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full mx-auto mt-4"></div>
                        </div>
                    </div>
                <!-- Premium login form -->
                <form class="space-y-6" id="loginForm">
                    <div class="space-y-6">
                        <!-- Email Field -->
                        <div class="group">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-envelope mr-2 text-blue-500"></i>Email Address
                            </label>
                            <input type="email" name="email" required 
                                class="block w-full px-4 py-3 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="your.email@company.com">
                        </div>
                        
                        <!-- Password Field -->
                        <div class="group relative">
                            <label class="block text-sm font-semibold text-gray-700 mb-2 transition-colors group-focus-within:text-blue-600">
                                <i class="fas fa-lock mr-2 text-blue-500"></i>Password
                            </label>
                            <input id="loginPassword" type="password" name="password" required 
                                class="block w-full px-4 py-3 pr-12 border-2 border-gray-200 rounded-xl shadow-sm placeholder-gray-400 
                                       focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 
                                       transition-all duration-300 bg-gray-50/50 hover:bg-white hover:border-gray-300"
                                placeholder="Enter your password">
                            <button type="button" id="toggleShowPassword" aria-pressed="false" aria-label="Show password" 
                                class="absolute right-3 top-11 p-1 text-gray-400 hover:text-blue-500 transition-colors" title="Show password">
                                <span id="toggleShowPasswordIcon">👁️</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Login Error -->
                    <div id="loginError" class="text-red-600 text-sm hidden p-3 bg-red-50 rounded-xl border border-red-200" role="alert">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="loginErrorText"></span>
                    </div>
                    
                    <!-- Remember me and forgot password -->
                    <div class="flex items-center justify-between p-4 bg-blue-50/50 rounded-xl border border-blue-100">
                        <label class="flex items-center cursor-pointer group">
                            <input type="checkbox" class="h-4 w-4 text-blue-600 border-2 border-gray-300 rounded focus:ring-blue-500 transition-colors">
                            <span class="ml-3 text-sm text-gray-600 group-hover:text-gray-800 transition-colors">Remember me</span>
                        </label>
                        <a href="#" class="text-sm text-blue-600 hover:text-blue-800 font-semibold transition-colors">Forgot password?</a>
                    </div>
                    
                    <!-- Premium submit button -->
                    <div class="pt-4">
                        <button type="submit" class="group relative w-full flex justify-center items-center py-4 px-6 border border-transparent rounded-xl text-lg font-semibold text-white 
                                     bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 
                                     hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 
                                     focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 
                                     transform transition-all duration-300 hover:scale-[1.02] hover:shadow-xl
                                     shadow-lg overflow-hidden">
                            <!-- Animated background -->
                            <div class="absolute inset-0 bg-gradient-to-r from-blue-400/0 via-white/20 to-blue-400/0 transform -skew-x-12 translate-x-[-100%] group-hover:translate-x-[200%] transition-transform duration-1000"></div>
                            <i class="fas fa-sign-in-alt mr-3 text-xl relative"></i>
                            <span class="relative">Sign In to FreightPro</span>
                        </button>
                        
                        <!-- Register link -->
                        <div class="text-center mt-6">
                            <p class="text-gray-600">
                                Don't have an account? 
                                <button type="button" onclick="showPage('register')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Create one here
                                </button>
                            </p>
                        </div>
                        
                        <!-- Terms and Privacy Links -->
                        <div class="text-center mt-4 pt-4 border-t border-gray-200">
                            <p class="text-xs text-gray-500">
                                By signing in, you agree to our 
                                <button type="button" onclick="showPage('terms')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Terms of Service
                                </button> 
                                and 
                                <button type="button" onclick="showPage('privacy')" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors duration-200">
                                    Privacy Policy
                                </button>
                            </p>
                        </div>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>



    <!-- Load Board Page -->
    <div id="loadboard" class="page hidden">
        <!-- widened container for the search bar area to provide more horizontal space -->
        <div class="max-w-screen-2xl mx-auto px-4 py-8">
            <!-- Smart Search Filters -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-semibold flex items-center">
                        <i class="fas fa-search mr-2 text-blue-600"></i>Smart Load Search
                    </h2>
                    <div class="real-time-indicator">Real-time Results</div>
                </div>
                
                <div class="grid md:grid-cols-4 gap-4 mb-4">
                    <!-- global search placeholder for JS to attach larger, shorter input -->
                    <div class="md:col-span-4 smart-search-global"></div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Origin</label>
                        <input type="text" id="originFilter" placeholder="City, State or ZIP" 
                               class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                               oninput="showSmartSuggestions(this, 'origin')">
                        <div id="originSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                    <div class="relative">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Destination</label>
                        <input type="text" id="destFilter" placeholder="City, State or ZIP" 
                               class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500"
                               oninput="showSmartSuggestions(this, 'destination')">
                        <div id="destSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-48 overflow-y-auto"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Equipment Type</label>
                        <div class="relative">

                            <!-- Hidden select kept for compatibility; JS will sync it -->
                            <select id="equipmentFilter" class="hidden" onchange="searchLoads()">
                                <option value="">All Equipment</option>
                                <option value="Van">Van</option>
                                <option value="Flatbed">Flatbed</option>
                                <option value="Reefer">Reefer</option>
                                <option value="Step Deck">Step Deck</option>
                                <option value="Lowboy">Lowboy</option>
                                <option value="Tanker">Tanker</option>
                                <option value="Container">Container</option>
                                <option value="Car Carrier">Car Carrier</option>
                            </select>

                            <!-- Custom dropdown control (text-only) -->
                            <button id="equipmentDropdownBtn" type="button" class="w-full text-left pl-3 pr-3 py-2 border rounded-md flex items-center justify-between" onclick="toggleEquipmentDropdown()">
                                <span id="equipmentLabel" class="text-sm text-gray-700">All Equipment</span>
                                <svg class="w-4 h-4 text-gray-400" viewBox="0 0 20 20" fill="none" stroke="currentColor"><path d="M6 8l4 4 4-4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                            </button>

                            <div id="equipmentDropdown" class="absolute z-20 mt-2 w-full bg-white border rounded-md shadow-lg hidden max-h-48 overflow-y-auto">
                                <ul id="equipmentList" class="divide-y">
                                    <!-- items inserted by JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pickup Date</label>
                        <input type="date" id="dateFilter" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" onchange="searchLoads()">
                    </div>
                </div>
                
                <div class="grid md:grid-cols-5 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Min Rate ($)</label>
                        <input type="number" id="minRate" placeholder="1000" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" oninput="searchLoads()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Max Miles</label>
                        <input type="number" id="maxMiles" placeholder="" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" oninput="searchLoads()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Load Type</label>
                        <select id="loadTypeFilter" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" onchange="searchLoads()">
                            <option value="">All Types</option>
                            <option value="Full Truckload">Full Truckload</option>
                            <option value="LTL">Less Than Truckload</option>
                            <option value="Partial">Partial Load</option>
                            <option value="Expedited">Expedited</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Radius (miles)</label>
                        <input type="number" id="radiusFilter" min="0" placeholder="Enter miles (leave blank for any)" class="w-full px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500" oninput="searchLoads()">
                    </div>
                    <div class="flex items-end">
                        <button onclick="searchLoads()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors">
                            <i class="fas fa-search mr-2"></i>Search
                        </button>
                    </div>
                </div>
                
                    <div class="flex flex-wrap gap-2">
                    <button onclick="clearFilters()" class="text-gray-600 hover:text-gray-800 px-3 py-1 border rounded">
                        <i class="fas fa-times mr-1"></i>Clear Filters
                    </button>
                    <button onclick="saveSearch()" class="text-blue-600 hover:text-blue-800 px-3 py-1 border rounded">
                        <i class="fas fa-save mr-1"></i>Save Search
                    </button>
                    <!-- Map View button removed as requested -->
                    <button id="autoRefreshToggleButton" onclick="enableAutoRefresh()" class="text-purple-600 hover:text-purple-800 px-3 py-1 border rounded">
                        <i class="fas fa-sync-alt mr-1"></i>Auto Refresh
                    </button>
                    <!-- Auto-generate removed as per user request -->
                </div>
            </div>

            <!-- Real-time Load Statistics -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-2xl font-bold text-blue-600" id="totalLoads">2,847</div>
                    <div class="text-sm text-gray-600">Available Loads</div>
                    <div class="text-xs text-green-600 mt-1">↗ +23 last hour</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-2xl font-bold text-green-600" id="avgRate">$2.85</div>
                    <div class="text-sm text-gray-600">Avg Rate/Mile</div>
                    <div class="text-xs rate-trend-up mt-1">↗ +$0.05 today</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-2xl font-bold text-purple-600" id="newToday">456</div>
                    <div class="text-sm text-gray-600">New Today</div>
                    <div class="text-xs text-green-600 mt-1">↗ +12% vs yesterday</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-2xl font-bold text-orange-600" id="loadTruckRatio">2.1:1</div>
                    <div class="text-sm text-gray-600">Load-to-Truck Ratio</div>
                    <div class="text-xs rate-trend-up mt-1">↗ Favorable</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-2xl font-bold text-red-600" id="urgentLoads">89</div>
                    <div class="text-sm text-gray-600">Urgent Loads</div>
                    <div class="text-xs text-red-600 mt-1">⚡ High Priority</div>
                </div>
            </div>

            <!-- Map view removed as requested -->

            <!-- Live Activity Feed -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fas fa-broadcast-tower mr-2 text-green-600"></i>Live Activity Feed
                    <span class="real-time-indicator ml-2">Real-time</span>
                </h3>
                <div class="space-y-3 max-h-48 overflow-y-auto" id="activityFeed">
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">New load posted: Chicago → Atlanta</div>
                            <div class="text-xs text-gray-500">ABC Logistics • 2 minutes ago</div>
                        </div>
                        <div class="text-xs text-green-600 font-medium">$2,150</div>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">Load booked: Miami → New York</div>
                            <div class="text-xs text-gray-500">Fresh Transport • 4 minutes ago</div>
                        </div>
                        <div class="text-xs text-blue-600 font-medium">$3,840</div>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-orange-50 rounded-lg border-l-4 border-orange-500">
                        <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">New carrier registered: Texas Cold Chain</div>
                            <div class="text-xs text-gray-500">Houston, TX • 6 minutes ago</div>
                        </div>
                        <div class="text-xs text-orange-600 font-medium">Reefer</div>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-purple-50 rounded-lg border-l-4 border-purple-500">
                        <div class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">Load posted: Denver → Salt Lake City</div>
                            <div class="text-xs text-gray-500">Mountain Peak Transport • 8 minutes ago</div>
                        </div>
                        <div class="text-xs text-purple-600 font-medium">$2,200</div>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-green-50 rounded-lg border-l-4 border-green-500">
                        <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">Load booked: New York → Boston</div>
                            <div class="text-xs text-gray-500">Northeast Express • 12 minutes ago</div>
                        </div>
                        <div class="text-xs text-green-600 font-medium">$1,800</div>
                    </div>
                    <div class="flex items-center space-x-3 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500">
                        <div class="w-2 h-2 bg-blue-500 rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">New shipper registered: Bay Area Logistics</div>
                            <div class="text-xs text-gray-500">San Francisco, CA • 15 minutes ago</div>
                        </div>
                        <div class="text-xs text-blue-600 font-medium">Technology</div>
                    </div>
                </div>
            </div>

            <!-- Load Results -->
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                    <h3 class="text-lg font-semibold flex items-center">
                        <i class="fas fa-list mr-2 text-blue-600"></i>Available Loads
                        <span class="real-time-indicator ml-2">Live Updates</span>
                    </h3>
                    <div class="flex flex-wrap gap-2">
                        <button onclick="refreshLoads()" class="text-blue-600 hover:text-blue-800 px-3 py-1 border rounded">
                            <i class="fas fa-sync-alt mr-1"></i>Refresh
                        </button>
                        <select id="sortFilter" class="px-3 py-1 border rounded text-sm" onchange="sortLoads()">
                            <option value="rate_desc">Rate (High to Low)</option>
                            <option value="rate_asc">Rate (Low to High)</option>
                            <option value="distance_asc">Distance (Near to Far)</option>
                            <option value="date_asc">Pickup Date (Earliest)</option>
                            <option value="posted_desc">Recently Posted</option>
                        </select>
                        <select id="viewMode" class="px-3 py-1 border rounded text-sm" onchange="changeViewMode()">
                            <option value="list">List View</option>
                            <option value="card">Card View</option>
                            <option value="compact">Compact View</option>
                        </select>
                    </div>
                </div>
                <div id="loadResults">
                    <!-- Load cards will be populated here -->
                </div>
                <div class="px-6 py-4 border-t border-gray-200 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0">
                    <div class="text-sm text-gray-600">Showing <span id="showingCount">1-20</span> of <span id="totalCount">2,847</span> loads</div>
                    <div class="flex items-center space-x-2"><span class="text-xs text-gray-500">Infinite scroll enabled — more loads append as you scroll</span></div>
                </div>
            </div>
        </div>
    </div>
    <!-- Post Load Page -->
    <div id="postload" class="page hidden">
        <!-- Access Control Check -->
        <div id="postLoadAccessDenied" class="max-w-4xl mx-auto px-4 py-8 hidden">
            <div class="text-center">
                <i class="fas fa-lock text-6xl text-red-500 mb-6"></i>
                <h1 class="text-3xl font-bold text-gray-800 mb-4">Access Restricted</h1>
                <p class="text-lg text-gray-600 mb-6">Only registered brokers and shippers can post loads.</p>
                <div class="space-y-3">
                    <p class="text-gray-500">• Brokers can post loads to connect shippers with carriers</p>
                    <p class="text-gray-500">• Shippers can post loads to find transportation</p>
                    <p class="text-gray-500">• Carriers cannot post loads (they transport freight)</p>
                </div>
                <div class="mt-8 space-x-4">
                    <button onclick="showPage('register')" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-user-plus mr-2"></i>Register as Broker/Shipper
                    </button>
                    <button onclick="showPage('home')" class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        <i class="fas fa-home mr-2"></i>Go Home
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Professional Post Load Form -->
        <div id="postLoadForm" class="max-w-7xl mx-auto px-8 py-12 pb-20 hidden">
            <!-- Professional Header Section -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-xl p-12 mb-12 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-4xl font-bold mb-2">Post a Load</h1>
                        <p class="text-blue-100 text-lg">Reach thousands of qualified carriers instantly with our professional load board</p>
                    </div>
                    <div class="hidden md:block">
                        <i class="fas fa-truck-loading text-6xl text-blue-200"></i>
                    </div>
                </div>
                <div class="mt-6 flex items-center space-x-6 text-sm">
                    <div class="flex items-center">
                        <i class="fas fa-users mr-2"></i>
                        <span>2,500+ Active Carriers</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-clock mr-2"></i>
                        <span>Average Response: 15 min</span>
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt mr-2"></i>
                        <span>Verified Carriers Only</span>
                    </div>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div class="bg-white rounded-lg shadow-lg p-8 mb-12">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-blue-600 text-white rounded-full flex items-center justify-center text-sm font-semibold">1</div>
                            <span class="ml-2 text-sm font-medium">Load Details</span>
                        </div>
                        <div class="w-16 h-1 bg-gray-200 rounded"></div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">2</div>
                            <span class="ml-2 text-sm text-gray-500">Route & Timing</span>
                        </div>
                        <div class="w-16 h-1 bg-gray-200 rounded"></div>
                        <div class="flex items-center">
                            <div class="w-8 h-8 bg-gray-200 text-gray-500 rounded-full flex items-center justify-center text-sm font-semibold">3</div>
                            <span class="ml-2 text-sm text-gray-500">Rate & Terms</span>
                        </div>
                    </div>
                    <div class="text-sm text-gray-500">
                        <i class="fas fa-save mr-1"></i>
                        Auto-save enabled
                    </div>
                </div>
            </div>
            
            <form class="bg-white rounded-lg shadow-lg overflow-hidden" onsubmit="handlePostLoad(event)" id="loadPostForm">
                <!-- Step 1: Load Information -->
                <div class="p-12 border-b border-gray-200">
                    <div class="flex items-center mb-10">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-6">
                            <i class="fas fa-box text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Load Information</h2>
                            <p class="text-gray-600 text-lg">Tell us about your freight and requirements</p>
                        </div>
                    </div>
                    <div class="grid lg:grid-cols-3 gap-8">
                        <!-- Load Type -->
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Load Type <span class="text-red-500">*</span>
                            </label>
                            <select name="loadType" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="">Select Load Type</option>
                                <option value="Full Truckload">🚛 Full Truckload (FTL)</option>
                                <option value="Less Than Truckload">📦 Less Than Truckload (LTL)</option>
                                <option value="Partial">🔀 Partial Load</option>
                                <option value="Expedited">⚡ Expedited</option>
                                <option value="Hot Shot">🔥 Hot Shot</option>
                            </select>
                        </div>

                        <!-- Equipment Type -->
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Equipment Type <span class="text-red-500">*</span>
                            </label>
                            <select name="equipmentType" required class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="">Select Equipment</option>
                                <option value="Van">🚐 Dry Van</option>
                                <option value="Flatbed">🚛 Flatbed</option>
                                <option value="Reefer">❄️ Refrigerated</option>
                                <option value="Step Deck">📐 Step Deck</option>
                                <option value="Lowboy">⬇️ Lowboy</option>
                                <option value="Tanker">🛢️ Tanker</option>
                                <option value="Container">📦 Container</option>
                                <option value="Car Carrier">🚗 Car Carrier</option>
                                <option value="Power Only">🔌 Power Only</option>
                            </select>
                        </div>

                        <!-- Commodity -->
                        <div class="lg:col-span-1">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Commodity</label>
                            <select name="commodity" id="commoditySelect" onchange="handleCommodityChange()" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="">Select Commodity</option>
                                <option value="General Freight">📦 General Freight</option>
                                <option value="Electronics">📱 Electronics</option>
                                <option value="Food & Beverage">🍎 Food & Beverage</option>
                                <option value="Automotive">🚗 Automotive</option>
                                <option value="Construction">🏗️ Construction Materials</option>
                                <option value="Machinery">⚙️ Machinery</option>
                                <option value="Textiles">👕 Textiles</option>
                                <option value="Chemicals">🧪 Chemicals</option>
                                <option value="Other">📋 Other</option>
                                <option value="manual">✏️ Manual Entry (Custom)</option>
                            </select>
                            
                            <!-- Manual Commodity Input (Hidden by default) -->
                            <div id="manualCommodityContainer" class="mt-3 hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Custom Commodity <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="customCommodity" id="customCommodityInput" 
                                       placeholder="Enter your commodity type (e.g., Medical Supplies, Furniture, etc.)"
                                       class="w-full px-5 py-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-blue-50 hover:bg-white text-base">
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Be specific about your commodity type for better carrier matching
                        </div>
                            </div>
                        </div>
                        <!-- Weight -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Weight (lbs) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="weight" placeholder="45,000" min="1" max="80000" required
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>

                        <!-- Length -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Length (ft) <span class="text-red-500">*</span>
                            </label>
                            <input type="number" name="length" placeholder="48" min="1" max="53" required
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>


                        <!-- Load Title -->
                        <div class="lg:col-span-2">
                            <label class="block text-sm font-semibold text-gray-700 mb-3">
                                Load Title <span class="text-red-500">*</span>
                            </label>
                            <input type="text" name="title" required placeholder="e.g., General Freight - Electronics" 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Distance (miles)</label>
                            <input type="number" name="distance" placeholder="" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>
                    </div>
                </div>

                <!-- Pickup Information -->
                <div class="p-12 border-b border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-6">
                            <i class="fas fa-map-marker-alt text-green-600 text-xl"></i>
                        </div>
                        Pickup Information
                    </h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pickup City, State <span class="text-red-500">*</span></label>
                            <input type="text" required placeholder="Chicago, IL" name="originLocation" 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pickup ZIP Code</label>
                            <input type="text" placeholder="60601" name="originZip" id="originZip" 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base"
                                   onblur="validateZipCode('originZip', 'originLocation')" oninput="validateZipCode('originZip', 'originLocation')">
                            <div id="originZipError" class="mt-2 text-sm text-red-600 hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                This ZIP code does not match the city/state entered
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pickup Date <span class="text-red-500">*</span></label>
                            <input type="date" name="pickupDate" id="pickupDate" required 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base"
                                   onchange="validatePickupDate()" oninput="validatePickupDate()">
                            <div id="pickupDateError" class="mt-2 text-sm text-red-600 hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Please enter a valid date (cannot be earlier than today)
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Pickup Time</label>
                            <select name="pickupTime" id="pickupTimeSelect" onchange="handlePickupTimeChange()" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="">Anytime</option>
                                <option value="morning">Morning (6AM-12PM)</option>
                                <option value="afternoon">Afternoon (12PM-6PM)</option>
                                <option value="evening">Evening (6PM-12AM)</option>
                                <option value="manual">✏️ Manual Entry (Custom Time)</option>
                            </select>
                            
                            <!-- Manual Pickup Time Input (Hidden by default) -->
                            <div id="manualPickupTimeContainer" class="mt-3 hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Custom Pickup Time <span class="text-red-500">*</span>
                                </label>
                                <input type="time" name="customPickupTime" id="customPickupTimeInput" 
                                       class="w-full px-5 py-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-blue-50 hover:bg-white text-base">
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Enter specific pickup time (e.g., 2:30 PM)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Information -->
                <div class="p-12 border-b border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center">
                        <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center mr-6">
                            <i class="fas fa-flag-checkered text-red-600 text-xl"></i>
                        </div>
                        Delivery Information
                    </h2>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Delivery City, State <span class="text-red-500">*</span></label>
                            <input type="text" required placeholder="Atlanta, GA" name="destinationLocation" id="destinationLocation"
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Delivery ZIP Code</label>
                            <input type="text" placeholder="30301" name="destinationZip" id="destinationZip" 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base"
                                   onblur="validateZipCode('destinationZip', 'destinationLocation')" oninput="validateZipCode('destinationZip', 'destinationLocation')">
                            <div id="destinationZipError" class="mt-2 text-sm text-red-600 hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                This ZIP code does not match the city/state entered
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Delivery Date <span class="text-red-500">*</span></label>
                            <input type="date" name="deliveryDate" id="deliveryDate" required 
                                   class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base"
                                   onchange="validateDeliveryDate()" oninput="validateDeliveryDate()">
                            <div id="deliveryDateError" class="mt-2 text-sm text-red-600 hidden">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Please enter a valid date (cannot be earlier than pickup date)
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Delivery Time</label>
                            <select name="deliveryTime" id="deliveryTimeSelect" onchange="handleDeliveryTimeChange()" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="">Anytime</option>
                                <option value="morning">Morning (6AM-12PM)</option>
                                <option value="afternoon">Afternoon (12PM-6PM)</option>
                                <option value="evening">Evening (6PM-12AM)</option>
                                <option value="manual">✏️ Manual Entry (Custom Time)</option>
                            </select>
                            
                            <!-- Manual Delivery Time Input (Hidden by default) -->
                            <div id="manualDeliveryTimeContainer" class="mt-3 hidden">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    Custom Delivery Time <span class="text-red-500">*</span>
                                </label>
                                <input type="time" name="customDeliveryTime" id="customDeliveryTimeInput" 
                                       class="w-full px-5 py-4 border-2 border-blue-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-blue-50 hover:bg-white text-base">
                                <div class="mt-2 text-xs text-gray-500">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    Enter specific delivery time (e.g., 4:30 PM)
                        </div>
                    </div>
                        </div>
                    </div>
                </div>


                <!-- Rate Information -->
                <div class="p-12 border-b border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-6">
                            <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
                        </div>
                        Rate Information
                    </h2>
                    <div class="grid md:grid-cols-3 gap-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Rate Type</label>
                            <select name="rateType" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="flat">Flat Rate</option>
                                <option value="per_mile">Per Mile</option>
                                <option value="negotiable">Negotiable</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Rate Amount ($) <span class="text-red-500">*</span></label>
                            <input type="number" name="rate" required placeholder="2500" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Payment Terms</label>
                            <select name="paymentTerms" class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base">
                                <option value="net30">Net 30</option>
                                <option value="net15">Net 15</option>
                                <option value="quick_pay">Quick Pay</option>
                                <option value="cod">COD</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Additional Information -->
                <div class="p-12">
                    <h2 class="text-3xl font-bold text-gray-900 mb-8 flex items-center">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-6">
                            <i class="fas fa-clipboard-list text-orange-600 text-xl"></i>
                        </div>
                        Additional Information
                    </h2>
                    <div class="space-y-8">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-3">Load Description</label>
                            <textarea name="description" rows="4" placeholder="Describe the load, special requirements, etc." 
                                      class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 bg-gray-50 hover:bg-white text-base resize-none"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="hazmat" id="hazmat" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="hazmat" class="text-base font-medium text-gray-700 cursor-pointer">🚨 Hazmat Required</label>
                            </div>
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="tempControl" id="tempControl" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="tempControl" class="text-base font-medium text-gray-700 cursor-pointer">❄️ Temperature Controlled</label>
                            </div>
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="teamDriver" id="teamDriver" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="teamDriver" class="text-base font-medium text-gray-700 cursor-pointer">👥 Team Driver Required</label>
                        </div>
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="liftgate" id="liftgate" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="liftgate" class="text-base font-medium text-gray-700 cursor-pointer">🔧 Liftgate Required</label>
                            </div>
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="expedited" id="expedited" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="expedited" class="text-base font-medium text-gray-700 cursor-pointer">⚡ Expedited Service</label>
                            </div>
                            <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                                <input type="checkbox" name="insideDelivery" id="insideDelivery" class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="insideDelivery" class="text-base font-medium text-gray-700 cursor-pointer">🏢 Inside Delivery</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Navigation -->
                <div class="flex justify-between items-center pt-12 pb-16 px-12 border-t border-gray-200">
                    <div class="flex items-center text-base text-gray-500">
                        <i class="fas fa-shield-alt mr-3 text-green-500 text-lg"></i>
                        <span>Your load will be posted to verified carriers only</span>
                    </div>
                    <div class="flex space-x-6">
                    <button type="button" onclick="showPage('loadboard')" 
                                class="px-8 py-4 border-2 border-gray-300 rounded-xl text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 font-semibold text-base">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                        <button type="button" onclick="saveDraft()" 
                                class="px-8 py-4 border-2 border-blue-300 text-blue-600 rounded-xl hover:bg-blue-50 hover:border-blue-400 transition-all duration-200 font-semibold text-base">
                            <i class="fas fa-save mr-2"></i>Save Draft
                        </button>
                        <button type="submit" 
                                class="px-10 py-4 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-xl transition-all duration-200 font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 text-base">
                        <i class="fas fa-paper-plane mr-2"></i>Post Load
                    </button>
                    </div>
                </div>
            </form>
            
            <!-- Extra bottom spacing -->
            <div class="h-16"></div>
        </div>
    </div>

    

    <!-- Rate Analysis Page -->
    <div id="rates" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <i class="fas fa-chart-line text-4xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold">Live Rate Analysis</h1>
                <p class="text-gray-600">Real-time market intelligence and pricing data</p>
                <div class="real-time-indicator mx-auto mt-2">Updated every 30 seconds</div>
                <!-- Placeholder container for the rates module (lazy-loaded) -->
                <div id="ratesPlaceholder" class="mt-4 text-sm text-gray-600">
                    The advanced rate analysis module isn't loaded yet.
                    <button id="loadRatesBtn" class="ml-3 px-3 py-1 bg-blue-600 text-white rounded text-xs">Load full rates</button>
                </div>
            </div>
            
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-route mr-2 text-green-600"></i>Top Paying Lanes (Live)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-green-50 to-green-100 rounded-lg">
                            <div>
                                <div class="font-medium">Chicago, IL → Atlanta, GA</div>
                                <div class="text-sm text-gray-600">717 miles • Van</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-green-600 text-lg">$3.15/mile</div>
                                <div class="text-xs rate-trend-up">↗ +$0.08 today</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg">
                            <div>
                                <div class="font-medium">Los Angeles, CA → Phoenix, AZ</div>
                                <div class="text-sm text-gray-600">372 miles • Flatbed</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-blue-600 text-lg">$5.08/mile</div>
                                <div class="text-xs rate-trend-up">↗ +$0.15 today</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-4 bg-gradient-to-r from-purple-50 to-purple-100 rounded-lg">
                            <div>
                                <div class="font-medium">Miami, FL → New York, NY</div>
                                <div class="text-sm text-gray-600">1,280 miles • Reefer</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-purple-600 text-lg">$3.00/mile</div>
                                <div class="text-xs rate-trend-down">↘ -$0.02 today</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-trending-up mr-2 text-blue-600"></i>Market Trends (Real-time)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 border-l-4 border-green-500 bg-green-50">
                            <div>
                                <div class="font-medium">Van Rates</div>
                                <div class="text-sm text-gray-600">Dry Van Equipment</div>
                            </div>
                            <div class="text-right">
                                <div class="text-green-600 font-bold text-lg">↗ +2.5%</div>
                                <div class="text-xs text-gray-500">vs last week</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 border-l-4 border-blue-500 bg-blue-50">
                            <div>
                                <div class="font-medium">Flatbed Rates</div>
                                <div class="text-sm text-gray-600">Flatbed Equipment</div>
                            </div>
                            <div class="text-right">
                                <div class="text-blue-600 font-bold text-lg">↗ +1.8%</div>
                                <div class="text-xs text-gray-500">vs last week</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 border-l-4 border-red-500 bg-red-50">
                            <div>
                                <div class="font-medium">Reefer Rates</div>
                                <div class="text-sm text-gray-600">Refrigerated Equipment</div>
                            </div>
                            <div class="text-right">
                                <div class="text-red-600 font-bold text-lg">↘ -0.5%</div>
                                <div class="text-xs text-gray-500">vs last week</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-3 border-l-4 border-purple-500 bg-purple-50">
                            <div>
                                <div class="font-medium">Load Volume</div>
                                <div class="text-sm text-gray-600">Total Available Loads</div>
                            </div>
                            <div class="text-right">
                                <div class="text-purple-600 font-bold text-lg">↗ +5.2%</div>
                                <div class="text-xs text-gray-500">vs last week</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Charts -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-chart-area mr-2 text-purple-600"></i>Rate History & Forecasting
                </h3>
                <canvas id="liveRateChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    <!-- Marketplace Page -->
    <div id="marketplace" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8 relative">
            <!-- Background truck convoy -->
            <div class="absolute top-0 right-0 opacity-5">
                <svg width="500" height="200" viewBox="0 0 500 200">
                    <!-- Truck convoy illustration -->
                    <g transform="translate(50,80)">
                        <!-- Lead truck -->
                        <rect x="0" y="20" width="80" height="30" rx="4" fill="#3b82f6"/>
                        <rect x="85" y="15" width="35" height="35" rx="6" fill="#1e40af"/>
                        <circle cx="20" cy="55" r="8" fill="#374151"/>
                        <circle cx="60" cy="55" r="8" fill="#374151"/>
                        <circle cx="102" cy="55" r="6" fill="#374151"/>
                        <circle cx="112" cy="55" r="6" fill="#374151"/>
                        
                        <!-- Following truck -->
                        <g transform="translate(150,5)">
                            <rect x="0" y="20" width="70" height="25" rx="3" fill="#10b981"/>
                            <rect x="75" y="18" width="30" height="27" rx="5" fill="#059669"/>
                            <circle cx="18" cy="50" r="7" fill="#374151"/>
                            <circle cx="52" cy="50" r="7" fill="#374151"/>
                            <circle cx="90" cy="50" r="5" fill="#374151"/>
                            <circle cx="98" cy="50" r="5" fill="#374151"/>
                        </g>
                        
                        <!-- Third truck -->
                        <g transform="translate(280,10)">
                            <rect x="0" y="18" width="75" height="22" rx="3" fill="#f59e0b"/>
                            <rect x="80" y="16" width="32" height="24" rx="4" fill="#d97706"/>
                            <circle cx="19" cy="45" r="6" fill="#374151"/>
                            <circle cx="56" cy="45" r="6" fill="#374151"/>
                            <circle cx="96" cy="45" r="5" fill="#374151"/>
                            <circle cx="104" cy="45" r="5" fill="#374151"/>
                        </g>
                    </g>
                </svg>
            </div>
            
            <div class="text-center mb-8 relative z-10">
                <!-- Marketplace icon with trucks -->
                <div class="mb-4 flex justify-center">
                    <svg width="80" height="80" viewBox="0 0 80 80">
                        <rect x="10" y="10" width="60" height="50" rx="8" fill="#3b82f6" opacity="0.1"/>
                        <rect x="15" y="15" width="50" height="40" rx="5" fill="#3b82f6" opacity="0.2"/>
                        
                        <!-- Store front -->
                        <rect x="20" y="25" width="40" height="25" rx="3" fill="#1e40af"/>
                        <rect x="25" y="30" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="37" y="30" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="49" y="30" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="31" y="42" width="8" height="8" rx="1" fill="#fbbf24"/>
                        
                        <!-- Small trucks around store -->
                        <g transform="translate(5,55)">
                            <rect x="0" y="0" width="15" height="6" rx="1" fill="#10b981"/>
                            <rect x="16" y="-1" width="6" height="7" rx="1" fill="#059669"/>
                            <circle cx="4" cy="8" r="2" fill="#374151"/>
                            <circle cx="11" cy="8" r="2" fill="#374151"/>
                            <circle cx="19" cy="8" r="1.5" fill="#374151"/>
                        </g>
                        
                        <g transform="translate(55,55)">
                            <rect x="0" y="0" width="15" height="6" rx="1" fill="#ef4444"/>
                            <rect x="16" y="-1" width="6" height="7" rx="1" fill="#dc2626"/>
                            <circle cx="4" cy="8" r="2" fill="#374151"/>
                            <circle cx="11" cy="8" r="2" fill="#374151"/>
                            <circle cx="19" cy="8" r="1.5" fill="#374151"/>
                        </g>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold">Freight Marketplace</h1>
                <p class="text-gray-600">Everything you need to run your transportation business</p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8">
                <!-- Services -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-handshake mr-2 text-blue-600"></i>Services
                    </h3>
                    <div class="space-y-3">
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-credit-card mr-2 text-green-600"></i>
                                <div class="font-medium">Freight Factoring</div>
                            </div>
                            <div class="text-sm text-gray-600">Get paid faster with our factoring partners</div>
                            <div class="text-xs text-blue-600 mt-1">Starting at 1.5% fee</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                                <div class="font-medium">Insurance Services</div>
                            </div>
                            <div class="text-sm text-gray-600">Commercial truck insurance quotes</div>
                            <div class="text-xs text-blue-600 mt-1">Get quotes in minutes</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-gas-pump mr-2 text-orange-600"></i>
                                <div class="font-medium">Fuel Cards</div>
                            </div>
                            <div class="text-sm text-gray-600">Save on fuel with fleet fuel cards</div>
                            <div class="text-xs text-blue-600 mt-1">Up to 50¢/gallon savings</div>
                        </div>
                    </div>
                </div>

                <!-- Equipment -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-truck mr-2 text-green-600"></i>Equipment
                    </h3>
                    <div class="space-y-3">
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-truck mr-2 text-blue-600"></i>
                                <div class="font-medium">Trucks for Sale</div>
                            </div>
                            <div class="text-sm text-gray-600">Browse available trucks and trailers</div>
                            <div class="text-xs text-blue-600 mt-1">1,247 listings available</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-calendar-alt mr-2 text-purple-600"></i>
                                <div class="font-medium">Equipment Rental</div>
                            </div>
                            <div class="text-sm text-gray-600">Short-term equipment rentals</div>
                            <div class="text-xs text-blue-600 mt-1">Daily, weekly, monthly rates</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-wrench mr-2 text-red-600"></i>
                                <div class="font-medium">Parts & Maintenance</div>
                            </div>
                            <div class="text-sm text-gray-600">Find parts and service locations</div>
                            <div class="text-xs text-blue-600 mt-1">24/7 roadside assistance</div>
                        </div>
                    </div>
                </div>

                <!-- Technology -->
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-laptop mr-2 text-purple-600"></i>Technology
                    </h3>
                    <div class="space-y-3">
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-tachometer-alt mr-2 text-green-600"></i>
                                <div class="font-medium">ELD Solutions</div>
                            </div>
                            <div class="text-sm text-gray-600">Electronic logging devices</div>
                            <div class="text-xs text-blue-600 mt-1">Professional platform</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-satellite mr-2 text-blue-600"></i>
                                <div class="font-medium">Fleet Management</div>
                            </div>
                            <div class="text-sm text-gray-600">GPS tracking and fleet optimization</div>
                            <div class="text-xs text-blue-600 mt-1">Real-time monitoring</div>
                        </div>
                        <div class="p-4 border rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                            <div class="flex items-center mb-2">
                                <i class="fas fa-route mr-2 text-orange-600"></i>
                                <div class="font-medium">Load Planning</div>
                            </div>
                            <div class="text-sm text-gray-600">Route optimization software</div>
                            <div class="text-xs text-blue-600 mt-1">Save 15% on fuel costs</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reports Page -->
    <div id="reports" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8">
            <div class="text-center mb-8">
                <i class="fas fa-chart-bar text-4xl text-blue-600 mb-4"></i>
                <h1 class="text-3xl font-bold">Market Reports & Analytics</h1>
                <p class="text-gray-600">Comprehensive market intelligence and business insights</p>
                <div class="real-time-indicator mx-auto mt-2">Live Data Feed</div>
            </div>
            
            <div class="grid lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-line mr-2 text-green-600"></i>Rate Trends (Live)
                    </h3>
                    <canvas id="rateChart" width="400" height="200"></canvas>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-2 text-blue-600"></i>Load Volume (Live)
                    </h3>
                    <canvas id="volumeChart" width="400" height="200"></canvas>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <h3 class="text-xl font-semibold mb-6 flex items-center">
                    <i class="fas fa-brain mr-2 text-purple-600"></i>Market Intelligence Dashboard
                </h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-lg">
                        <div class="text-3xl font-bold text-green-600 mb-2">↗ 5.2%</div>
                        <div class="text-sm text-gray-600 mb-1">Van Rates</div>
                        <div class="text-xs text-green-600">Weekly Change</div>
                    </div>
                    <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg">
                        <div class="text-3xl font-bold text-blue-600 mb-2">2.1:1</div>
                        <div class="text-sm text-gray-600 mb-1">Load-to-Truck</div>
                        <div class="text-xs text-blue-600">Current Ratio</div>
                    </div>
                    <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg">
                        <div class="text-3xl font-bold text-purple-600 mb-2">$3.85</div>
                        <div class="text-sm text-gray-600 mb-1">Avg Diesel</div>
                        <div class="text-xs text-purple-600">Per Gallon</div>
                    </div>
                    <div class="text-center p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg">
                        <div class="text-3xl font-bold text-orange-600 mb-2">847ms</div>
                        <div class="text-sm text-gray-600 mb-1">Avg Response</div>
                        <div class="text-xs text-orange-600">Load Booking</div>
                    </div>
                </div>
            </div>

            <!-- Regional Analysis -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <i class="fas fa-map-marked-alt mr-2 text-red-600"></i>Regional Market Analysis
                </h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="p-4 border-l-4 border-blue-500 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-2">Northeast</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Avg Rate:</span>
                                <span class="font-medium">$2.95/mile</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Load Volume:</span>
                                <span class="font-medium text-green-600">↗ High</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Capacity:</span>
                                <span class="font-medium text-orange-600">Tight</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-l-4 border-green-500 bg-green-50">
                        <h4 class="font-semibold text-green-800 mb-2">Southeast</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Avg Rate:</span>
                                <span class="font-medium">$2.78/mile</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Load Volume:</span>
                                <span class="font-medium text-green-600">↗ High</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Capacity:</span>
                                <span class="font-medium text-green-600">Balanced</span>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 border-l-4 border-purple-500 bg-purple-50">
                        <h4 class="font-semibold text-purple-800 mb-2">West Coast</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex justify-between">
                                <span>Avg Rate:</span>
                                <span class="font-medium">$3.12/mile</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Load Volume:</span>
                                <span class="font-medium text-blue-600">↔ Moderate</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Capacity:</span>
                                <span class="font-medium text-red-600">Very Tight</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- User Profile Page -->
    <div id="profile" class="page hidden">
        <div class="max-w-6xl mx-auto px-4 py-8">
            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <!-- Profile Header -->
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-8 py-8">
                    <div class="flex items-center space-x-6">
                        <div id="profileAvatar" class="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-lg">
                            <div id="profileInitials" class="w-20 h-20 rounded-full bg-white text-black flex items-center justify-center font-bold text-2xl border-2 border-white/20">US</div>
                        </div>
                        <div class="text-white">
                            <h1 class="text-3xl font-bold" id="profileName">User Profile</h1>
                            <p class="text-blue-100 text-lg" id="profileEmail">user@example.com</p>
                            <p class="text-blue-200 text-lg" id="profileCompany">Company Name</p>
                            <div class="flex items-center space-x-4 mt-2">
                                <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">
                                    Account: <span id="profileAccountType">Free</span>
                                </span>
                                <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">
                                    Role: <span id="profileRole">User</span>
                                </span>
                                <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">
                                    Member since: <span id="profileMemberSince">-</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="p-8">
                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Account Information (Read-Only) -->
                        <div>
                            <div class="flex items-center justify-between mb-6">
                                <h3 class="text-xl font-semibold text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-user mr-2 text-blue-600"></i>Account Information
                                </h3>
                                <div class="flex space-x-3">
                                    <button onclick="openProfileModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors">
                                        <i class="fas fa-edit mr-2"></i>Edit Profile
                                        </button>
                                </div>
                            </div>
                            <div class="space-y-5">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Company Name</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profileCompanyDisplay">-</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profileUsernameDisplay">-</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profileEmailDisplay">-</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profilePhoneDisplay">-</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">USDOT Number</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profileUSDOTDisplay">-</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">MC Number</label>
                                    <div class="w-full px-4 py-3 border-2 border-gray-200 rounded-lg bg-gray-50 text-gray-800" id="profileMCDisplay">-</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Details & Statistics -->
                        <div class="space-y-6">
                            <!-- Account Details -->
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>Account Details
                                </h3>
                                <div class="bg-gray-50 rounded-lg p-6 space-y-4">
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">Account Type:</span>
                                        <span class="font-semibold text-blue-600" id="profileAccountTypeDisplay">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">User Role:</span>
                                        <span class="font-semibold text-purple-600" id="profileRoleDisplay">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">Registration Date:</span>
                                        <span class="font-semibold text-gray-800" id="profileRegistrationDate">-</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-gray-600 font-medium">Last Updated:</span>
                                        <span class="font-semibold text-gray-800" id="profileLastUpdated">-</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Account Statistics -->
                            <div>
                                <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b border-gray-200 pb-2">
                                    <i class="fas fa-chart-bar mr-2 text-orange-600"></i>Account Statistics
                                </h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-blue-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-blue-600" id="userLoadsPosted">0</div>
                                        <div class="text-sm text-gray-600">Loads Posted</div>
                                    </div>
                                    <div class="bg-green-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-green-600" id="userLoadsBooked">0</div>
                                        <div class="text-sm text-gray-600">Loads Booked</div>
                                    </div>
                                    <div class="bg-purple-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-purple-600" id="userTotalRevenue">$0</div>
                                        <div class="text-sm text-gray-600">Total Revenue</div>
                                    </div>
                                    <div class="bg-orange-50 p-4 rounded-lg text-center">
                                        <div class="text-2xl font-bold text-orange-600" id="userRating">5.0</div>
                                        <div class="text-sm text-gray-600">User Rating</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Directory Page -->
    <div id="directory" class="page hidden">
        <div class="max-w-7xl mx-auto px-4 py-8 relative overflow-hidden">
            <!-- Background fleet illustration -->
            <div class="absolute left-0 top-0 opacity-5">
                <svg width="600" height="400" viewBox="0 0 600 400">
                    <!-- Professional truck fleet -->
                    <g transform="translate(50,150)">
                        <!-- Row 1 - Different truck types -->
                        <g transform="translate(0,0)">
                            <!-- Van truck -->
                            <rect x="0" y="20" width="80" height="25" rx="3" fill="#3b82f6"/>
                            <rect x="85" y="15" width="30" height="30" rx="5" fill="#1e40af"/>
                            <circle cx="20" cy="50" r="6" fill="#374151"/>
                            <circle cx="60" cy="50" r="6" fill="#374151"/>
                            <circle cx="100" cy="50" r="5" fill="#374151"/>
                            <circle cx="108" cy="50" r="5" fill="#374151"/>
                        </g>
                        
                        <g transform="translate(150,0)">
                            <!-- Flatbed truck -->
                            <rect x="0" y="25" width="90" height="15" rx="2" fill="#10b981"/>
                            <rect x="95" y="15" width="32" height="30" rx="5" fill="#059669"/>
                            <circle cx="22" cy="50" r="6" fill="#374151"/>
                            <circle cx="68" cy="50" r="6" fill="#374151"/>
                            <circle cx="111" cy="50" r="5" fill="#374151"/>
                            <circle cx="119" cy="50" r="5" fill="#374151"/>
                            <!-- Load on flatbed -->
                            <rect x="10" y="15" width="25" height="10" rx="1" fill="#f59e0b" opacity="0.8"/>
                            <rect x="40" y="15" width="25" height="10" rx="1" fill="#ef4444" opacity="0.8"/>
                        </g>
                        
                        <g transform="translate(300,0)">
                            <!-- Reefer truck -->
                            <rect x="0" y="20" width="85" height="25" rx="3" fill="#06b6d4"/>
                            <rect x="90" y="15" width="30" height="30" rx="5" fill="#0891b2"/>
                            <circle cx="21" cy="50" r="6" fill="#374151"/>
                            <circle cx="64" cy="50" r="6" fill="#374151"/>
                            <circle cx="105" cy="50" r="5" fill="#374151"/>
                            <circle cx="113" cy="50" r="5" fill="#374151"/>
                            <!-- Reefer unit -->
                            <rect x="5" y="22" width="8" height="8" rx="1" fill="#0ea5e9"/>
                        </g>
                        
                        <!-- Row 2 -->
                        <g transform="translate(0,80)">
                            <!-- Container truck -->
                            <rect x="0" y="20" width="75" height="25" rx="3" fill="#8b5cf6"/>
                            <rect x="80" y="15" width="28" height="30" rx="5" fill="#7c3aed"/>
                            <circle cx="19" cy="50" r="6" fill="#374151"/>
                            <circle cx="56" cy="50" r="6" fill="#374151"/>
                            <circle cx="94" cy="50" r="5" fill="#374151"/>
                            <circle cx="102" cy="50" r="5" fill="#374151"/>
                            <!-- Container details -->
                            <rect x="8" y="25" width="59" height="15" rx="1" fill="#a78bfa" opacity="0.4"/>
                        </g>
                        
                        <g transform="translate(150,80)">
                            <!-- Tanker truck -->
                            <ellipse cx="45" cy="32" rx="45" ry="12" fill="#ef4444"/>
                            <rect x="90" y="15" width="28" height="30" rx="5" fill="#dc2626"/>
                            <circle cx="20" cy="50" r="6" fill="#374151"/>
                            <circle cx="70" cy="50" r="6" fill="#374151"/>
                            <circle cx="104" cy="50" r="5" fill="#374151"/>
                            <circle cx="112" cy="50" r="5" fill="#374151"/>
                        </g>
                        
                        <g transform="translate(300,80)">
                            <!-- Car carrier -->
                            <rect x="0" y="15" width="90" height="8" rx="2" fill="#f59e0b"/>
                            <rect x="0" y="30" width="90" height="8" rx="2" fill="#f59e0b"/>
                            <rect x="95" y="15" width="28" height="30" rx="5" fill="#d97706"/>
                            <circle cx="22" cy="50" r="6" fill="#374151"/>
                            <circle cx="68" cy="50" r="6" fill="#374151"/>
                            <circle cx="109" cy="50" r="5" fill="#374151"/>
                            <circle cx="117" cy="50" r="5" fill="#374151"/>
                            <!-- Cars on carrier -->
                            <rect x="10" y="10" width="15" height="6" rx="1" fill="#3b82f6" opacity="0.7"/>
                            <rect x="30" y="10" width="15" height="6" rx="1" fill="#10b981" opacity="0.7"/>
                            <rect x="50" y="10" width="15" height="6" rx="1" fill="#ef4444" opacity="0.7"/>
                        </g>
                    </g>
                </svg>
            </div>
            
            <div class="text-center mb-8 relative z-10">
                <!-- Directory icon with professional truck -->
                <div class="mb-4 flex justify-center">
                    <svg width="80" height="80" viewBox="0 0 80 80">
                        <rect x="10" y="10" width="60" height="50" rx="8" fill="#3b82f6" opacity="0.1"/>
                        <rect x="15" y="15" width="50" height="40" rx="5" fill="#3b82f6" opacity="0.2"/>
                        
                        <!-- Directory book -->
                        <rect x="20" y="20" width="40" height="30" rx="3" fill="#1e40af"/>
                        <rect x="25" y="25" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="37" y="25" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="49" y="25" width="8" height="8" rx="1" fill="#93c5fd"/>
                        <rect x="31" y="42" width="8" height="8" rx="1" fill="#fbbf24"/>
                        
                        <!-- Lines representing directory entries -->
                        <line x1="28" y1="30" x2="52" y2="30" stroke="#3b82f6" stroke-width="1"/>
                        <line x1="28" y1="34" x2="48" y2="34" stroke="#6b7280" stroke-width="1"/>
                        <line x1="28" y1="38" x2="50" y2="38" stroke="#6b7280" stroke-width="1"/>
                        <line x1="28" y1="42" x2="45" y2="42" stroke="#6b7280" stroke-width="1"/>
                        
                        <!-- Professional truck on directory -->
                        <g transform="translate(25,55)">
                            <rect x="0" y="0" width="20" height="8" rx="1" fill="#3b82f6"/>
                            <rect x="22" y="-2" width="8" height="10" rx="2" fill="#1e40af"/>
                            <circle cx="5" cy="12" r="2.5" fill="#374151"/>
                            <circle cx="15" cy="12" r="2.5" fill="#374151"/>
                            <circle cx="26" cy="12" r="2" fill="#374151"/>
                            <rect x="24" y="2" width="2" height="2" rx="0.5" fill="#fbbf24"/>
                        </g>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold">Carrier Directory</h1>
                <p class="text-gray-600">Find and connect with verified transportation providers</p>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="grid md:grid-cols-5 gap-4">
                    <input type="text" placeholder="Company Name" class="px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" placeholder="City, State" class="px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <select class="px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option>All Equipment</option>
                        <option>Van</option>
                        <option>Flatbed</option>
                        <option>Reefer</option>
                        <option>Step Deck</option>
                        <option>Lowboy</option>
                        <option>Tanker</option>
                    </select>
                    <select class="px-3 py-2 border rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option>All Ratings</option>
                        <option>5 Stars</option>
                        <option>4+ Stars</option>
                        <option>3+ Stars</option>
                    </select>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md transition-colors">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h3 class="text-lg font-semibold flex items-center">
                            <i class="fas fa-users-cog mr-2 text-blue-600"></i>User Management
                        </h3>
                        <div class="text-sm text-gray-600">Showing 1-10 of 1,247 carriers</div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">USDOT</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MC Number</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userManagementList" class="bg-white divide-y divide-gray-200">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin" class="page hidden">
        <div class="max-w-screen-2xl mx-auto px-6 py-6">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800"><i class="fas fa-shield-alt mr-3 text-yellow-600"></i>Admin Dashboard</h2>
                    <div class="space-x-3">
                        <button onclick="exportUsersCSV()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                            <i class="fas fa-download mr-2"></i>Export Users (CSV)
                        </button>
                        <button id="toggleRawUsersBtn" onclick="toggleRawUsers()" class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg font-semibold transition-colors">
                            <i class="fas fa-code mr-2"></i>Show Raw Data
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Company</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Email</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Account Type</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Password</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">USDOT</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">MC</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Verified</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Role</th>
                                <th class="px-8 py-4 text-left text-sm font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminUsersTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
                <pre id="adminRawUsers" class="mt-6 p-6 bg-gray-50 rounded-lg text-sm overflow-auto hidden" style="max-height:400px;white-space:pre-wrap;font-family: 'Courier New', monospace;"></pre>
            </div>
        </div>
    </div>

    <!-- Load Details Modal -->
    <div id="loadDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-screen overflow-y-auto">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold" id="modalLoadId">Load Details</h2>
                    <button onclick="closeLoadDetails()" class="text-white hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Load Information</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Origin:</span>
                                <span class="font-medium" id="modalOrigin">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Destination:</span>
                                <span class="font-medium" id="modalDestination">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Equipment:</span>
                                <span class="font-medium" id="modalEquipment">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Distance:</span>
                                <span class="font-medium" id="modalMiles">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Weight:</span>
                                <span class="font-medium" id="modalWeight">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Commodity:</span>
                                <span class="font-medium" id="modalCommodity">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rate:</span>
                                <span class="font-medium text-green-600" id="modalRate">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Rate per Mile:</span>
                                <span class="font-medium" id="modalRatePerMile">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-semibold mb-4">Contact Information</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Company:</span>
                                <span class="font-medium" id="loadModalCompany">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Contact Person:</span>
                                <span class="font-medium" id="loadModalContact">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Phone:</span>
                                <span class="font-medium" id="loadModalPhone">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Email:</span>
                                <span class="font-medium" id="loadModalEmail">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Pickup Date:</span>
                                <span class="font-medium" id="modalPickupDate">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Delivery Date:</span>
                                <span class="font-medium" id="modalDeliveryDate">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Posted:</span>
                                <span class="font-medium" id="modalPosted">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-4">Special Requirements</h3>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p id="modalRequirements" class="text-gray-700">No special requirements</p>
                    </div>
                </div>
                
                <div class="mt-8 flex justify-end space-x-4">
                    <button onclick="closeLoadDetails()" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                        Close
                    </button>
                    <button onclick="bookLoadFromModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors">
                        <i class="fas fa-handshake mr-2"></i>Book This Load
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Notification Container -->
    <div id="notifications"></div>

    <!-- Email Verification Modal -->
    <div id="verificationModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8 relative">
            <button type="button" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600" onclick="hideVerificationModal()">
                <i class="fas fa-times text-xl"></i>
            </button>
            <div class="text-center mb-6">
                <div class="mx-auto mb-4 w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                    <i class="fas fa-envelope-open-text text-2xl"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900">Enter Verification Code</h3>
                <p class="text-sm text-gray-500 mt-1">We emailed a 6-digit code to <span id="verificationEmailDisplay" class="font-semibold"></span></p>
            </div>

            <form id="verificationForm" class="space-y-5">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Email Address</label>
                    <input type="email" id="verificationEmail" required placeholder="your.email@company.com"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" />
                </div>

                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">Verification Code</label>
                    <input type="text" id="verificationCode" required maxlength="6" pattern="[0-9]{6}"
                        placeholder="Enter 6-digit code"
                        class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl tracking-widest text-center text-lg font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition" />
                    <p class="text-xs text-gray-500" id="verificationCodeHint">Code is valid for 24 hours.</p>
                </div>

                <div class="space-y-3">
                    <button type="submit" class="w-full py-3 bg-blue-600 text-white rounded-xl font-semibold hover:bg-blue-700 transition">
                        Verify Email
                    </button>
                    <button type="button" class="w-full py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition" onclick="resendVerificationCode()">
                        Resend Code
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // Global variables
        let currentUser = null;
        // Dynamic Load System - Generate 1000+ realistic loads
        // Optimized load generation with memory efficiency
        const CITY_POOL = [
                { name: 'Chicago, IL', lat: 41.8781, lng: -87.6298 },
                { name: 'Atlanta, GA', lat: 33.7490, lng: -84.3880 },
                { name: 'Los Angeles, CA', lat: 34.0522, lng: -118.2437 },
                { name: 'Phoenix, AZ', lat: 33.4484, lng: -112.0740 },
                { name: 'Miami, FL', lat: 25.7617, lng: -80.1918 },
                { name: 'New York, NY', lat: 40.7128, lng: -74.0060 },
                { name: 'Dallas, TX', lat: 32.7767, lng: -96.7970 },
                { name: 'Denver, CO', lat: 39.7392, lng: -104.9903 },
                { name: 'Seattle, WA', lat: 47.6062, lng: -122.3321 },
                { name: 'Portland, OR', lat: 45.5152, lng: -122.6784 },
                { name: 'Houston, TX', lat: 29.7604, lng: -95.3698 },
                { name: 'San Antonio, TX', lat: 29.4241, lng: -98.4936 },
                { name: 'Salt Lake City, UT', lat: 40.7608, lng: -111.8910 },
                { name: 'Boston, MA', lat: 42.3601, lng: -71.0589 },
                { name: 'Kansas City, MO', lat: 39.0997, lng: -94.5786 },
                { name: 'St. Louis, MO', lat: 38.6270, lng: -90.1994 },
                { name: 'Nashville, TN', lat: 36.1627, lng: -86.7816 },
                { name: 'Memphis, TN', lat: 35.1495, lng: -90.0490 },
                { name: 'Minneapolis, MN', lat: 44.9778, lng: -93.2650 },
                { name: 'Milwaukee, WI', lat: 43.0389, lng: -87.9065 },
                { name: 'San Francisco, CA', lat: 37.7749, lng: -122.4194 },
                { name: 'Sacramento, CA', lat: 38.5816, lng: -121.4944 },
                { name: 'Cleveland, OH', lat: 41.4993, lng: -81.6944 },
                { name: 'Detroit, MI', lat: 42.3314, lng: -83.0458 },
                { name: 'Tampa, FL', lat: 27.9506, lng: -82.4572 },
                { name: 'Jacksonville, FL', lat: 30.3322, lng: -81.6557 },
                { name: 'Las Vegas, NV', lat: 36.1699, lng: -115.1398 },
                { name: 'Pittsburgh, PA', lat: 40.4406, lng: -79.9959 },
                { name: 'Philadelphia, PA', lat: 39.9526, lng: -75.1652 },
                { name: 'Austin, TX', lat: 30.2672, lng: -97.7431 },
                { name: 'Charlotte, NC', lat: 35.2271, lng: -80.8431 },
                { name: 'Raleigh, NC', lat: 35.7796, lng: -78.6382 },
                { name: 'Indianapolis, IN', lat: 39.7684, lng: -86.1581 },
                { name: 'Columbus, OH', lat: 39.9612, lng: -82.9988 },
                { name: 'Oklahoma City, OK', lat: 35.4676, lng: -97.5164 },
                { name: 'Albuquerque, NM', lat: 35.0844, lng: -106.6504 },
                { name: 'Louisville, KY', lat: 38.2527, lng: -85.7585 },
                { name: 'Cincinnati, OH', lat: 39.1031, lng: -84.5120 },
                { name: 'Birmingham, AL', lat: 33.5207, lng: -86.8025 },
                { name: 'Mobile, AL', lat: 30.6954, lng: -88.0399 },
                { name: 'Richmond, VA', lat: 37.5407, lng: -77.4360 },
                { name: 'Norfolk, VA', lat: 36.8468, lng: -76.2852 },
                { name: 'Spokane, WA', lat: 47.6588, lng: -117.4260 },
                { name: 'Boise, ID', lat: 43.6150, lng: -116.2023 }
            ];

        // (Old inlined generateDynamicLoads implementation removed in favor of optimized version below)

        // Helper functions for smart filtering
        function getRegion(city) {
            const regions = {
                'West': ['Los Angeles', 'San Francisco', 'Sacramento', 'Seattle', 'Portland', 'Las Vegas', 'Spokane', 'Boise'],
                'Southwest': ['Phoenix', 'Dallas', 'Houston', 'San Antonio', 'Austin', 'Oklahoma City', 'Albuquerque'],
                'Southeast': ['Atlanta', 'Miami', 'Tampa', 'Jacksonville', 'Nashville', 'Memphis', 'Charlotte', 'Raleigh', 'Birmingham', 'Mobile'],
                'Northeast': ['New York', 'Boston', 'Philadelphia', 'Pittsburgh', 'Cleveland', 'Detroit', 'Richmond', 'Norfolk'],
                'Midwest': ['Chicago', 'Kansas City', 'St. Louis', 'Minneapolis', 'Milwaukee', 'Indianapolis', 'Columbus', 'Louisville', 'Cincinnati'],
                'Mountain': ['Denver', 'Salt Lake City']
            };
            
            for (const [region, cities] of Object.entries(regions)) {
                if (cities.some(c => city.includes(c))) return region;
            }
            return 'Other';
        }

        function getEquipmentCategory(equipment) {
            const categories = {
                'Dry': ['Van', 'Container'],
                'Refrigerated': ['Reefer'],
                'Specialized': ['Flatbed', 'Tanker']
            };
            
            for (const [category, types] of Object.entries(categories)) {
                if (types.includes(equipment)) return category;
            }
            return 'Other';
        }

        function getRateCategory(ratePerMile) {
            if (ratePerMile < 2.5) return 'Low';
            if (ratePerMile < 3.5) return 'Medium';
            if (ratePerMile < 4.5) return 'High';
            return 'Premium';
        }

        function getDistanceCategory(miles) {
            if (miles < 200) return 'Short';
            if (miles < 500) return 'Medium';
            if (miles < 1000) return 'Long';
            return 'Cross-Country';
        }

        // Advanced memory cleanup function
        function cleanupMemory() {
            // Clear old data that's no longer needed
            if (loads.length > MAX_LOADS) {
                loads = loads.slice(-MAX_LOADS);
                filteredLoads = [...loads];
                window.loads = loads;
            }
            
            // Clear old performance data
            if (performanceMonitor.responseTimes.length > 20) {
                performanceMonitor.responseTimes = performanceMonitor.responseTimes.slice(-10);
            }
            
            // Clear DOM element cache if it gets too large (safe global reference)
            if (globalThis.domCache && globalThis.domCache.liveStats) {
                const keys = Object.keys(globalThis.domCache.liveStats);
                if (keys.length > 0) {
                    keys.forEach(key => {
                        const el = globalThis.domCache.liveStats[key];
                        if (el && !document.contains(el)) {
                            globalThis.domCache.liveStats[key] = null;
                        }
                    });
                }
            }
            
            // Clear old API cache data
            Object.keys(apiCache).forEach(key => {
                if (apiCache[key] && apiCache[key].data) {
                    const age = Date.now() - apiCache[key].timestamp;
                    if (age > apiCache[key].ttl * 2) { // Clear if 2x older than TTL
                        apiCache[key].data = null;
                    }
                }
            });
            
            // Force garbage collection hint (if available)
            if (window.gc) {
                window.gc();
            }
        }
        
        // Optimized load generation function
        function generateDynamicLoads(count = 100) {
            const loads = [];
            const startTime = Date.now();
            
            for (let i = 0; i < count; i++) {
                const origin = CITY_POOL[Math.floor(Math.random() * CITY_POOL.length)];
                let destination;
                do {
                    destination = CITY_POOL[Math.floor(Math.random() * CITY_POOL.length)];
                } while (destination.name === origin.name);
                
                const miles = Math.floor(Math.random() * 2000) + 50;
                const rate = Math.floor(Math.random() * 3000) + 800;
                
                loads.push({
                    id: `FCP-${(i + 1).toString().padStart(3, '0')}`,
                    origin: origin.name,
                    destination: destination.name,
                    miles: miles,
                    rate: rate,
                    equipment: ['Dry Van', 'Reefer', 'Flatbed', 'Container'][Math.floor(Math.random() * 4)],
                    weight: Math.floor(Math.random() * 40000) + 10000,
                    pickupDate: new Date(Date.now() + Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    status: 'available'
                });
            }
            
            const generationTime = Date.now() - startTime;
            console.log(`Generated ${count} loads in ${generationTime}ms`);
            return loads;
        }
        
        // Load management with memory optimization
        const MAX_LOADS = 500; // Maximum loads to prevent memory issues

        // Generate the dynamic loads (optimized for memory)
        const sampleLoads = generateDynamicLoads(MAX_LOADS);

        const normalizedSampleLoads = Array.isArray(sampleLoads)
            ? sampleLoads.map(normalizeLoad).filter(Boolean)
            : [];
        
        // Initialize with limited loads
        let loads = [...normalizedSampleLoads.slice(0, MAX_LOADS)];
        let filteredLoads = [...loads];
        let bookedLoads = [];
        let loadRefreshCounter = 0; // Track refresh cycles
        let users = JSON.parse(localStorage.getItem('users') || '[]');
        let savedSearches = [];
        let currentPage = 1;
        let autoRefreshEnabled = false;
        let autoRefreshInterval = null;
        let loadGenerationInterval = null;
        let currentViewMode = 'list';
        let currentLoadDetails = null;

        // Smart filtering and booking simulation
        let userPreferences = {
            preferredRegions: [],
            preferredEquipment: [],
            preferredRateRange: { min: 0, max: 10 },
            preferredDistance: { min: 0, max: 2000 },
            lastSearchFilters: {}
        };

        // Load user preferences from localStorage
        const savedPreferences = localStorage.getItem('userPreferences');
        if (savedPreferences) {
            userPreferences = { ...userPreferences, ...JSON.parse(savedPreferences) };
        }

        const MC_PHASEOUT_DATE = new Date('2025-10-01T00:00:00Z');

        function isMcStillRequired() {
            return new Date() < MC_PHASEOUT_DATE;
        }

        // Sample cities for smart suggestions
        const cities = [
            'Chicago, IL', 'Atlanta, GA', 'Los Angeles, CA', 'Phoenix, AZ', 'Miami, FL', 'New York, NY',
            'Dallas, TX', 'Denver, CO', 'Seattle, WA', 'Portland, OR', 'Houston, TX', 'Memphis, TN',
            'Detroit, MI', 'Indianapolis, IN', 'Nashville, TN', 'Charlotte, NC', 'Jacksonville, FL',
            'Tampa, FL', 'Orlando, FL', 'Kansas City, MO', 'St. Louis, MO', 'Minneapolis, MN',
            'Milwaukee, WI', 'Cleveland, OH', 'Cincinnati, OH', 'Columbus, OH', 'Pittsburgh, PA',
            'Philadelphia, PA', 'Baltimore, MD', 'Washington, DC', 'Richmond, VA', 'Norfolk, VA',
            'Raleigh, NC', 'Charleston, SC', 'Savannah, GA', 'Birmingham, AL', 'Mobile, AL',
            'New Orleans, LA', 'Baton Rouge, LA', 'Little Rock, AR', 'Oklahoma City, OK', 'Tulsa, OK'
        ];

        // Enhanced sample load data with more realistic information
        const commodities = ['Electronics', 'Food Products', 'Automotive Parts', 'Machinery', 'Textiles', 'Chemicals', 'Paper Products', 'Steel', 'Lumber', 'Consumer Goods'];
        const companies = ['ABC Logistics', 'XYZ Freight', 'Global Transport', 'Prime Shipping', 'Elite Cargo', 'Metro Freight', 'Swift Logistics', 'Apex Transport'];
        const contacts = ['John Smith', 'Sarah Johnson', 'Mike Davis', 'Lisa Wilson', 'Tom Brown', 'Amy Garcia', 'Chris Lee', 'Maria Rodriguez'];
        
        function generateLoadId() {
            return 'FCP-' + Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        }
        
        function generatePhoneNumber() {
            return `(${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`;
        }
        
        function generateEmail(contact, company) {
            const firstName = contact.split(' ')[0].toLowerCase();
            const companyName = company.toLowerCase().replace(/[^a-z]/g, '');
            return `${firstName}@${companyName}.com`;
        }

        // Sidebar toggle
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function getCurrentUser() {
            try {
                if (window.currentUser) {
                    currentUser = window.currentUser;
                    return window.currentUser;
                }
                const stored = localStorage.getItem('currentUser');
                const parsed = stored ? JSON.parse(stored) : null;
                if (parsed) {
                    window.currentUser = parsed;
                    currentUser = parsed;
                } else {
                    window.currentUser = null;
                    currentUser = null;
                }
                return parsed;
            } catch (error) {
                console.error('Failed to parse stored user', error);
                window.currentUser = null;
                currentUser = null;
                return null;
            }
        }

        function getAuthToken() {
            try {
                return localStorage.getItem('authToken') || '';
            } catch (error) {
                return '';
            }
        }

        function normalizeLoad(raw) {
            if (!raw) return null;
            const origin = typeof raw.origin === 'object' && raw.origin !== null ? raw.origin : {};
            const destination = typeof raw.destination === 'object' && raw.destination !== null ? raw.destination : {};
            const milesValue = Number(raw.distance ?? raw.miles ?? 0) || 0;
            const rateValue = Number(raw.rate ?? raw.rateAmount ?? 0) || 0;
            const ratePerMileValue = milesValue ? Number((rateValue / milesValue).toFixed(2)) : Number(raw.ratePerMile ?? raw.rate_per_mile ?? 0) || 0;

            return {
                id: raw._id || raw.id || generateLoadId(),
                title: raw.title || raw.description || raw.equipmentType || 'Freight Load',
                origin: origin.city ? `${origin.city}, ${origin.state}` : (raw.origin || 'Unknown'),
                destination: destination.city ? `${destination.city}, ${destination.state}` : (raw.destination || 'Unknown'),
                originDetails: {
                    city: origin.city || '',
                    state: origin.state || '',
                    zip: origin.zip || origin.postalCode || ''
                },
                destinationDetails: {
                    city: destination.city || '',
                    state: destination.state || '',
                    zip: destination.zip || destination.postalCode || ''
                },
                equipment: raw.equipmentType || raw.equipment || 'Van',
                miles: milesValue,
                rate: rateValue,
                ratePerMile: ratePerMileValue,
                pickupDate: raw.pickupDate || raw.pickup || '',
                deliveryDate: raw.deliveryDate || raw.delivery || '',
                weight: Number(raw.weight) || 0,
                loadType: raw.loadType || 'Full Truckload',
                company: raw.postedBy?.company || raw.company || 'FreightPro Network',
                contact: raw.contact || raw.postedBy?.name || 'Dispatch',
                phone: raw.phone || raw.contactPhone || 'N/A',
                email: raw.postedBy?.email || raw.email || 'support@freightpro.com',
                commodity: raw.commodity || 'General Freight',
                requirements: raw.specialRequirements || raw.requirements || 'No special requirements',
                posted: raw.createdAt ? new Date(raw.createdAt).toLocaleString() : (raw.posted || 'Just now'),
                priority: raw.priority || 'normal',
                status: raw.status || 'available',
                bookedBy: raw.bookedBy || null,
                raw
            };
        }

        let isLoadingLoads = false;

        // Advanced API caching mechanism for multiple users
        const apiCache = {
            loads: {
                data: null,
                timestamp: 0,
                ttl: 30000, // 30 seconds cache
                requestCount: 0,
                lastAccess: 0,
                userCount: 0
            },
            users: {
                data: null,
                timestamp: 0,
                ttl: 60000, // 1 minute cache
                requestCount: 0
            },
            statistics: {
                data: null,
                timestamp: 0,
                ttl: 10000, // 10 seconds cache
                requestCount: 0
            }
        };
        
        // Smart cache management
        function getCacheTTL(cacheKey) {
            const profile = performanceProfiles[userActivityLevel];
            return apiCache[cacheKey] ? profile.cacheTime : 30000;
        }
        
        function updateCacheStats(cacheKey) {
            if (apiCache[cacheKey]) {
                apiCache[cacheKey].requestCount++;
                apiCache[cacheKey].lastAccess = Date.now();
                apiCache[cacheKey].userCount = concurrentUsers;
            }
        }

        async function fetchLoadsFromBackend(query = {}) {
            const startTime = Date.now();
            const now = Date.now();
            
            // Dynamic cache TTL based on system load
            const cacheTTL = getCacheTTL('loads');
            
            // Check cache first (unless force refresh is requested)
            if (apiCache.loads.data && 
                (now - apiCache.loads.timestamp) < cacheTTL &&
                !query.forceRefresh) {
                updateCacheStats('loads');
                trackResponseTime(startTime);
                return apiCache.loads.data;
            }

            // Adjust request parameters based on system load
            const limit = userActivityLevel === 'critical' ? 25 : 
                         userActivityLevel === 'high' ? 35 : 50;
            
            const params = new URLSearchParams({ 
                limit: limit, 
                status: 'available', 
                ...query 
            });
            
            const url = `${window.API_BASE_URL}/loads?${params.toString()}`;
            const token = getAuthToken();
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            try {
                const response = await safeFetch(url, { method: 'GET', headers });
                if (!response) {
                    updateCacheStats('loads');
                    trackResponseTime(startTime);
                    return apiCache.loads.data; // Return cached data if available
                }
                
                if (response.status === 401) {
                    showNotification('Please log in to view live loads.', 'warning');
                    updateCacheStats('loads');
                    trackResponseTime(startTime);
                    return apiCache.loads.data; // Return cached data if available
                }
                
                if (!response.ok) {
                    const errText = await response.text();
                    throw new Error(errText || 'Failed to fetch loads');
                }
                
                const data = await response.json();
                if (!data || !Array.isArray(data.loads)) {
                    updateCacheStats('loads');
                    trackResponseTime(startTime);
                    return apiCache.loads.data;
                }
                
                const processedData = data.loads.map(normalizeLoad).filter(Boolean);
                
                // Update cache with new TTL
                apiCache.loads.data = processedData;
                apiCache.loads.timestamp = now;
                apiCache.loads.ttl = cacheTTL;
                updateCacheStats('loads');
                
                trackResponseTime(startTime);
                return processedData;
            } catch (error) {
                console.warn('Falling back to cached/sample loads:', error.message || error);
                updateCacheStats('loads');
                trackResponseTime(startTime);
                return apiCache.loads.data; // Return cached data if available
            }
        }

        function getLoadResultsContainer() {
            return document.getElementById('loadResults');
        }

        function setLoadingState(isLoading) {
            isLoadingLoads = isLoading;
            const container = getLoadResultsContainer();
            if (!container) return;
            if (isLoading) {
                container.innerHTML = `
                    <div class="p-8 text-center">
                        <span class="inline-flex items-center justify-center px-4 py-2 text-blue-600 bg-blue-50 rounded-full">
                            <i class="fas fa-spinner fa-spin mr-2"></i>Loading live loads...
                        </span>
                    </div>`;
            }
        }

        function updateLoadStats(loadArray) {
            const statsLoads = loadArray.length ? loadArray : normalizedSampleLoads;
            if (!statsLoads.length) return;
            const total = statsLoads.length;
            const rateSum = statsLoads.reduce((sum, item) => sum + (Number(item.rate) || 0), 0);
            const avgRate = total ? rateSum / total : 0;

            const totalElement = document.getElementById('totalLoads');
            const avgRateElement = document.getElementById('avgRate');
            const newTodayElement = document.getElementById('newToday');
            const showingCount = document.getElementById('showingCount');
            const totalCount = document.getElementById('totalCount');

            if (totalElement) totalElement.textContent = total.toLocaleString();
            if (avgRateElement) avgRateElement.textContent = `$${avgRate.toFixed(2)}`;
            if (newTodayElement) newTodayElement.textContent = Math.max(1, Math.round(total / 3)).toLocaleString();
            if (showingCount) showingCount.textContent = `1-${Math.min(loadArray.length, 20)}`;
            if (totalCount) totalCount.textContent = loadArray.length.toLocaleString();
        }

        function renderLoads(loadArray) {
            const container = getLoadResultsContainer();
            if (!container) return;

            if (!loadArray.length) {
                container.innerHTML = `
                    <div class="p-8 text-center text-gray-600">
                        <i class="fas fa-box-open text-3xl mb-3"></i>
                        <p>No loads match your filters. Try adjusting the search criteria.</p>
                    </div>`;
                updateLoadStats(loadArray);
                return;
            }

            const view = document.getElementById('viewMode')?.value || currentViewMode || 'list';
            currentViewMode = view;

            const cards = loadArray.map(load => {
                const milesValue = Number(load.miles) || 0;
                const rateValue = Number(load.rate) || 0;
                const rpmValue = Number(load.ratePerMile) || 0;
                const badge = load.priority === 'urgent' ? 'bg-red-100 text-red-700' : load.priority === 'premium' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                const statusText = load.status === 'booked' ? 'Booked' : 'Available';
                const disabled = load.status !== 'available';

                if (view === 'compact') {
                    return `
                        <div class="border-b border-gray-100 px-4 py-3 flex flex-col md:flex-row md:items-center md:justify-between hover:bg-gray-50 transition">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-800">${load.origin} → ${load.destination}</div>
                                <div class="text-sm text-gray-500">${load.equipment} • ${milesValue} mi • Pickup: ${load.pickupDate ? new Date(load.pickupDate).toLocaleDateString() : 'TBD'}</div>
                            </div>
                            <div class="mt-3 md:mt-0 md:flex md:items-center md:space-x-4">
                                <div class="text-lg font-bold text-green-600">$${rateValue.toLocaleString()}</div>
                                <button class="px-3 py-2 rounded-md ${disabled ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}" ${disabled ? 'disabled' : ''} onclick="showLoadDetails('${load.id}')">
                                    Details
                                </button>
                            </div>
                        </div>`;
                }

                const cardClass = view === 'card' ? 'md:w-1/2 lg:w-1/3 p-4' : 'p-0';
                const inner = `
                    <div class="bg-white ${view === 'card' ? 'border border-gray-100 rounded-xl shadow-sm hover:shadow-md transition h-full' : 'border-b border-gray-100'}">
                        <div class="${view === 'card' ? 'p-6' : 'px-6 py-4'}">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-semibold ${badge} px-3 py-1 rounded-full">${statusText}</div>
                                <button class="text-blue-600 hover:text-blue-800 text-sm" onclick="showLoadDetails('${load.id}')">View details →</button>
                            </div>
                            <h4 class="text-lg font-bold text-gray-900 mt-3">${load.origin} → ${load.destination}</h4>
                            <div class="mt-2 grid grid-cols-2 gap-3 text-sm text-gray-600">
                                <div><i class="fas fa-truck-loading mr-2 text-blue-500"></i>${load.equipment}</div>
                                <div><i class="fas fa-route mr-2 text-green-500"></i>${milesValue} miles</div>
                                <div><i class="fas fa-calendar-plus mr-2 text-purple-500"></i>Pickup: ${load.pickupDate ? new Date(load.pickupDate).toLocaleDateString() : 'TBD'}</div>
                                <div><i class="fas fa-dollar-sign mr-2 text-yellow-500"></i>$${rateValue.toLocaleString()} (${rpmValue ? `$${rpmValue}/mi` : 'N/A'})</div>
                            </div>
                            <div class="mt-4 text-xs text-gray-400 uppercase">Posted ${load.posted}</div>
                            <div class="mt-4 flex items-center justify-between">
                                <div class="text-sm text-gray-700"><strong>${load.company}</strong></div>
                                <button class="px-4 py-2 rounded-md text-sm font-medium ${disabled ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700'}" ${disabled ? 'disabled' : ''} onclick="showLoadDetails('${load.id}')">
                                    ${disabled ? 'Booked' : 'Book Load'}
                                </button>
                            </div>
                        </div>
                    </div>`;

                return view === 'card' ? `<div class="${cardClass}">${inner}</div>` : inner;
            }).join('');

            container.innerHTML = view === 'card'
                ? `<div class="flex flex-wrap -mx-4">${cards}</div>`
                : cards;

            updateLoadStats(loadArray);
        }

        function buildEquipmentDropdown() {
            const dropdown = document.getElementById('equipmentDropdown');
            const list = document.getElementById('equipmentList');
            if (!dropdown || !list || list.dataset.initialized) return;
            const options = ['All Equipment', 'Van', 'Flatbed', 'Reefer', 'Step Deck', 'Lowboy', 'Tanker', 'Container', 'Car Carrier'];
            list.innerHTML = options.map(option => `
                <li>
                    <button type="button" class="w-full text-left px-4 py-2 text-sm hover:bg-blue-50" data-equipment="${option === 'All Equipment' ? '' : option}">${option}</button>
                </li>`).join('');
            list.dataset.initialized = 'true';
            list.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const value = btn.getAttribute('data-equipment');
                    const select = document.getElementById('equipmentFilter');
                    const label = document.getElementById('equipmentLabel');
                    if (select) select.value = value;
                    if (label) label.textContent = value || 'All Equipment';
                    dropdown.classList.add('hidden');
                    applyFiltersAndRender();
                });
            });
        }

        function toggleEquipmentDropdown() {
            const dropdown = document.getElementById('equipmentDropdown');
            if (!dropdown) return;
            buildEquipmentDropdown();
            dropdown.classList.toggle('hidden');
        }

        function getFilterValues() {
            const origin = (document.getElementById('originFilter')?.value || '').toLowerCase();
            const destination = (document.getElementById('destFilter')?.value || '').toLowerCase();
            const equipment = (document.getElementById('equipmentFilter')?.value || '').toLowerCase();
            const loadType = (document.getElementById('loadTypeFilter')?.value || '').toLowerCase();
            const date = document.getElementById('dateFilter')?.value || '';
            const minRate = Number(document.getElementById('minRate')?.value) || 0;
            const maxMiles = Number(document.getElementById('maxMiles')?.value) || 0;
            const radius = Number(document.getElementById('radiusFilter')?.value) || 0;
            return { origin, destination, equipment, loadType, date, minRate, maxMiles, radius };
        }

        function applyFiltersAndRender() {
            const filters = getFilterValues();
            
            // Save user preferences based on current filters
            saveUserPreferences(filters);
            
            // Apply smart filtering with user preferences
            filteredLoads = smartFilterLoads(loads, filters);
            
            currentPage = 1;
            renderLoads(filteredLoads);
            updateLoadStats(filteredLoads);
            
            // Simulate realistic user behavior
            simulateUserBehavior();
        }

        function smartFilterLoads(allLoads, filters) {
            let filtered = allLoads.filter(load => {
                const originMatch = !filters.origin || (load.origin || '').toLowerCase().includes(filters.origin);
                const destinationMatch = !filters.destination || (load.destination || '').toLowerCase().includes(filters.destination);
                const equipmentMatch = !filters.equipment || (load.equipment || '').toLowerCase() === filters.equipment;
                const loadTypeMatch = !filters.loadType || (load.loadType || '').toLowerCase() === filters.loadType;
                const minRateMatch = !filters.minRate || Number(load.rate) >= filters.minRate;
                const maxMilesMatch = !filters.maxMiles || Number(load.miles) <= filters.maxMiles;
                const dateMatch = !filters.date || (load.pickupDate && load.pickupDate.startsWith(filters.date));
                const radiusMatch = !filters.radius || Number(load.miles) <= filters.radius;
                return originMatch && destinationMatch && equipmentMatch && loadTypeMatch && minRateMatch && maxMilesMatch && dateMatch && radiusMatch;
            });

            // Apply smart sorting based on user preferences and load quality
            filtered = smartSortLoads(filtered);
            
            // Limit results to prevent overwhelming the user (show most relevant 50-100 loads)
            // Performance optimization: Only show top 50 loads initially
            return filtered.slice(0, 50);
        }

        function smartSortLoads(loads) {
            return loads.sort((a, b) => {
                // Priority scoring system
                let scoreA = 0;
                let scoreB = 0;

                // Rate per mile score (higher is better, but not too high)
                const rateScoreA = Math.min(a.ratePerMile / 5, 1) * 20;
                const rateScoreB = Math.min(b.ratePerMile / 5, 1) * 20;
                scoreA += rateScoreA;
                scoreB += rateScoreB;

                // Distance score (prefer medium distances)
                const distanceScoreA = a.miles < 200 ? 10 : a.miles < 800 ? 20 : a.miles < 1500 ? 15 : 5;
                const distanceScoreB = b.miles < 200 ? 10 : b.miles < 800 ? 20 : b.miles < 1500 ? 15 : 5;
                scoreA += distanceScoreA;
                scoreB += distanceScoreB;

                // Priority score
                const priorityScoreA = a.priority === 'urgent' ? 15 : a.priority === 'high' ? 10 : 5;
                const priorityScoreB = b.priority === 'urgent' ? 15 : b.priority === 'high' ? 10 : 5;
                scoreA += priorityScoreA;
                scoreB += priorityScoreB;

                // Recency score (newer loads get higher score)
                const hoursA = getHoursFromPosted(a.posted);
                const hoursB = getHoursFromPosted(b.posted);
                const recencyScoreA = Math.max(0, 20 - hoursA);
                const recencyScoreB = Math.max(0, 20 - hoursB);
                scoreA += recencyScoreA;
                scoreB += recencyScoreB;

                // Equipment type preference
                const equipmentScoreA = a.equipment === 'Van' ? 10 : a.equipment === 'Reefer' ? 8 : 5;
                const equipmentScoreB = b.equipment === 'Van' ? 10 : b.equipment === 'Reefer' ? 8 : 5;
                scoreA += equipmentScoreA;
                scoreB += equipmentScoreB;

                return scoreB - scoreA; // Higher score first
            });
        }

        function getHoursFromPosted(posted) {
            if (posted === 'Just now') return 0;
            if (posted.includes('hour')) {
                const match = posted.match(/(\d+)\s*hour/);
                return match ? parseInt(match[1]) : 1;
            }
            if (posted.includes('day')) {
                const match = posted.match(/(\d+)\s*day/);
                return match ? parseInt(match[1]) * 24 : 24;
            }
            return 1;
        }

        function saveUserPreferences(filters) {
            // Learn from user's search patterns
            if (filters.origin) {
                const region = getRegion(filters.origin);
                if (!userPreferences.preferredRegions.includes(region)) {
                    userPreferences.preferredRegions.push(region);
                }
            }
            
            if (filters.equipment) {
                if (!userPreferences.preferredEquipment.includes(filters.equipment)) {
                    userPreferences.preferredEquipment.push(filters.equipment);
                }
            }

            if (filters.minRate) {
                userPreferences.preferredRateRange.min = filters.minRate;
            }

            if (filters.maxMiles) {
                userPreferences.preferredDistance.max = filters.maxMiles;
            }

            userPreferences.lastSearchFilters = { ...filters };
            
            // Save to localStorage
            localStorage.setItem('userPreferences', JSON.stringify(userPreferences));
        }

        function simulateUserBehavior() {
            // Simulate realistic user behavior - not all loads get clicked
            const availableLoads = filteredLoads.filter(load => load.status === 'available');
            
            if (availableLoads.length > 0) {
                // Simulate some loads being viewed (not all)
                const viewProbability = 0.3; // 30% chance a load gets viewed
                const loadsToView = availableLoads.filter(() => Math.random() < viewProbability);
                
                // Simulate some loads being booked (much lower probability)
                const bookingProbability = 0.05; // 5% chance a viewed load gets booked
                const loadsToBook = loadsToView.filter(() => Math.random() < bookingProbability);
                
                // Update load statuses to simulate realistic booking behavior
                loadsToBook.forEach(load => {
                    load.status = 'booked';
                    load.bookedBy = 'simulated_user_' + Math.floor(Math.random() * 1000);
                    load.bookedAt = new Date().toISOString();
                });

                // Update the main loads array
                loads = loads.map(originalLoad => {
                    const updatedLoad = loadsToBook.find(bookedLoad => bookedLoad.id === originalLoad.id);
                    return updatedLoad || originalLoad;
                });
            }
        }

        function searchLoads() {
            applyFiltersAndRender();
        }

        function clearFilters() {
            ['originFilter','destFilter','equipmentFilter','loadTypeFilter','dateFilter','minRate','maxMiles','radiusFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.value = '';
                }
            });
            const equipmentLabel = document.getElementById('equipmentLabel');
            if (equipmentLabel) equipmentLabel.textContent = 'All Equipment';
            applyFiltersAndRender();
            // showNotification('Filters cleared. Showing all loads.', 'info');
        }

        function saveSearch() {
            const filters = getFilterValues();
            savedSearches.unshift({ filters, savedAt: new Date().toISOString() });
            savedSearches = savedSearches.slice(0, 10);
            showNotification('Search saved! Access it later from your profile.', 'success');
        }

        function changeViewMode() {
            const select = document.getElementById('viewMode');
            if (!select) return;
            currentViewMode = select.value || 'list';
            renderLoads(filteredLoads.length ? filteredLoads : loads);
        }

        function updateAutoRefreshButton() {
            const btn = document.getElementById('autoRefreshToggleButton');
            if (!btn) return;
            if (autoRefreshEnabled) {
                btn.classList.add('bg-purple-100');
                btn.innerHTML = '<i class="fas fa-pause mr-1"></i>Stop Auto Refresh';
            } else {
                btn.classList.remove('bg-purple-100');
                btn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i>Auto Refresh';
            }
        }

        // Debounced refresh function to prevent overlapping calls
        let refreshDebounceTimer = null;
        let lastRefreshTime = 0;
        const MIN_REFRESH_INTERVAL = 30000; // Minimum 30 seconds between refreshes

        function debouncedRefreshLoads() {
            if (refreshDebounceTimer) {
                clearTimeout(refreshDebounceTimer);
            }
            
            refreshDebounceTimer = setTimeout(() => {
                const now = Date.now();
                if (now - lastRefreshTime > MIN_REFRESH_INTERVAL) {
                    refreshLoads();
                    lastRefreshTime = now;
                }
            }, 1000); // 1 second debounce
        }

        function enableAutoRefresh() {
            if (autoRefreshEnabled) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                autoRefreshEnabled = false;
                showNotification('Auto refresh disabled.', 'info');
            } else {
                // Only start auto-refresh if page is visible
                if (isPageVisible) {
                    debouncedRefreshLoads();
                    
                    // Dynamic refresh interval based on system load
                    const refreshInterval = userActivityLevel === 'critical' ? 120000 : // 2 minutes
                                          userActivityLevel === 'high' ? 90000 :      // 1.5 minutes
                                          userActivityLevel === 'normal' ? 60000 :    // 1 minute
                                          45000; // 45 seconds for low load
                    
                    autoRefreshInterval = setInterval(() => {
                        if (isPageVisible) {
                            debouncedRefreshLoads();
                        }
                    }, refreshInterval);
                    
                autoRefreshEnabled = true;
                    showNotification(`Auto refresh enabled (refreshes every ${Math.round(refreshInterval/1000)} seconds).`, 'success');
                } else {
                    showNotification('Auto refresh will start when page becomes visible.', 'info');
                }
            }
            updateAutoRefreshButton();
        }

        function updateLoadAfterBooking(loadId) {
            loads = loads.map(load => load.id === loadId ? { ...load, status: 'booked' } : load);
            filteredLoads = filteredLoads.map(load => load.id === loadId ? { ...load, status: 'booked' } : load);
            renderLoads(filteredLoads.length ? filteredLoads : loads);
        }
        async function bookLoad(loadId) {
            const user = getCurrentUser();
            if (!user) {
                showNotification('Please log in to book loads.', 'warning');
                showPage('login');
                return;
            }
            const token = getAuthToken();
            if (!token) {
                showNotification('Your session expired. Please log in again.', 'warning');
                showPage('login');
                return;
            }
            try {
                const response = await fetch(`${window.API_BASE_URL}/loads/${loadId}/book`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Booking failed');
                showNotification('Load booked successfully!', 'success');
                updateLoadAfterBooking(loadId);
                closeLoadDetails();
            } catch (error) {
                console.error('Book load error:', error);
                showNotification(error.message || 'Unable to book load. Please try again.', 'error');
            }
        }

        function findLoadById(loadId) {
            return loads.find(load => load.id === loadId) || filteredLoads.find(load => load.id === loadId);
        }

        function showLoadDetails(loadId) {
            const load = typeof loadId === 'string' ? findLoadById(loadId) : loadId;
            if (!load) {
                showNotification('Unable to locate load details.', 'error');
                return;
            }
            currentLoadDetails = load;
            const modal = document.getElementById('loadDetailsModal');
            if (!modal) {
                console.warn('Load details modal not found');
                return;
            }
            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || '-';
            };
            const titleEl = document.getElementById('modalLoadId');
            if (titleEl) titleEl.textContent = `Load ${load.id}`;
            setText('modalOrigin', load.origin);
            setText('modalDestination', load.destination);
            setText('modalEquipment', load.equipment);
            setText('modalMiles', `${Number(load.miles || 0)} miles`);
            setText('modalWeight', load.weight ? `${Number(load.weight).toLocaleString()} lbs` : '-');
            setText('modalCommodity', load.commodity);
            setText('modalRate', `$${Number(load.rate || 0).toLocaleString()}`);
            setText('modalRatePerMile', load.ratePerMile ? `$${Number(load.ratePerMile).toFixed(2)}/mi` : '—');
            setText('modalPickupDate', load.pickupDate ? new Date(load.pickupDate).toLocaleDateString() : 'TBD');
            setText('modalDeliveryDate', load.deliveryDate ? new Date(load.deliveryDate).toLocaleDateString() : 'TBD');
            setText('modalPosted', load.posted || 'Recently');
            setText('loadModalCompany', load.company);
            setText('loadModalContact', load.contact || 'Dispatch');
            setText('loadModalPhone', load.phone || '—');
            setText('loadModalEmail', load.email || '—');
            setText('modalRequirements', load.requirements || 'No special requirements');
            const bookButton = modal.querySelector('button[onclick*="bookLoadFromModal"]');
            if (bookButton) {
                if (load.status === 'booked') {
                    bookButton.disabled = true;
                    bookButton.classList.add('bg-gray-300','text-gray-500','cursor-not-allowed');
                    bookButton.innerHTML = '<i class="fas fa-lock mr-2"></i>Load Booked';
                } else {
                    bookButton.disabled = false;
                    bookButton.classList.remove('bg-gray-300','text-gray-500','cursor-not-allowed');
                    bookButton.innerHTML = '<i class="fas fa-handshake mr-2"></i>Book This Load';
                }
            }
            modal.classList.remove('hidden');
            document.body.classList.add('no-scroll');
        }

        function closeLoadDetails() {
            const modal = document.getElementById('loadDetailsModal');
            if (!modal) return;
            modal.classList.add('hidden');
            document.body.classList.remove('no-scroll');
            currentLoadDetails = null;
        }

        function bookLoadFromModal() {
            if (!currentLoadDetails) {
                closeLoadDetails();
                return;
            }
            bookLoad(currentLoadDetails.id);
        }

        async function initializeLoadBoard(forceRefresh = false) {
            if (isLoadingLoads && !forceRefresh) return;
            if (!isPageVisible && !forceRefresh) return; // Don't load if page is not visible
            
            buildEquipmentDropdown();
            setLoadingState(true);
            
            try {
                // Load from backend with caching
                const liveLoads = await fetchLoadsFromBackend({ forceRefresh });
            let backendLoads = Array.isArray(liveLoads) && liveLoads.length ? liveLoads : normalizedSampleLoads;
            
            // Load posted loads from localStorage
            const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
            
            // Combine backend loads with posted loads (posted loads first)
                const allLoads = [...postedLoads, ...backendLoads];
                
                // Limit total loads to prevent memory issues
                loads = allLoads.slice(0, MAX_LOADS);
            
            // Update window.loads for consistency
            window.loads = loads;
            
            filteredLoads = [...loads];
                
                // Only render if page is still visible
                if (isPageVisible) {
            renderLoads(filteredLoads);
                }
            } catch (error) {
                console.warn('Error initializing load board:', error);
                // Fallback to sample loads
                loads = normalizedSampleLoads;
                filteredLoads = [...loads];
                if (isPageVisible) {
                    renderLoads(filteredLoads);
                }
            } finally {
            setLoadingState(false);
            updateAutoRefreshButton();
            checkPostLoadAccess();
            }
        }

        // Smart load refresh that maintains memory limits
        function refreshLoads() {
            loadRefreshCounter++;
            console.log(`Load refresh cycle #${loadRefreshCounter} - Managing ${loads.length} loads`);
            
            // Generate new loads to replace old ones
            const newLoads = generateDynamicLoads();
            const replacementCount = Math.min(100, Math.floor(loads.length * 0.2)); // Replace 20% or 100 loads max
            
            // Remove old loads (keep the most recent ones)
            loads = loads.slice(replacementCount);
            
            // Add new loads
            const loadsToAdd = newLoads.slice(0, replacementCount);
            loads = [...loads, ...loadsToAdd];
            
            // Ensure we don't exceed MAX_LOADS
            if (loads.length > MAX_LOADS) {
                loads = loads.slice(-MAX_LOADS); // Keep only the last MAX_LOADS
            }
            
            // Update filtered loads
            filteredLoads = [...loads];
            
            // Re-render if page is visible
            if (isPageVisible) {
                renderLoads(filteredLoads);
            }
            
            // Update window.loads for consistency
            window.loads = loads;
            
            console.log(`Load refresh complete - Now managing ${loads.length} loads`);
        }

        function checkPostLoadAccess() {
            const user = getCurrentUser();
            const postForm = document.getElementById('postLoadForm');
            const denied = document.getElementById('postLoadAccessDenied');
            const mobileButton = document.getElementById('mobilePostLoadBtn');
            const desktopButton = document.getElementById('desktopPostLoadBtn');
            const canPost = !!(user && (['broker','shipper','admin'].includes(user.accountType) || user.role === 'admin'));

            if (mobileButton) mobileButton.classList.toggle('hidden', !user || !canPost);
            if (desktopButton) desktopButton.classList.toggle('hidden', !user || !canPost);

            if (!postForm || !denied) return;
            if (canPost) {
                postForm.classList.remove('hidden');
                denied.classList.add('hidden');
            } else {
                postForm.classList.add('hidden');
                denied.classList.remove('hidden');
            }
        }

        function showPostLoadPage() {
            const user = getCurrentUser();
            if (!user) {
                showNotification('Please log in to post loads.', 'warning');
                showPage('login');
                return;
            }
            
            // Clear any editing state when navigating to post load page
            window.editingLoadId = null;
            
            // Reset form to default state
            const form = document.getElementById('loadPostForm');
            if (form) {
                form.reset();
                
                // Clear manual input containers
                const manualCommodityContainer = document.getElementById('manualCommodityContainer');
                const manualPickupTimeContainer = document.getElementById('manualPickupTimeContainer');
                const manualDeliveryTimeContainer = document.getElementById('manualDeliveryTimeContainer');
                
                if (manualCommodityContainer) manualCommodityContainer.classList.add('hidden');
                if (manualPickupTimeContainer) manualPickupTimeContainer.classList.add('hidden');
                if (manualDeliveryTimeContainer) manualDeliveryTimeContainer.classList.add('hidden');
                
                // Reset form title and button
                const formTitle = document.querySelector('#postLoadForm h1');
                if (formTitle) {
                    formTitle.textContent = 'Post a Load';
                }
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Post Load';
                }
            }
            
            showPage('postload');
            checkPostLoadAccess();
        }
        async function handlePostLoad(event) {
            event.preventDefault();
            
            // Check if user is logged in
            const user = getCurrentUser();
            if (!user) {
                showNotification('Please log in to post loads.', 'warning');
                showPage('login');
                return;
            }

            // Validate all required fields before submission
            if (!validateForm()) {
                showNotification('Please fill in all required fields correctly.', 'error');
                return;
            }

            const form = event.target;
            const formData = new FormData(form);
            
            const parseLocation = value => {
                const parts = (value || '').split(',').map(part => part.trim()).filter(Boolean);
                return {
                    city: parts[0] || '',
                    state: parts[1] || ''
                };
            };

            const pickupLocation = parseLocation(formData.get('originLocation'));
            const deliveryLocation = parseLocation(formData.get('destinationLocation'));

            // Handle commodity (either from dropdown or manual entry)
            let commodity = formData.get('commodity') || '';
            if (commodity === 'manual') {
                commodity = formData.get('customCommodity') || '';
            }

            // Handle time (either from dropdown or manual entry)
            let pickupTime = formData.get('pickupTime') || '';
            if (pickupTime === 'manual') {
                pickupTime = formData.get('customPickupTime') || '';
            }

            let deliveryTime = formData.get('deliveryTime') || '';
            if (deliveryTime === 'manual') {
                deliveryTime = formData.get('customDeliveryTime') || '';
            }

            // Check if we're editing an existing load
            const isEditing = window.editingLoadId;
            
            // Create the load object
            const loadData = {
                title: formData.get('title') || `${pickupLocation.city || 'Pickup'} to ${deliveryLocation.city || 'Delivery'}`,
                description: formData.get('description') || 'FreightPro load posting',
                loadType: formData.get('loadType') || 'Full Truckload',
                commodity: commodity,
                origin: {
                    city: pickupLocation.city,
                    state: pickupLocation.state,
                    zip: formData.get('originZip') || ''
                },
                destination: {
                    city: deliveryLocation.city,
                    state: deliveryLocation.state,
                    zip: formData.get('destinationZip') || ''
                },
                pickupDate: formData.get('pickupDate') || new Date().toISOString().split('T')[0],
                deliveryDate: formData.get('deliveryDate') || formData.get('pickupDate') || new Date().toISOString().split('T')[0],
                pickupTime: pickupTime,
                deliveryTime: deliveryTime,
                equipmentType: formData.get('equipmentType') || 'Van',
                weight: Number(formData.get('weight')) || 0,
                length: Number(formData.get('length')) || 0,
                rate: Number(formData.get('rate')) || 0,
                rateType: formData.get('rateType') || 'flat',
                distance: Number(formData.get('distance')) || 0,
                status: 'available',
                // Add special requirements
                requirements: {
                    hazmat: formData.get('hazmat') === 'on',
                    teamDriver: formData.get('teamDriver') === 'on',
                    expedited: formData.get('expedited') === 'on',
                    tempControl: formData.get('tempControl') === 'on',
                    liftgate: formData.get('liftgate') === 'on',
                    insideDelivery: formData.get('insideDelivery') === 'on'
                }
            };

            // Add ID and posting info based on whether we're creating or editing
            if (isEditing) {
                // Editing existing load - preserve original ID and posting info
                const existingLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
                const existingLoad = existingLoads.find(load => load.id === isEditing);
                if (existingLoad) {
                    loadData.id = existingLoad.id;
                    loadData.postedBy = existingLoad.postedBy;
                    loadData.posted = existingLoad.posted;
                    loadData.postedTime = existingLoad.postedTime;
                    loadData.updated = new Date().toLocaleDateString();
                    loadData.updatedTime = new Date().toLocaleTimeString();
                }
            } else {
                // Creating new load
                loadData.id = Date.now().toString();
                loadData.postedBy = user.email || user.name || 'Unknown';
                loadData.posted = new Date().toLocaleDateString();
                loadData.postedTime = new Date().toLocaleTimeString();
            }

            try {
                // Get existing posted loads
                const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
                
                if (isEditing) {
                    // Update existing load
                    const loadIndex = postedLoads.findIndex(load => load.id === isEditing);
                    if (loadIndex !== -1) {
                        postedLoads[loadIndex] = loadData;
                        localStorage.setItem('postedLoads', JSON.stringify(postedLoads));
                        showNotification('Load updated successfully!', 'success');
                    } else {
                        showNotification('Load not found for updating', 'error');
                        return;
                    }
                } else {
                    // Add new load
                    postedLoads.unshift(loadData); // Add to beginning of array
                    localStorage.setItem('postedLoads', JSON.stringify(postedLoads));
                    showNotification('Load posted successfully! It is now available for booking.', 'success');
                }
                
                // Update window.loads for consistency
                if (!window.loads) {
                    window.loads = [];
                }
                window.loads = postedLoads;
                
                // Reset form and clear editing state
                form.reset();
                window.editingLoadId = null;
                
                // Clear any manual input containers
                document.getElementById('manualCommodityContainer').classList.add('hidden');
                document.getElementById('manualPickupTimeContainer').classList.add('hidden');
                document.getElementById('manualDeliveryTimeContainer').classList.add('hidden');
                
                // Reset form title and button
                const formTitle = document.querySelector('#postLoadForm h1');
                if (formTitle) {
                    formTitle.textContent = 'Post a Load';
                }
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) {
                    submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Post Load';
                }
                
                // Update user's loads posted count (only for new loads)
                if (!isEditing) {
                    const user = getCurrentUser();
                    if (user) {
                        user.loadsPosted = (parseInt(user.loadsPosted) || 0) + 1;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                    }
                }
                
                // Redirect to home page to see the posted/updated load in dashboard
                setTimeout(() => {
                    showPage('home');
                    // Refresh the dashboard to show the updated load
                    populateUserDashboard();
                }, 1500);
                
            } catch (error) {
                console.error('Post load error:', error);
                showNotification('Unable to post load. Please try again.', 'error');
            }
        }

        // Form validation function
        function validateForm() {
            const requiredFields = [
                'loadType', 'equipmentType', 'title', 'weight', 'length',
                'originLocation', 'pickupDate', 'destinationLocation', 'deliveryDate', 'rate'
            ];
            
            let isValid = true;
            
            // Check required fields
            requiredFields.forEach(fieldName => {
                const field = document.querySelector(`[name="${fieldName}"]`);
                if (!field || !field.value.trim()) {
                    isValid = false;
                    if (field) {
                        field.style.borderColor = '#ef4444';
                        field.focus();
                    }
                } else {
                    if (field) {
                        field.style.borderColor = '#d1d5db';
                    }
                }
            });
            
            // Check commodity (either dropdown or manual)
            const commoditySelect = document.getElementById('commoditySelect');
            const customCommodity = document.getElementById('customCommodityInput');
            if (commoditySelect.value === 'manual' && (!customCommodity.value.trim())) {
                isValid = false;
                customCommodity.style.borderColor = '#ef4444';
                customCommodity.focus();
            }
            
            // Check manual time inputs
            const pickupTimeSelect = document.getElementById('pickupTimeSelect');
            const customPickupTime = document.getElementById('customPickupTimeInput');
            if (pickupTimeSelect.value === 'manual' && (!customPickupTime.value.trim())) {
                isValid = false;
                customPickupTime.style.borderColor = '#ef4444';
                customPickupTime.focus();
            }
            
            const deliveryTimeSelect = document.getElementById('deliveryTimeSelect');
            const customDeliveryTime = document.getElementById('customDeliveryTimeInput');
            if (deliveryTimeSelect.value === 'manual' && (!customDeliveryTime.value.trim())) {
                isValid = false;
                customDeliveryTime.style.borderColor = '#ef4444';
                customDeliveryTime.focus();
            }
            
            // Validate dates
            if (!validatePickupDate() || !validateDeliveryDate()) {
                isValid = false;
            }
            
            return isValid;
        }

        // Smart search suggestions
        function showSmartSuggestions(input, type) {
            const value = input.value.toLowerCase();
            const suggestionsId = type + 'Suggestions';
            const suggestionsDiv = document.getElementById(suggestionsId);
            
            if (value.length < 2) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            
            const filteredCities = cities.filter(city => 
                city.toLowerCase().includes(value)
            ).slice(0, 5);
            
            if (filteredCities.length > 0) {
                suggestionsDiv.innerHTML = filteredCities.map(city => 
                    `<div class="smart-search-suggestion" onclick="selectSuggestion('${city}', '${input.id}', '${suggestionsId}')">${city}</div>`
                ).join('');
                suggestionsDiv.classList.remove('hidden');
            } else {
                suggestionsDiv.classList.add('hidden');
            }
        }

        function selectSuggestion(city, inputId, suggestionsId) {
            document.getElementById(inputId).value = city;
            document.getElementById(suggestionsId).classList.add('hidden');
            searchLoads();
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('[id$="Suggestions"]').forEach(div => {
                    div.classList.add('hidden');
                });
            }
        });
        // Update navigation based on user session
        function updateNavigation() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            const authButtons = document.getElementById('authButtons');
            const userInfo = document.getElementById('userInfo');
            
            if (currentUser && currentUser.email) {
                // User is logged in
                if (authButtons) authButtons.classList.add('hidden');
                if (userInfo) {
                    userInfo.classList.remove('hidden');
                    const displayName = currentUser.company || currentUser.name || currentUser.email.split('@')[0];
                    const userInitial = displayName.charAt(0).toUpperCase();
                    
                    userInfo.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div onclick="showPage('profile')" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-semibold cursor-pointer hover:bg-blue-700 transition-colors" title="Click to view profile">
                                ${userInitial}
                            </div>
                            <span class="text-sm text-white">Welcome, ${displayName}</span>
                            ${currentUser.role === 'admin' ? '<button onclick="showPage(\'admin\')" class="bg-purple-600 hover:bg-purple-500 px-3 py-2 rounded text-sm transition-colors"><i class="fas fa-cog mr-1"></i>Admin</button>' : ''}
                            <button onclick="logout()" class="bg-red-600 hover:bg-red-500 px-3 py-2 rounded text-sm transition-colors text-white">
                                <i class="fas fa-sign-out-alt mr-1"></i>Logout
                            </button>
                        </div>
                    `;
                }
                
                // Check Post Load access
                checkPostLoadAccess();
            } else {
                // User is not logged in
                if (authButtons) authButtons.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                
                // Hide Post Load buttons for non-logged in users
                const mobilePostLoadBtn = document.getElementById('mobilePostLoadBtn');
                const desktopPostLoadBtn = document.getElementById('desktopPostLoadBtn');
                if (mobilePostLoadBtn) mobilePostLoadBtn.classList.add('hidden');
                if (desktopPostLoadBtn) desktopPostLoadBtn.classList.add('hidden');
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            window.currentUser = null;
            try { localStorage.removeItem('currentUser'); } catch (e) {}
            // showNotification('Logged out successfully', 'info');
            showPage('home');
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshEnabled = false;
            }
            
            // Clear any session timers or intervals
            console.log('User logged out, session cleared');
        }

        // Enhanced notification system
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            }[type] || 'fas fa-info-circle';
            
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="${icon} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.getElementById('notifications').appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, duration);
        }

        // Page navigation with authentication check
        function showPage(pageId) {
            showPageAsync(pageId);
        }

        // Save draft functionality
        function saveDraft() {
            const form = document.getElementById('loadPostForm');
            if (!form) {
                showNotification('Form not found', 'error');
                return;
            }

            const formData = new FormData(form);
            const draftData = {};
            
            // Collect all form data
            for (let [key, value] of formData.entries()) {
                draftData[key] = value;
            }
            
            // Save to localStorage
            localStorage.setItem('loadDraft', JSON.stringify(draftData));
            showNotification('Draft saved successfully!', 'success');
        }

        // Load draft functionality
        function loadDraft() {
            const draftData = localStorage.getItem('loadDraft');
            if (!draftData) return;
            
            try {
                const data = JSON.parse(draftData);
                const form = document.getElementById('loadPostForm');
                if (!form) return;
                
                // Populate form fields
                Object.keys(data).forEach(key => {
                    const field = form.querySelector(`[name="${key}"]`);
                    if (field) {
                        if (field.type === 'checkbox') {
                            field.checked = data[key] === 'on';
                        } else {
                            field.value = data[key];
                        }
                    }
                });
                
                // Handle commodity selection if it was manual
                if (data.commodity === 'manual' && data.customCommodity) {
                    document.getElementById('commoditySelect').value = 'manual';
                    document.getElementById('customCommodityInput').value = data.customCommodity;
                    document.getElementById('manualCommodityContainer').classList.remove('hidden');
                }
                
                showNotification('Draft loaded successfully!', 'info');
            } catch (error) {
                console.error('Error loading draft:', error);
                showNotification('Error loading draft', 'error');
            }
        }

        // Handle commodity dropdown change
        function handleCommodityChange() {
            const commoditySelect = document.getElementById('commoditySelect');
            const manualContainer = document.getElementById('manualCommodityContainer');
            const customInput = document.getElementById('customCommodityInput');
            
            if (commoditySelect.value === 'manual') {
                // Show manual input field
                manualContainer.classList.remove('hidden');
                customInput.focus();
                customInput.required = true;
            } else {
                // Hide manual input field
                manualContainer.classList.add('hidden');
                customInput.value = '';
                customInput.required = false;
            }
        }

        // Date validation functions
        function validatePickupDate() {
            const pickupDate = document.getElementById('pickupDate');
            const errorDiv = document.getElementById('pickupDateError');
            const today = new Date().toISOString().split('T')[0];
            
            if (pickupDate.value && pickupDate.value < today) {
                errorDiv.classList.remove('hidden');
                pickupDate.style.borderColor = '#ef4444';
                return false;
            } else {
                errorDiv.classList.add('hidden');
                pickupDate.style.borderColor = '#d1d5db';
                return true;
            }
        }

        function validateDeliveryDate() {
            const pickupDate = document.getElementById('pickupDate').value;
            const deliveryDate = document.getElementById('deliveryDate');
            const errorDiv = document.getElementById('deliveryDateError');
            
            if (deliveryDate.value && pickupDate && deliveryDate.value < pickupDate) {
                errorDiv.classList.remove('hidden');
                deliveryDate.style.borderColor = '#ef4444';
                return false;
            } else {
                errorDiv.classList.add('hidden');
                deliveryDate.style.borderColor = '#d1d5db';
                return true;
            }
        }

        // Time input handlers
        function handlePickupTimeChange() {
            const timeSelect = document.getElementById('pickupTimeSelect');
            const manualContainer = document.getElementById('manualPickupTimeContainer');
            const customInput = document.getElementById('customPickupTimeInput');
            
            if (timeSelect.value === 'manual') {
                manualContainer.classList.remove('hidden');
                customInput.focus();
                customInput.required = true;
            } else {
                manualContainer.classList.add('hidden');
                customInput.value = '';
                customInput.required = false;
            }
        }

        function handleDeliveryTimeChange() {
            const timeSelect = document.getElementById('deliveryTimeSelect');
            const manualContainer = document.getElementById('manualDeliveryTimeContainer');
            const customInput = document.getElementById('customDeliveryTimeInput');
            
            if (timeSelect.value === 'manual') {
                manualContainer.classList.remove('hidden');
                customInput.focus();
                customInput.required = true;
            } else {
                manualContainer.classList.add('hidden');
                customInput.value = '';
                customInput.required = false;
            }
        }

        // ZIP code validation with city/state matching
        function validateZipCode(zipFieldId, locationFieldId) {
            const zipField = document.getElementById(zipFieldId);
            const locationField = document.getElementById(locationFieldId);
            const errorDiv = document.getElementById(zipFieldId + 'Error');
            
            if (!zipField.value || !locationField.value) {
                // Clear error if fields are empty
                errorDiv.classList.add('hidden');
                zipField.style.borderColor = '#d1d5db';
                return true;
            }
            
            const zipCode = zipField.value.trim();
            const location = locationField.value.trim().toLowerCase();
            
            // Check if ZIP code format is valid
            if (zipCode.length !== 5 || !/^\d{5}$/.test(zipCode)) {
                errorDiv.textContent = 'Please enter a valid 5-digit ZIP code';
                errorDiv.classList.remove('hidden');
                zipField.style.borderColor = '#ef4444';
                return false;
            }
            
            // ZIP code to city/state mapping (common ZIP codes)
            const zipCodeMap = {
                // Los Angeles, CA
                '90210': 'beverly hills, ca',
                '90211': 'beverly hills, ca',
                '90001': 'los angeles, ca',
                '90002': 'los angeles, ca',
                '90003': 'los angeles, ca',
                '90004': 'los angeles, ca',
                '90005': 'los angeles, ca',
                '90006': 'los angeles, ca',
                '90007': 'los angeles, ca',
                '90008': 'los angeles, ca',
                '90009': 'los angeles, ca',
                '90010': 'los angeles, ca',
                '90011': 'los angeles, ca',
                '90012': 'los angeles, ca',
                '90013': 'los angeles, ca',
                '90014': 'los angeles, ca',
                '90015': 'los angeles, ca',
                '90016': 'los angeles, ca',
                '90017': 'los angeles, ca',
                '90018': 'los angeles, ca',
                '90019': 'los angeles, ca',
                '90020': 'los angeles, ca',
                '90021': 'los angeles, ca',
                '90022': 'los angeles, ca',
                '90023': 'los angeles, ca',
                '90024': 'los angeles, ca',
                '90025': 'los angeles, ca',
                '90026': 'los angeles, ca',
                '90027': 'los angeles, ca',
                '90028': 'los angeles, ca',
                '90029': 'los angeles, ca',
                '90030': 'los angeles, ca',
                '90031': 'los angeles, ca',
                '90032': 'los angeles, ca',
                '90033': 'los angeles, ca',
                '90034': 'los angeles, ca',
                '90035': 'los angeles, ca',
                '90036': 'los angeles, ca',
                '90037': 'los angeles, ca',
                '90038': 'los angeles, ca',
                '90039': 'los angeles, ca',
                '90040': 'los angeles, ca',
                '90041': 'los angeles, ca',
                '90042': 'los angeles, ca',
                '90043': 'los angeles, ca',
                '90044': 'los angeles, ca',
                '90045': 'los angeles, ca',
                '90046': 'los angeles, ca',
                '90047': 'los angeles, ca',
                '90048': 'los angeles, ca',
                '90049': 'los angeles, ca',
                '90050': 'los angeles, ca',
                '90051': 'los angeles, ca',
                '90052': 'los angeles, ca',
                '90053': 'los angeles, ca',
                '90054': 'los angeles, ca',
                '90055': 'los angeles, ca',
                '90056': 'los angeles, ca',
                '90057': 'los angeles, ca',
                '90058': 'los angeles, ca',
                '90059': 'los angeles, ca',
                '90060': 'los angeles, ca',
                '90061': 'los angeles, ca',
                '90062': 'los angeles, ca',
                '90063': 'los angeles, ca',
                '90064': 'los angeles, ca',
                '90065': 'los angeles, ca',
                '90066': 'los angeles, ca',
                '90067': 'los angeles, ca',
                '90068': 'los angeles, ca',
                '90069': 'los angeles, ca',
                '90070': 'los angeles, ca',
                '90071': 'los angeles, ca',
                '90072': 'los angeles, ca',
                '90073': 'los angeles, ca',
                '90074': 'los angeles, ca',
                '90075': 'los angeles, ca',
                '90076': 'los angeles, ca',
                '90077': 'los angeles, ca',
                '90078': 'los angeles, ca',
                '90079': 'los angeles, ca',
                '90080': 'los angeles, ca',
                '90081': 'los angeles, ca',
                '90082': 'los angeles, ca',
                '90083': 'los angeles, ca',
                '90084': 'los angeles, ca',
                '90085': 'los angeles, ca',
                '90086': 'los angeles, ca',
                '90087': 'los angeles, ca',
                '90088': 'los angeles, ca',
                '90089': 'los angeles, ca',
                '90090': 'los angeles, ca',
                '90091': 'los angeles, ca',
                '90092': 'los angeles, ca',
                '90093': 'los angeles, ca',
                '90094': 'los angeles, ca',
                '90095': 'los angeles, ca',
                '90096': 'los angeles, ca',
                '90097': 'los angeles, ca',
                '90098': 'los angeles, ca',
                '90099': 'los angeles, ca',
                
                // Phoenix, AZ
                '85001': 'phoenix, az',
                '85002': 'phoenix, az',
                '85003': 'phoenix, az',
                '85004': 'phoenix, az',
                '85005': 'phoenix, az',
                '85006': 'phoenix, az',
                '85007': 'phoenix, az',
                '85008': 'phoenix, az',
                '85009': 'phoenix, az',
                '85010': 'phoenix, az',
                '85011': 'phoenix, az',
                '85012': 'phoenix, az',
                '85013': 'phoenix, az',
                '85014': 'phoenix, az',
                '85015': 'phoenix, az',
                '85016': 'phoenix, az',
                '85017': 'phoenix, az',
                '85018': 'phoenix, az',
                '85019': 'phoenix, az',
                '85020': 'phoenix, az',
                '85021': 'phoenix, az',
                '85022': 'phoenix, az',
                '85023': 'phoenix, az',
                '85024': 'phoenix, az',
                '85025': 'phoenix, az',
                '85026': 'phoenix, az',
                '85027': 'phoenix, az',
                '85028': 'phoenix, az',
                '85029': 'phoenix, az',
                '85030': 'phoenix, az',
                '85031': 'phoenix, az',
                '85032': 'phoenix, az',
                '85033': 'phoenix, az',
                '85034': 'phoenix, az',
                '85035': 'phoenix, az',
                '85036': 'phoenix, az',
                '85037': 'phoenix, az',
                '85038': 'phoenix, az',
                '85039': 'phoenix, az',
                '85040': 'phoenix, az',
                '85041': 'phoenix, az',
                '85042': 'phoenix, az',
                '85043': 'phoenix, az',
                '85044': 'phoenix, az',
                '85045': 'phoenix, az',
                '85046': 'phoenix, az',
                '85048': 'phoenix, az',
                '85050': 'phoenix, az',
                '85051': 'phoenix, az',
                '85053': 'phoenix, az',
                '85054': 'phoenix, az',
                '85083': 'phoenix, az',
                '85085': 'phoenix, az',
                '85086': 'phoenix, az',
                '85087': 'phoenix, az',
                
                // Chicago, IL
                '60601': 'chicago, il',
                '60602': 'chicago, il',
                '60603': 'chicago, il',
                '60604': 'chicago, il',
                '60605': 'chicago, il',
                '60606': 'chicago, il',
                '60607': 'chicago, il',
                '60608': 'chicago, il',
                '60609': 'chicago, il',
                '60610': 'chicago, il',
                '60611': 'chicago, il',
                '60612': 'chicago, il',
                '60613': 'chicago, il',
                '60614': 'chicago, il',
                '60615': 'chicago, il',
                '60616': 'chicago, il',
                '60617': 'chicago, il',
                '60618': 'chicago, il',
                '60619': 'chicago, il',
                '60620': 'chicago, il',
                '60621': 'chicago, il',
                '60622': 'chicago, il',
                '60623': 'chicago, il',
                '60624': 'chicago, il',
                '60625': 'chicago, il',
                '60626': 'chicago, il',
                '60628': 'chicago, il',
                '60629': 'chicago, il',
                '60630': 'chicago, il',
                '60631': 'chicago, il',
                '60632': 'chicago, il',
                '60633': 'chicago, il',
                '60634': 'chicago, il',
                '60636': 'chicago, il',
                '60637': 'chicago, il',
                '60638': 'chicago, il',
                '60639': 'chicago, il',
                '60640': 'chicago, il',
                '60641': 'chicago, il',
                '60642': 'chicago, il',
                '60643': 'chicago, il',
                '60644': 'chicago, il',
                '60645': 'chicago, il',
                '60646': 'chicago, il',
                '60647': 'chicago, il',
                '60649': 'chicago, il',
                '60651': 'chicago, il',
                '60652': 'chicago, il',
                '60653': 'chicago, il',
                '60654': 'chicago, il',
                '60655': 'chicago, il',
                '60656': 'chicago, il',
                '60657': 'chicago, il',
                '60659': 'chicago, il',
                '60660': 'chicago, il',
                '60661': 'chicago, il',
                '60664': 'chicago, il',
                '60666': 'chicago, il',
                '60668': 'chicago, il',
                '60669': 'chicago, il',
                '60670': 'chicago, il',
                '60673': 'chicago, il',
                '60674': 'chicago, il',
                '60675': 'chicago, il',
                '60677': 'chicago, il',
                '60678': 'chicago, il',
                '60680': 'chicago, il',
                '60681': 'chicago, il',
                '60682': 'chicago, il',
                '60684': 'chicago, il',
                '60685': 'chicago, il',
                '60686': 'chicago, il',
                '60687': 'chicago, il',
                '60688': 'chicago, il',
                '60689': 'chicago, il',
                '60690': 'chicago, il',
                '60691': 'chicago, il',
                '60693': 'chicago, il',
                '60694': 'chicago, il',
                '60695': 'chicago, il',
                '60696': 'chicago, il',
                '60697': 'chicago, il',
                '60699': 'chicago, il',
                '60701': 'chicago, il',
                
                // Atlanta, GA
                '30301': 'atlanta, ga',
                '30302': 'atlanta, ga',
                '30303': 'atlanta, ga',
                '30304': 'atlanta, ga',
                '30305': 'atlanta, ga',
                '30306': 'atlanta, ga',
                '30307': 'atlanta, ga',
                '30308': 'atlanta, ga',
                '30309': 'atlanta, ga',
                '30310': 'atlanta, ga',
                '30311': 'atlanta, ga',
                '30312': 'atlanta, ga',
                '30313': 'atlanta, ga',
                '30314': 'atlanta, ga',
                '30315': 'atlanta, ga',
                '30316': 'atlanta, ga',
                '30317': 'atlanta, ga',
                '30318': 'atlanta, ga',
                '30319': 'atlanta, ga',
                '30320': 'atlanta, ga',
                '30321': 'atlanta, ga',
                '30322': 'atlanta, ga',
                '30324': 'atlanta, ga',
                '30325': 'atlanta, ga',
                '30326': 'atlanta, ga',
                '30327': 'atlanta, ga',
                '30328': 'atlanta, ga',
                '30329': 'atlanta, ga',
                '30330': 'atlanta, ga',
                '30331': 'atlanta, ga',
                '30332': 'atlanta, ga',
                '30333': 'atlanta, ga',
                '30334': 'atlanta, ga',
                '30336': 'atlanta, ga',
                '30337': 'atlanta, ga',
                '30338': 'atlanta, ga',
                '30339': 'atlanta, ga',
                '30340': 'atlanta, ga',
                '30341': 'atlanta, ga',
                '30342': 'atlanta, ga',
                '30343': 'atlanta, ga',
                '30344': 'atlanta, ga',
                '30345': 'atlanta, ga',
                '30346': 'atlanta, ga',
                '30348': 'atlanta, ga',
                '30349': 'atlanta, ga',
                '30350': 'atlanta, ga',
                '30353': 'atlanta, ga',
                '30354': 'atlanta, ga',
                '30355': 'atlanta, ga',
                '30356': 'atlanta, ga',
                '30357': 'atlanta, ga',
                '30358': 'atlanta, ga',
                '30359': 'atlanta, ga',
                '30360': 'atlanta, ga',
                '30361': 'atlanta, ga',
                '30362': 'atlanta, ga',
                '30363': 'atlanta, ga',
                '30364': 'atlanta, ga',
                '30366': 'atlanta, ga',
                '30368': 'atlanta, ga',
                '30369': 'atlanta, ga',
                '30370': 'atlanta, ga',
                '30371': 'atlanta, ga',
                '30374': 'atlanta, ga',
                '30375': 'atlanta, ga',
                '30376': 'atlanta, ga',
                '30377': 'atlanta, ga',
                '30378': 'atlanta, ga',
                '30380': 'atlanta, ga',
                '30384': 'atlanta, ga',
                '30385': 'atlanta, ga',
                '30388': 'atlanta, ga',
                '30392': 'atlanta, ga',
                '30394': 'atlanta, ga',
                '30396': 'atlanta, ga',
                '30398': 'atlanta, ga',
                '30399': 'atlanta, ga'
            };
            
            // Check if ZIP code matches the entered city/state
            const expectedLocation = zipCodeMap[zipCode];
            if (expectedLocation && !location.includes(expectedLocation.split(',')[0]) && !location.includes(expectedLocation.split(',')[1].trim())) {
                errorDiv.textContent = `This ZIP code (${zipCode}) does not match ${locationField.value}. Expected: ${expectedLocation}`;
                errorDiv.classList.remove('hidden');
                zipField.style.borderColor = '#ef4444';
                return false;
            }
            
            // If ZIP code is not in our database, we'll allow it but show a warning
            if (!expectedLocation) {
                errorDiv.textContent = 'ZIP code not recognized. Please verify it matches the city/state.';
                errorDiv.classList.remove('hidden');
                zipField.style.borderColor = '#f59e0b'; // Orange warning instead of red error
                return false;
            }
            
            // ZIP code matches city/state
            errorDiv.classList.add('hidden');
            zipField.style.borderColor = '#d1d5db';
            return true;
        }

        async function showPageAsync(pageId) {
            // Check if user is already logged in and trying to access auth pages
            if ((pageId === 'login' || pageId === 'register') && window.currentUser) {
                // User is already logged in, redirect to home
                // showNotification('You are already logged in!', 'info');
                pageId = 'home';
            }
            
            const protectedPages = ['loadboard', 'postload', 'rates', 'marketplace', 'reports', 'directory', 'admin'];
            
            if (protectedPages.includes(pageId) && !currentUser) {
                showNotification('Please log in to access this feature', 'warning');
                showPageAsync('login');
                return;
            }
            
            if (pageId === 'admin' && (!currentUser || currentUser.role !== 'admin')) {
                showNotification('Access denied. Admin privileges required.', 'error');
                showPageAsync('login');
                return;
            }
            
            // Update active nav item
            if (document.querySelectorAll) {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.add('hidden');
                    page.style.display = 'none'; // Ensure display is set to none
                });
                // clear inline login error when switching pages
                try { const le = document.getElementById('loginError'); if (le) { le.textContent=''; le.classList.add('hidden'); } } catch(e){}
            }

            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                targetPage.classList.remove('hidden');
                targetPage.style.display = 'block'; // Ensure display is set to block
            } else {
                console.error(`Page ${pageId} not found!`);
            }
            // If navigating to pricing and a user is logged in, remove the guest promo banner
            if (pageId === 'pricing') {
                // determine session state robustly and show/hide promo accordingly
                let isLogged = false;
                try { if (window.isSessionActive && typeof window.isSessionActive === 'function') isLogged = !!window.isSessionActive(); else isLogged = !!window.currentUser || !!localStorage.getItem('currentUser'); } catch(e) { isLogged = !!window.currentUser; }
                try {
                    const b = document.getElementById('pricingGuestBanner');
                    if (b) {
                        if (isLogged) b.classList.add('hidden'); else b.classList.remove('hidden');
                    }
                } catch(e){}
            }
            updateNavigation();
            
            // Initialize page-specific content
            if (pageId === 'loadboard') {
                initializeLoadBoard();
            } else if (pageId === 'rates') {
                // initializeRateAnalysis may be defined only when the rates module is available.
                if (typeof initializeRateAnalysis === 'function') {
                    try { initializeRateAnalysis(); } catch (e) { if (console && console.debug) console.debug('initializeRateAnalysis failed', e); }
                } else {
                    if (console && console.info) console.info('initializeRateAnalysis: rates module not loaded, skipping');
                }
            } else if (pageId === 'reports') {
                initializeReports();
            } else if (pageId === 'home') {
                // Populate user dashboard if logged in
                populateUserDashboard();
            } else if (pageId === 'profile') {
                // Populate profile page with user data
                populateProfilePage();
            } else if (pageId === 'admin') {
                // Ensure only admin can see and populate the admin users table
                fetchAdminUsers();
                
                // Show profile page
                console.log('Showing profile page');
                
                return;
            } else if (pageId === 'register') {
                // Reset all registration form state
                resetRegistrationForm();
            } else if (pageId === 'postload') {
                // Load draft when accessing post load page
                loadDraft();
            }
            
            // Navigation system will handle history tracking automatically
        }

        // User registration and login using localStorage
        function saveUsersToLocal() {
            localStorage.setItem('users', JSON.stringify(users));
        }
        // ENHANCED UNIVERSAL MASTER PROGRAMMER REGISTRATION WITH FMCSA INTEGRATION
        let lastVerificationEmail = '';

        function setAuthenticatedSession(result) {
            if (!result || !result.token || !result.user) {
                console.warn('Authentication result missing token or user payload');
                return;
            }

            if (!result || !result.token || !result.user) return;
            localStorage.setItem('authToken', result.token);
            localStorage.setItem('currentUser', JSON.stringify(result.user));
            window.currentUser = result.user;
        }

        function navigateAfterLogin(user) {
            if (!user) return;
            if (user.role === 'admin') {
                showPage('admin');
            } else {
                showPage('home');
                // Populate dashboard after showing home page
                setTimeout(() => populateUserDashboard(), 100);
            }
        }

        function showVerificationModal(email) {
            console.log('Showing verification modal for email:', email);
            const modal = document.getElementById('verificationModal');
            if (!modal) {
                console.error('Verification modal not found!');
                return;
            }
            const emailInput = document.getElementById('verificationEmail');
            const emailDisplay = document.getElementById('verificationEmailDisplay');
            const codeInput = document.getElementById('verificationCode');

            const targetEmail = email || lastVerificationEmail;
            console.log('Target email for verification:', targetEmail);
            
            if (targetEmail && emailInput) {
                emailInput.value = targetEmail;
                lastVerificationEmail = targetEmail;
            }

            if (emailDisplay) {
                emailDisplay.textContent = targetEmail || 'your email';
            }

            if (codeInput) {
                codeInput.value = '';
                codeInput.focus();
            }

            modal.classList.remove('hidden');
            console.log('Verification modal shown');
        }

        function hideVerificationModal() {
            const modal = document.getElementById('verificationModal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        async function handleVerificationSubmit(event) {
            event.preventDefault();

            const emailInput = document.getElementById('verificationEmail');
            const codeInput = document.getElementById('verificationCode');
            if (!emailInput || !codeInput) return;

            const email = emailInput.value.trim();
            const code = codeInput.value.trim();

            if (!email || !code) {
                showNotification('Enter both email and the verification code.', 'warning');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/auth/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('Email verified successfully! You can now log in.', 'success');
                    hideVerificationModal();
                    showPage('login');
                } else {
                    showNotification(result.message || 'Verification failed. Please check the code and try again.', 'error');
                }
            } catch (error) {
                console.error('Verification error:', error);
                showNotification('Verification failed. Please try again later.', 'error');
            }
        }

        async function resendVerificationCode() {
            const emailInput = document.getElementById('verificationEmail');
            const email = (emailInput?.value || lastVerificationEmail || '').trim();

            if (!email) {
                showNotification('Enter your email to resend the verification code.', 'warning');
                return;
            }

            try {
                const response = await fetch(`${window.API_BASE_URL}/auth/resend-code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('A new verification code has been sent to your email.', 'success');
                    const hint = document.getElementById('verificationCodeHint');
                    if (hint) {
                        const minutes = result.expiresInMinutes;
                        hint.textContent = minutes ? `Code valid for ${minutes} minutes.` : 'Code valid for 24 hours.';
                    }
                } else {
                    showNotification(result.message || 'Could not resend the verification code.', 'error');
                }
            } catch (error) {
                console.error('Resend verification error:', error);
                showNotification('Failed to resend verification code. Please try again later.', 'error');
            }
        }

        (function attachVerificationHandlers() {
            try {
                const verificationForm = document.getElementById('verificationForm');
                if (verificationForm) {
                    verificationForm.addEventListener('submit', handleVerificationSubmit);
                }
            } catch (error) {
                console.warn('Failed to attach verification handler', error);
            }
        })();

        document.addEventListener('DOMContentLoaded', () => {
            const verificationForm = document.getElementById('verificationForm');
            if (verificationForm && !verificationForm.dataset.bound) {
                verificationForm.addEventListener('submit', handleVerificationSubmit);
                verificationForm.dataset.bound = 'true';
            }

            // Toggle EIN field based on account type
            function toggleEINField() {
                const accountTypeSelect = document.getElementById('accountTypeSelect');
                const einFieldGroup = document.getElementById('einFieldGroup');
                const einInput = document.getElementById('einInput');
                
                if (accountTypeSelect && einFieldGroup && einInput) {
                    const selectedType = accountTypeSelect.value;
                    if (selectedType === 'broker' || selectedType === 'carrier') {
                        einFieldGroup.style.display = 'block';
                        einInput.required = true;
                    } else {
                        einFieldGroup.style.display = 'none';
                        einInput.required = false;
                        einInput.value = '';
                    }
                }
            }

            // Attach registration form handler
            const registerForm = document.getElementById('registerForm');
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }
        });

        async function handleRegister(event) {
            event.preventDefault();
            console.log('🚀 FreightPro Registration with Backend API');
            console.log('API Base URL:', window.API_BASE_URL);
            
            const form = event.target;
            
            // Get the selected account type
            const selectedAccountType = window.selectedAccountType || localStorage.getItem('selectedAccountType') || 'shipper';
            console.log('Selected account type for registration:', selectedAccountType);
            
            // Enhanced validation with specific error messages
            if (!form.company.value.trim()) {
                showNotification('Company name is required.', 'error');
                form.company.focus();
                return;
            }
            
            if (!form.email.value.trim()) {
                showNotification('Email address is required.', 'error');
                form.email.focus();
                return;
            }
            
            if (!form.password.value) {
                showNotification('Password is required.', 'error');
                form.password.focus();
                return;
            }
            
            if (form.password.value.length < 6) {
                showNotification('Password must be at least 6 characters long.', 'error');
                form.password.focus();
                return;
            }
            
            if (!form.phone.value.trim()) {
                showNotification('Phone number is required.', 'error');
                form.phone.focus();
                return;
            }
            
            if (form.phone.value.trim().length < 7) {
                showNotification('Phone number must be at least 7 characters long.', 'error');
                form.phone.focus();
                return;
            }
            
            // EIN validation for brokers and carriers
            if (selectedAccountType === 'broker' || selectedAccountType === 'carrier') {
                const einInput = document.getElementById('einInput');
                if (!einInput || !einInput.value.trim()) {
                    showNotification('EIN is required for brokers and carriers.', 'error');
                    if (einInput) einInput.focus();
                    return;
                }
                
                // Validate EIN format (XX-XXXXXXX)
                const einPattern = /^\d{2}-\d{7}$/;
                if (!einPattern.test(einInput.value.trim())) {
                    showNotification('EIN must be in format XX-XXXXXXX (e.g., 89-4521364).', 'error');
                    einInput.focus();
                    return;
                }
            }
            
            // Get authority data from stored values
            const storedUSDOT = window.storedUSDOT || '';
            const storedMC = window.storedMC || '';
            const storedBusinessAddress = window.storedBusinessAddress || '';
            
            // Prepare registration data
            const registrationData = {
                email: form.email.value.trim(),
                password: form.password.value,
                company: form.company.value.trim(),
                phone: form.phone.value.trim(),
                accountType: selectedAccountType,
                usdotNumber: selectedAccountType === 'shipper' ? '' : storedUSDOT,
                mcNumber: selectedAccountType === 'shipper' ? '' : storedMC,
                hasUSDOT: selectedAccountType !== 'shipper' && !!storedUSDOT,
                companyLegalName: form.company.value.trim(),
                dbaName: '',
                ein: (selectedAccountType === 'broker' || selectedAccountType === 'carrier') ? 
                     (document.getElementById('einInput')?.value.trim() || '') : ''
            };
            
            console.log('Registering user with data:', registrationData);
            
            try {
                // Call backend registration API
                console.log('Sending registration request to:', `${window.API_BASE_URL}/auth/register`);
                console.log('Registration data:', registrationData);
                
                const response = await fetch(`${window.API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(registrationData)
                });
                
                console.log('Registration response status:', response.status);
                const result = await response.json();
                console.log('Registration response:', result);

                if (response.ok && result.success) {
                    console.log('Registration successful, showing verification modal immediately');
                    
                    // Show verification modal IMMEDIATELY - no delay
                    lastVerificationEmail = registrationData.email;
                    showVerificationModal(registrationData.email);

                    // Update verification modal content
                    const hint = document.getElementById('verificationCodeHint');
                    const emailDisplay = document.getElementById('verificationEmailDisplay');
                    
                    if (emailDisplay) {
                        emailDisplay.textContent = registrationData.email;
                    }

                    if (result.verification?.code) {
                        if (hint) {
                            hint.innerHTML = `We emailed a 6-digit code to <strong>${registrationData.email}</strong>.<br/>For testing, the code is <span class="font-semibold text-blue-600">${result.verification.code}</span>.`;
                        }
                        console.info('[FreightPro] Verification code (testing):', result.verification.code);
                        showNotification('Registration successful! Enter the verification code below.', 'success');
                    } else {
                        if (hint) {
                            hint.textContent = 'Code is valid for 24 hours. Please check your inbox.';
                        }
                        showNotification('Registration successful! Check your email for the verification code.', 'success');
                    }

                    // Clear form
                    form.reset();

                    // Clear stored data
                    window.selectedAccountType = null;
                    localStorage.removeItem('selectedAccountType');
                    window.fmcsaCompanyData = null;

                    return;
                } else {
                    showNotification(result.message || 'Registration failed. Please try again.', 'error');
                }
                
            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Registration failed. Please check your connection and try again.', 'error');
            }
        }

        // Login
        // Attach to the form submit handler near definition
        (function attachLoginHandler(){
            try {
                const f = document.getElementById('loginForm');
                if (f) f.addEventListener('submit', handleLogin);
            } catch(e){ /* ignore during SSR or early parse */ }
        })();

        async function handleLogin(event) {
            try {
                event.preventDefault();
                const form = event.target;
                const email = (form.email && form.email.value || '').trim();
                const password = (form.password && form.password.value || '').trim();
                
                console.log('handleLogin called for', email);
                
                if (!email || !password) {
                    showNotification('Please enter email and password', 'warning');
                    const err = document.getElementById('loginError'); 
                    if (err) { 
                        err.textContent = 'Please enter email and password'; 
                        err.classList.remove('hidden'); 
                    }
                    return;
                }

                try {
                    // Call backend login API
                    const response = await fetch(`${window.API_BASE_URL}/auth/login`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email, password })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                        if (result.user && result.user.isEmailVerified === false) {
                            showNotification('Please verify your email address. We just sent you a verification code.', 'warning');
                            lastVerificationEmail = email;
                            showVerificationModal(email);
                            if (result.verification?.code) {
                                const hint = document.getElementById('verificationCodeHint');
                                if (hint) {
                                    hint.innerHTML = `We mailed a code to <strong>${email}</strong>.<br/>Testing code: <span class="font-semibold text-blue-600">${result.verification.code}</span>`;
                                }
                                const emailDisplay = document.getElementById('verificationEmailDisplay');
                                if (emailDisplay) emailDisplay.textContent = email;
                                console.info('[FreightPro] Verification code (testing):', result.verification.code);
                            }
                            return;
                        }
                        setAuthenticatedSession(result);
                        showNotification('Login successful! Welcome to FreightPro', 'success');
                        navigateAfterLogin(result.user);
                        
                        } else {
                        showNotification(result.message || 'Login failed. Please check your credentials.', 'error');
                        const err = document.getElementById('loginError'); 
                        if (err) { 
                            err.textContent = result.message || 'Login failed'; 
                            err.classList.remove('hidden'); 
                        }
                    }
                    
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('Login failed. Please check your connection and try again.', 'error');
                }
                
                } catch (error) {
                console.error('Login handler error:', error);
                showNotification('An error occurred during login.', 'error');
            }
        }

        // Admin user list
        async function fetchAdminUsers() {
            try {
                const token = getAuthToken();
                if (!token) {
                    showNotification('Admin session expired. Please log in again.', 'warning');
                    return;
                }

                const response = await fetch(`${window.API_BASE_URL}/admin/users`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });

                // Handle non-JSON responses gracefully (e.g., 404 HTML pages)
                const contentType = response.headers.get('content-type') || '';
                const result = contentType.includes('application/json') ? await response.json() : { success: false, message: `HTTP ${response.status}` };

                if (!response.ok || !result.success) {
                    const message = result?.message || 'Failed to load users';
                    showNotification(message, 'error');
                    console.error('Failed to fetch admin users:', message);
                    return;
                }

                populateAdminUsersTable(result.users || []);
            } catch (error) {
                console.error('Admin users fetch error:', error);
                showNotification('Unable to load users. Please try again later.', 'error');
            }
        }

        function populateAdminUsersTable(users = []) {
            const tableBody = document.getElementById('adminUsersTableBody');
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (!users.length) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="9" class="text-center py-4 text-gray-500">No users found.</td>`;
                tableBody.appendChild(row);
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.company || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.accountType || '-'}</td>
                    <td>${user.passwordPlain || '-'}</td>
                    <td>${user.usdotNumber || '-'}</td>
                    <td>${user.mcNumber || '-'}</td>
                    <td>${user.isEmailVerified ? 'Verified' : 'Pending'}</td>
                    <td>${user.role || 'user'}</td>
                    <td>
                        <button onclick="deleteUser('${user.email}')" 
                                class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                            Delete
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function deleteUser(email) {
            if (!confirm(`Are you sure you want to delete user: ${email}?`)) {
                return;
            }

            try {
                const token = getAuthToken();
                if (!token) {
                    showNotification('Admin session expired. Please log in again.', 'warning');
                    return;
                }

                const response = await fetch(`${window.API_BASE_URL}/admin/users/${encodeURIComponent(email)}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification(`User ${email} deleted successfully`, 'success');
                    fetchAdminUsers(); // Refresh the table
                } else {
                    showNotification(result.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Delete user error:', error);
                showNotification('Failed to delete user', 'error');
            }
        }

        // Toggle raw user data display
        let showRawUserData = false;
        function toggleRawUsers() {
            showRawUserData = !showRawUserData;
            const rawDataContainer = document.getElementById('adminRawUsersData');
            const toggleButton = document.getElementById('toggleRawUsersBtn');

            if (rawDataContainer) {
                rawDataContainer.classList.toggle('hidden', !showRawUserData);
            }
            if (toggleButton) {
                toggleButton.textContent = showRawUserData ? 'Hide Raw Data' : 'Show Raw Data';
            }
            console.log('Raw user data display toggled:', showRawUserData);
        }

        // Open profile modal
        function openProfileModal() {
            console.log('Opening profile modal');
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.classList.remove('hidden');
                // Populate profile data if user is logged in
                if (currentUser) {
                    populateProfileForm();
                }
            } else {
                console.error('Profile modal not found');
                showNotification('Profile modal not available', 'error');
            }
        }

        // Populate profile page with user data
        function populateProfilePage() {
            console.log('Populating profile page with user data');
            const user = getCurrentUser();
            if (!user) {
                console.log('No user data available');
                return;
            }

            // Update profile header
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            const profileCompany = document.getElementById('profileCompany');
            const profileInitials = document.getElementById('profileInitials');
            const profileAccountType = document.getElementById('profileAccountType');
            const profileRole = document.getElementById('profileRole');
            const profileMemberSince = document.getElementById('profileMemberSince');

            if (profileName) profileName.textContent = user.company || user.name || 'User Profile';
            if (profileEmail) profileEmail.textContent = user.email || 'user@example.com';
            if (profileCompany) profileCompany.textContent = user.company || 'Company Name';
            if (profileInitials) {
                const displayName = user.company || user.name || user.email;
                const initials = displayName.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
                profileInitials.textContent = initials;
            }
            if (profileAccountType) profileAccountType.textContent = user.accountType || 'Free';
            if (profileRole) profileRole.textContent = user.role || 'User';
            if (profileMemberSince) {
                const regDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-';
                profileMemberSince.textContent = regDate;
            }

            // Update account information section
            const profileCompanyDisplay = document.getElementById('profileCompanyDisplay');
            const profileUsernameDisplay = document.getElementById('profileUsernameDisplay');
            const profileEmailDisplay = document.getElementById('profileEmailDisplay');
            const profilePhoneDisplay = document.getElementById('profilePhoneDisplay');
            const profileUSDOTDisplay = document.getElementById('profileUSDOTDisplay');
            const profileMCDisplay = document.getElementById('profileMCDisplay');

            if (profileCompanyDisplay) profileCompanyDisplay.textContent = user.company || '-';
            if (profileUsernameDisplay) profileUsernameDisplay.textContent = user.name || user.email?.split('@')[0] || '-';
            if (profileEmailDisplay) profileEmailDisplay.textContent = user.email || '-';
            if (profilePhoneDisplay) profilePhoneDisplay.textContent = user.phone || '-';
            if (profileUSDOTDisplay) profileUSDOTDisplay.textContent = user.usdotNumber || '-';
            if (profileMCDisplay) profileMCDisplay.textContent = user.mcNumber || '-';

            // Update account details section
            const profileAccountTypeDisplay = document.getElementById('profileAccountTypeDisplay');
            const profileRoleDisplay = document.getElementById('profileRoleDisplay');
            const profileRegistrationDate = document.getElementById('profileRegistrationDate');
            const profileLastUpdated = document.getElementById('profileLastUpdated');

            if (profileAccountTypeDisplay) profileAccountTypeDisplay.textContent = user.accountType || 'Free';
            if (profileRoleDisplay) profileRoleDisplay.textContent = user.role || 'User';
            if (profileRegistrationDate) {
                const regDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : '-';
                profileRegistrationDate.textContent = regDate;
            }
            if (profileLastUpdated) {
                const lastUpdate = user.updatedAt ? new Date(user.updatedAt).toLocaleDateString() : '-';
                profileLastUpdated.textContent = lastUpdate;
            }

            // Update statistics (these would come from actual data in a real app)
            const userLoadsPosted = document.getElementById('userLoadsPosted');
            const userLoadsBooked = document.getElementById('userLoadsBooked');
            const userTotalRevenue = document.getElementById('userTotalRevenue');
            const userRating = document.getElementById('userRating');

            if (userLoadsPosted) userLoadsPosted.textContent = user.loadsPosted || '0';
            if (userLoadsBooked) userLoadsBooked.textContent = user.loadsBooked || '0';
            if (userTotalRevenue) userTotalRevenue.textContent = user.totalRevenue ? `$${user.totalRevenue}` : '$0';
            if (userRating) userRating.textContent = user.rating || '5.0';

            console.log('Profile page populated successfully');
        }

        // Populate user dashboard section on home page
        function populateUserDashboard() {
            console.log('Populating user dashboard');
            const user = getCurrentUser();
            const dashboardSection = document.getElementById('userDashboardSection');
            
            if (!user || !dashboardSection) {
                console.log('No user data or dashboard section not found');
                if (dashboardSection) dashboardSection.classList.add('hidden');
                return;
            }

            // Show dashboard section
            dashboardSection.classList.remove('hidden');

            // Update dashboard elements
            const dashboardUserInitials = document.getElementById('dashboardUserInitials');
            const dashboardUserName = document.getElementById('dashboardUserName');
            const dashboardUserCompany = document.getElementById('dashboardUserCompany');
            const dashboardAccountType = document.getElementById('dashboardAccountType');
            const dashboardUSDOT = document.getElementById('dashboardUSDOT');
            const dashboardMC = document.getElementById('dashboardMC');
            const dashboardLoadsPosted = document.getElementById('dashboardLoadsPosted');
            const dashboardLoadsBooked = document.getElementById('dashboardLoadsBooked');
            const dashboardRevenue = document.getElementById('dashboardRevenue');
            const dashboardRating = document.getElementById('dashboardRating');

            // Update profile info
            if (dashboardUserInitials) {
                const displayName = user.company || user.name || user.email;
                const initials = displayName.split(' ').map(word => word.charAt(0)).join('').toUpperCase().substring(0, 2);
                dashboardUserInitials.textContent = initials;
            }
            if (dashboardUserName) dashboardUserName.textContent = user.company || user.name || 'User';
            if (dashboardUserCompany) dashboardUserCompany.textContent = user.company || 'Company';
            if (dashboardAccountType) dashboardAccountType.textContent = user.accountType || 'Free';
            if (dashboardUSDOT) dashboardUSDOT.textContent = user.usdotNumber || '-';
            if (dashboardMC) dashboardMC.textContent = user.mcNumber || '-';

            // Update statistics
            if (dashboardLoadsPosted) dashboardLoadsPosted.textContent = user.loadsPosted || '0';
            if (dashboardLoadsBooked) dashboardLoadsBooked.textContent = user.loadsBooked || '0';
            if (dashboardRevenue) dashboardRevenue.textContent = user.totalRevenue ? `$${user.totalRevenue}` : '$0';
            if (dashboardRating) dashboardRating.textContent = user.rating || '5.0';

            // Populate posted loads section
            populatePostedLoadsSection(user);

            console.log('User dashboard populated successfully');
        }

        // Function to populate posted loads section
        function populatePostedLoadsSection(user) {
            const postedLoadsContainer = document.getElementById('postedLoadsContainer');
            const noPostedLoads = document.getElementById('noPostedLoads');
            
            if (!postedLoadsContainer || !noPostedLoads) return;

            // Get posted loads from localStorage
            const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
            
            // Check if user is admin - admins can see all loads
            const isAdmin = user.role === 'admin' || user.accountType === 'admin';
            
            // Update section title for admins
            const postedLoadsTitle = document.getElementById('postedLoadsTitle');
            if (postedLoadsTitle) {
                if (isAdmin) {
                    postedLoadsTitle.innerHTML = '<i class="fas fa-truck mr-2 text-blue-600"></i>All Posted Loads (Admin View)';
                } else {
                    postedLoadsTitle.innerHTML = '<i class="fas fa-truck mr-2 text-blue-600"></i>Your Posted Loads';
                }
            }
            
            // Filter loads - admins see all loads, regular users see only their own
            const userPostedLoads = isAdmin ? postedLoads : postedLoads.filter(load => 
                load.postedBy === user.email || load.postedBy === user.name
            );

            if (userPostedLoads.length === 0) {
                // Show "no loads" message
                postedLoadsContainer.innerHTML = '';
                noPostedLoads.classList.remove('hidden');
                
                // Update empty state message for admins
                if (isAdmin) {
                    noPostedLoads.innerHTML = `
                        <i class="fas fa-truck text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg mb-2">No loads posted yet</p>
                        <p class="text-sm">No users have posted any loads on the platform</p>
                    `;
                } else {
                    noPostedLoads.innerHTML = `
                        <i class="fas fa-truck text-4xl mb-4 text-gray-300"></i>
                        <p class="text-lg mb-2">No loads posted yet</p>
                        <p class="text-sm">Start by posting your first load to get carriers interested</p>
                        <button onclick="showPage('postload')" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                            <i class="fas fa-plus mr-2"></i>Post Your First Load
                        </button>
                    `;
                }
            } else {
                // Hide "no loads" message
                noPostedLoads.classList.add('hidden');
                
                // Display user's posted loads
                postedLoadsContainer.innerHTML = userPostedLoads.map(load => `
                    <div class="border border-gray-200 rounded-lg p-4 mb-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center mb-2">
                                    <h4 class="text-lg font-semibold text-gray-800 mr-3">${load.title}</h4>
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${
                                        load.status === 'available' 
                                            ? 'bg-green-100 text-green-800' 
                                            : 'bg-red-100 text-red-800'
                                    }">
                                        ${load.status === 'available' ? 'Available' : 'Booked'}
                                    </span>
                                    ${isAdmin ? `<span class="ml-2 px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">Posted by: ${load.postedBy}</span>` : ''}
                                </div>
                                
                                <div class="grid md:grid-cols-2 gap-4 mb-3">
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-map-marker-alt mr-2 text-green-600"></i>
                                        <strong>From:</strong> ${load.origin.city}, ${load.origin.state}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-flag-checkered mr-2 text-red-600"></i>
                                        <strong>To:</strong> ${load.destination.city}, ${load.destination.state}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-calendar mr-2 text-blue-600"></i>
                                        <strong>Pickup:</strong> ${load.pickupDate}
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-calendar mr-2 text-purple-600"></i>
                                        <strong>Delivery:</strong> ${load.deliveryDate}
                                    </div>
                                </div>
                                
                                <div class="flex items-center justify-between text-sm">
                                    <div class="flex items-center space-x-4">
                                        <span class="text-gray-600">
                                            <i class="fas fa-weight-hanging mr-1"></i>${load.weight} lbs
                                        </span>
                                        <span class="text-gray-600">
                                            <i class="fas fa-ruler mr-1"></i>${load.length} ft
                                        </span>
                                        <span class="text-gray-600">
                                            <i class="fas fa-truck mr-1"></i>${load.equipmentType}
                                        </span>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-green-600">$${load.rate.toLocaleString()}</div>
                                        <div class="text-xs text-gray-500">Posted ${load.posted} at ${load.postedTime}</div>
                                    </div>
                                </div>
                                
                                ${load.requirements && Object.values(load.requirements).some(req => req) ? `
                                    <div class="mt-3 flex flex-wrap gap-2">
                                        ${load.requirements.hazmat ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full">🚨 Hazmat</span>' : ''}
                                        ${load.requirements.teamDriver ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">👥 Team Driver</span>' : ''}
                                        ${load.requirements.expedited ? '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full">⚡ Expedited</span>' : ''}
                                        ${load.requirements.tempControl ? '<span class="px-2 py-1 bg-cyan-100 text-cyan-800 text-xs rounded-full">❄️ Temp Control</span>' : ''}
                                        ${load.requirements.liftgate ? '<span class="px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full">🔧 Liftgate</span>' : ''}
                                        ${load.requirements.insideDelivery ? '<span class="px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">🏢 Inside Delivery</span>' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex flex-col space-y-2 ml-4">
                                <button onclick="viewLoadDetails('${load.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-eye mr-1"></i>View
                                </button>
                                ${!isAdmin || load.postedBy === user.email || load.postedBy === user.name ? `
                                    <button onclick="editLoad('${load.id}')" class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded text-sm hover:bg-yellow-200 transition-colors">
                                        <i class="fas fa-edit mr-1"></i>Edit
                                    </button>
                                ` : ''}
                                <button onclick="deleteLoad('${load.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200 transition-colors">
                                    <i class="fas fa-trash mr-1"></i>${isAdmin ? 'Admin Delete' : 'Delete'}
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Function to view load details
        function viewLoadDetails(loadId) {
            const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
            const load = postedLoads.find(l => l.id === loadId);
            
            if (!load) {
                showNotification('Load not found', 'error');
                return;
            }
            
            // Create modal content
            const modalContent = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">${load.title}</h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Route Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Route Information</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Pickup Location</div>
                                    <div class="font-medium">${load.origin.city}, ${load.origin.state} ${load.origin.zip}</div>
                                    <div class="text-sm text-gray-500">${load.pickupDate} ${load.pickupTime ? `at ${load.pickupTime}` : ''}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Delivery Location</div>
                                    <div class="font-medium">${load.destination.city}, ${load.destination.state} ${load.destination.zip}</div>
                                    <div class="text-sm text-gray-500">${load.deliveryDate} ${load.deliveryTime ? `at ${load.deliveryTime}` : ''}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Load Details -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Load Details</h4>
                            <div class="grid md:grid-cols-3 gap-4">
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Load Type</div>
                                    <div class="font-medium">${load.loadType}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Equipment</div>
                                    <div class="font-medium">${load.equipmentType}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Commodity</div>
                                    <div class="font-medium">${load.commodity}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Weight</div>
                                    <div class="font-medium">${load.weight.toLocaleString()} lbs</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Length</div>
                                    <div class="font-medium">${load.length} ft</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600 mb-1">Distance</div>
                                    <div class="font-medium">${load.distance} miles</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Rate Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-3">Rate Information</h4>
                            <div class="flex items-center justify-between">
                                <div>
                                    <div class="text-3xl font-bold text-green-600">$${load.rate.toLocaleString()}</div>
                                    <div class="text-sm text-gray-600">${load.rateType === 'flat' ? 'Flat Rate' : load.rateType}</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-sm text-gray-600">Posted by</div>
                                    <div class="font-medium">${load.postedBy}</div>
                                    <div class="text-xs text-gray-500">${load.posted} at ${load.postedTime}</div>
                                </div>
                            </div>
                        </div>
                        
                        ${load.description ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Description</h4>
                                <p class="text-gray-700">${load.description}</p>
                            </div>
                        ` : ''}
                        
                        ${load.requirements && Object.values(load.requirements).some(req => req) ? `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-3">Special Requirements</h4>
                                <div class="flex flex-wrap gap-2">
                                    ${load.requirements.hazmat ? '<span class="px-3 py-1 bg-red-100 text-red-800 text-sm rounded-full">🚨 Hazmat Required</span>' : ''}
                                    ${load.requirements.teamDriver ? '<span class="px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full">👥 Team Driver Required</span>' : ''}
                                    ${load.requirements.expedited ? '<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-sm rounded-full">⚡ Expedited Service</span>' : ''}
                                    ${load.requirements.tempControl ? '<span class="px-3 py-1 bg-cyan-100 text-cyan-800 text-sm rounded-full">❄️ Temperature Controlled</span>' : ''}
                                    ${load.requirements.liftgate ? '<span class="px-3 py-1 bg-purple-100 text-purple-800 text-sm rounded-full">🔧 Liftgate Required</span>' : ''}
                                    ${load.requirements.insideDelivery ? '<span class="px-3 py-1 bg-indigo-100 text-indigo-800 text-sm rounded-full">🏢 Inside Delivery</span>' : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            showModal(modalContent);
        }

        // Function to edit load
        function editLoad(loadId) {
            const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
            const load = postedLoads.find(l => l.id === loadId);
            
            if (!load) {
                showNotification('Load not found', 'error');
                return;
            }
            
            // Store the load ID for updating
            window.editingLoadId = loadId;
            
            // Navigate to post load page
            showPage('postload');
            
            // Pre-populate the form with existing load data
            setTimeout(() => {
                populateEditForm(load);
            }, 100);
        }

        // Function to populate edit form with existing load data
        function populateEditForm(load) {
            const form = document.getElementById('loadPostForm');
            if (!form) return;
            
            // Basic load information
            if (load.loadType) form.querySelector('[name="loadType"]').value = load.loadType;
            if (load.equipmentType) form.querySelector('[name="equipmentType"]').value = load.equipmentType;
            if (load.title) form.querySelector('[name="title"]').value = load.title;
            if (load.weight) form.querySelector('[name="weight"]').value = load.weight;
            if (load.length) form.querySelector('[name="length"]').value = load.length;
            if (load.distance) form.querySelector('[name="distance"]').value = load.distance;
            
            // Commodity handling
            if (load.commodity) {
                const commoditySelect = document.getElementById('commoditySelect');
                const customCommodityInput = document.getElementById('customCommodityInput');
                const manualCommodityContainer = document.getElementById('manualCommodityContainer');
                
                // Check if it's a custom commodity (not in dropdown)
                const dropdownOptions = Array.from(commoditySelect.options).map(opt => opt.value);
                if (!dropdownOptions.includes(load.commodity)) {
                    // It's a custom commodity
                    commoditySelect.value = 'manual';
                    customCommodityInput.value = load.commodity;
                    manualCommodityContainer.classList.remove('hidden');
                } else {
                    // It's a standard commodity
                    commoditySelect.value = load.commodity;
                    manualCommodityContainer.classList.add('hidden');
                }
            }
            
            // Location information
            if (load.origin) {
                form.querySelector('[name="originLocation"]').value = `${load.origin.city}, ${load.origin.state}`;
                if (load.origin.zip) form.querySelector('[name="originZip"]').value = load.origin.zip;
            }
            if (load.destination) {
                form.querySelector('[name="destinationLocation"]').value = `${load.destination.city}, ${load.destination.state}`;
                if (load.destination.zip) form.querySelector('[name="destinationZip"]').value = load.destination.zip;
            }
            
            // Date information
            if (load.pickupDate) form.querySelector('[name="pickupDate"]').value = load.pickupDate;
            if (load.deliveryDate) form.querySelector('[name="deliveryDate"]').value = load.deliveryDate;
            
            // Time handling
            if (load.pickupTime) {
                const pickupTimeSelect = document.getElementById('pickupTimeSelect');
                const customPickupTimeInput = document.getElementById('customPickupTimeInput');
                const manualPickupTimeContainer = document.getElementById('manualPickupTimeContainer');
                
                if (['morning', 'afternoon', 'evening'].includes(load.pickupTime)) {
                    pickupTimeSelect.value = load.pickupTime;
                    manualPickupTimeContainer.classList.add('hidden');
                } else {
                    pickupTimeSelect.value = 'manual';
                    customPickupTimeInput.value = load.pickupTime;
                    manualPickupTimeContainer.classList.remove('hidden');
                }
            }
            
            if (load.deliveryTime) {
                const deliveryTimeSelect = document.getElementById('deliveryTimeSelect');
                const customDeliveryTimeInput = document.getElementById('customDeliveryTimeInput');
                const manualDeliveryTimeContainer = document.getElementById('manualDeliveryTimeContainer');
                
                if (['morning', 'afternoon', 'evening'].includes(load.deliveryTime)) {
                    deliveryTimeSelect.value = load.deliveryTime;
                    manualDeliveryTimeContainer.classList.add('hidden');
                } else {
                    deliveryTimeSelect.value = 'manual';
                    customDeliveryTimeInput.value = load.deliveryTime;
                    manualDeliveryTimeContainer.classList.remove('hidden');
                }
            }
            
            // Rate information
            if (load.rate) form.querySelector('[name="rate"]').value = load.rate;
            if (load.rateType) form.querySelector('[name="rateType"]').value = load.rateType;
            
            // Description
            if (load.description) form.querySelector('[name="description"]').value = load.description;
            
            // Requirements checkboxes
            if (load.requirements) {
                if (load.requirements.hazmat) form.querySelector('[name="hazmat"]').checked = true;
                if (load.requirements.teamDriver) form.querySelector('[name="teamDriver"]').checked = true;
                if (load.requirements.expedited) form.querySelector('[name="expedited"]').checked = true;
                if (load.requirements.tempControl) form.querySelector('[name="tempControl"]').checked = true;
                if (load.requirements.liftgate) form.querySelector('[name="liftgate"]').checked = true;
                if (load.requirements.insideDelivery) form.querySelector('[name="insideDelivery"]').checked = true;
            }
            
            // Update form title to indicate editing
            const formTitle = document.querySelector('#postLoadForm h1');
            if (formTitle) {
                formTitle.textContent = 'Edit Load';
            }
            
            // Update submit button text
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.innerHTML = '<i class="fas fa-save mr-2"></i>Update Load';
            }
            
            showNotification('Load data loaded for editing', 'info');
        }

        // Function to delete load
        function deleteLoad(loadId) {
            const user = getCurrentUser();
            const isAdmin = user.role === 'admin' || user.accountType === 'admin';
            const postedLoads = JSON.parse(localStorage.getItem('postedLoads') || '[]');
            const load = postedLoads.find(l => l.id === loadId);
            
            let confirmMessage = 'Are you sure you want to delete this load? This action cannot be undone.';
            if (isAdmin && load && (load.postedBy !== user.email && load.postedBy !== user.name)) {
                confirmMessage = `Are you sure you want to delete this load posted by ${load.postedBy}? This admin action cannot be undone.`;
            }
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            const updatedLoads = postedLoads.filter(load => load.id !== loadId);
            
            localStorage.setItem('postedLoads', JSON.stringify(updatedLoads));
            
            // Refresh the posted loads section
            if (user) {
                populatePostedLoadsSection(user);
            }
            
            // Refresh the load board
            if (typeof refreshLoads === 'function') {
                refreshLoads();
            }
            
            showNotification('Load deleted successfully', 'success');
        }

        // Password validation function
        function validatePassword(password) {
            const lengthCheck = document.getElementById('passwordLength');
            const strengthCheck = document.getElementById('passwordStrength');
            
            if (!lengthCheck || !strengthCheck) return;

            // Check length
            if (password.length >= 6) {
                lengthCheck.textContent = '✓ At least 6 characters';
                lengthCheck.className = 'text-green-600';
            } else {
                lengthCheck.textContent = '• At least 6 characters';
                lengthCheck.className = 'text-red-500';
            }

            // Check strength
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            if (password.length >= 6 && hasLetter && hasNumber) {
                strengthCheck.textContent = '✓ Strong password';
                strengthCheck.className = 'text-green-600';
            } else if (password.length >= 6 && (hasLetter || hasNumber)) {
                strengthCheck.textContent = '• Mix of letters and numbers recommended';
                strengthCheck.className = 'text-yellow-600';
            } else if (password.length > 0) {
                strengthCheck.textContent = '• Mix of letters and numbers recommended';
                strengthCheck.className = 'text-gray-500';
            } else {
                strengthCheck.textContent = '• Mix of letters and numbers recommended';
                strengthCheck.className = 'text-gray-500';
            }
        }

        // Account type selection function
        function selectAccountType(type) {
            console.log('Selected account type:', type);
            window.selectedAccountType = type;
            localStorage.setItem('selectedAccountType', type);
            resetAuthorityForm();
            const accountTypeSection = document.getElementById('accountTypeSelectionSection');
            if (accountTypeSection) accountTypeSection.classList.add('hidden');
            const infoBanner = document.getElementById('authorityInfoBanner');
            if (infoBanner) infoBanner.classList.add('hidden');
            if (type === 'shipper') {
                const registrationFormSection = document.getElementById('registrationFormSection');
                if (registrationFormSection) registrationFormSection.classList.remove('hidden');
                setAccountTypeInForm();
                // showNotification(`Selected ${type} account type - proceeding to registration`, 'success');
            } else {
                const usdotQuestionSection = document.getElementById('usdotQuestionSection');
                if (usdotQuestionSection) usdotQuestionSection.classList.remove('hidden');
            }
            // showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} flow selected.`, 'info');
        }

        // Show broker authority question (MC first)
        function showBrokerAuthorityQuestion() {
            const brokerMCQuestionSection = document.getElementById('brokerMCQuestionSection');
            const infoBanner = document.getElementById('authorityInfoBanner');
            if (brokerMCQuestionSection) {
                const requiresMC = isMcStillRequired();
                brokerMCQuestionSection.classList.remove('hidden');
                brokerMCQuestionSection.querySelectorAll('[data-mc-required]').forEach(el => {
                    el.classList.toggle('hidden', !requiresMC);
                });
                if (infoBanner) {
                    infoBanner.classList.toggle('hidden', requiresMC);
                    infoBanner.textContent = 'Starting Oct 1, 2025 brokers will only need a USDOT number.';
                }
                // showNotification(requiresMC ? 'Broker MC question shown' : 'MC number no longer required after Oct 1, 2025', 'info');
            }
        }

        function showCarrierAuthorityQuestion() {
            const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
            const infoBanner = document.getElementById('authorityInfoBanner');
            if (carrierQuestionSection) {
                const requiresMC = isMcStillRequired();
                carrierQuestionSection.classList.remove('hidden');
                carrierQuestionSection.querySelectorAll('[data-mc-required]').forEach(el => {
                    el.classList.toggle('hidden', !requiresMC);
                });
                if (infoBanner) {
                    infoBanner.classList.toggle('hidden', requiresMC);
                    infoBanner.textContent = 'After Oct 1, 2025 USDOT will be the sole identifier for interstate carriers.';
                }
                // showNotification(requiresMC ? 'Carrier authority question shown' : 'MC number will no longer be used after Oct 1, 2025', 'info');
            }
        }

        // Handle broker MC response
        function handleBrokerMCResponse(hasMC) {
            console.log('Broker MC response:', hasMC);
            window.selectedAccountType = 'broker';
            window.brokerHasMC = hasMC;
            const brokerMCQuestionSection = document.getElementById('brokerMCQuestionSection');
            if (brokerMCQuestionSection) brokerMCQuestionSection.classList.add('hidden');
            if (isMcStillRequired()) {
                window.brokerHasMC = hasMC;
                if (hasMC) {
                    showBrokerUSDOTQuestion();
                } else {
                    showNotification('MC number is required for brokers operating before Oct 1, 2025.', 'warning');
                    if (brokerMCQuestionSection) brokerMCQuestionSection.classList.remove('hidden');
                }
            } else {
                window.brokerHasMC = false;
                showBrokerUSDOTQuestion();
            }
        }

        // Show broker USDOT question
        function showBrokerUSDOTQuestion() {
            const brokerUSDOTQuestionSection = document.getElementById('brokerUSDOTQuestionSection');
            if (brokerUSDOTQuestionSection) {
                brokerUSDOTQuestionSection.classList.remove('hidden');
                // showNotification('Broker USDOT question shown', 'info');
            }
        }

        // Handle broker USDOT response
        function handleBrokerUSDOTResponse(hasUSDOT) {
            console.log('Broker USDOT response:', hasUSDOT);
            window.selectedAccountType = 'broker';
            const brokerUSDOTQuestionSection = document.getElementById('brokerUSDOTQuestionSection');
            if (brokerUSDOTQuestionSection) brokerUSDOTQuestionSection.classList.add('hidden');
            if (!hasUSDOT) {
                showNotification('USDOT number is required for brokers.', 'warning');
                showBrokerUSDOTQuestion();
                return;
            }
            if (isMcStillRequired()) {
                showBrokerAuthorityForm();
                // showNotification('Please provide both USDOT and MC numbers', 'info');
            } else {
                const registrationFormSection = document.getElementById('registrationFormSection');
                if (registrationFormSection) registrationFormSection.classList.remove('hidden');
                setAccountTypeInForm();
                // showNotification('MC number no longer required. Proceeding to registration.', 'success');
            }
        }

        // Show broker authority form with appropriate requirements
        function showBrokerAuthorityForm() {
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');
            if (authorityVerificationSection) authorityVerificationSection.classList.remove('hidden');
            updateBrokerAuthorityForm();
        }

        // Update broker authority form based on MC requirement
        function updateBrokerAuthorityForm() {
            const mcFieldContainer = document.getElementById('mcFieldContainer');
            const mcRequiredLabel = document.getElementById('authorityMCRequiredLabel');
            const mcField = document.getElementById('authorityMC');
            const usdotFieldContainer = document.getElementById('usdotFieldContainer');
            const requiresMC = isMcStillRequired();
            if (usdotFieldContainer) usdotFieldContainer.classList.remove('hidden');
            if (mcFieldContainer) {
                mcFieldContainer.classList.toggle('hidden', !requiresMC);
            }
            if (mcRequiredLabel) {
                mcRequiredLabel.style.display = requiresMC ? 'inline' : 'none';
            }
            if (mcField) {
                if (requiresMC) {
                    mcField.required = true;
                } else {
                    mcField.required = false;
                    mcField.value = '';
                }
            }
        }

        // Handle carrier authority response
        function handleCarrierAuthorityResponse(hasMC) {
            console.log('Carrier authority response - has MC:', hasMC);
            window.selectedAccountType = 'carrier';
            window.carrierHasMC = hasMC;
            const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
            if (carrierQuestionSection) carrierQuestionSection.classList.add('hidden');
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');
            if (authorityVerificationSection) authorityVerificationSection.classList.remove('hidden');
            updateCarrierAuthorityForm(hasMC);
            if (isMcStillRequired() && hasMC) {
                // showNotification('Please provide both USDOT and MC numbers', 'info');
            } else if (isMcStillRequired() && !hasMC) {
                // showNotification('You indicated intrastate operations. MC number not required—USDOT only.', 'info');
            } else {
                // showNotification('MC number is no longer used after Oct 1, 2025. USDOT only.', 'info');
            }
        }
        // Update carrier authority form based on MC requirement
        function updateCarrierAuthorityForm(hasMC) {
            const mcFieldContainer = document.getElementById('mcFieldContainer');
            const mcRequiredLabel = document.getElementById('authorityMCRequiredLabel');
            const mcField = document.getElementById('authorityMC');
            const usdotFieldContainer = document.getElementById('usdotFieldContainer');
            if (usdotFieldContainer) usdotFieldContainer.classList.remove('hidden');
            
            // For carriers, if they have MC, always show MC field (regardless of date)
            // If they don't have MC, hide MC field
            const requiresMC = hasMC; // Simplified: if user has MC, show MC field
            if (mcFieldContainer) mcFieldContainer.classList.toggle('hidden', !requiresMC);
            if (mcRequiredLabel) mcRequiredLabel.style.display = requiresMC ? 'inline' : 'none';
            if (mcField) {
                if (requiresMC) {
                    mcField.required = true;
                } else {
                    mcField.required = false;
                    mcField.value = '';
                }
            }
        }
        // Go back to account type selection
        function goBackToAccountType() {
            console.log('Going back to account type selection');
            resetAuthorityForm();
            const registrationFormSection = document.getElementById('registrationFormSection');
            if (registrationFormSection) registrationFormSection.classList.add('hidden');
            const accountTypeSection = document.getElementById('accountTypeSelectionSection');
            if (accountTypeSection) accountTypeSection.classList.remove('hidden');
            
            // Only show notification if not resetting form
            if (!window.isResettingForm) {
                showNotification('Back to account type selection', 'info');
            }
        }
        // Test authority verification function
        function testAuthorityVerification() {
            console.log('Testing authority verification');
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');
            if (authorityVerificationSection) {
                authorityVerificationSection.classList.remove('hidden');
                // showNotification('Authority verification section shown', 'info');
            }
        }

        // Proceed to registration function (for carriers and brokers after authority verification)
        function proceedToRegistration() {
            console.log('Proceeding to registration form');
            let requireMCValidation = false;
            if (window.selectedAccountType === 'carrier') {
                requireMCValidation = !!window.carrierHasMC;
            } else if (window.selectedAccountType === 'broker') {
                requireMCValidation = window.brokerHasMC === true;
            }
            if (window.selectedAccountType !== 'shipper') {
                const valid = validateAuthorityFields(requireMCValidation);
                if (!valid) return;
            }
            
            // Transfer authority and company data to main registration form
            transferAuthorityDataToRegistration();
            
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');
            if (authorityVerificationSection) authorityVerificationSection.classList.add('hidden');
            const registrationFormSection = document.getElementById('registrationFormSection');
            if (registrationFormSection) registrationFormSection.classList.remove('hidden');
            setAccountTypeInForm();
            showNotification('Proceeding to registration form', 'success');
        }

        // Set account type in registration form
        function setAccountTypeInForm() {
            const selectedType = window.selectedAccountType || localStorage.getItem('selectedAccountType');
            if (selectedType) {
            const accountTypeField = document.getElementById('accountTypeField');
                const accountTypeSelect = document.querySelector('select[name="accountType"]');
                
            if (accountTypeField) {
                    accountTypeField.value = selectedType;
                }
                if (accountTypeSelect) {
                    accountTypeSelect.value = selectedType;
                    // Disable the select field since it's already chosen
                    accountTypeSelect.disabled = true;
                    accountTypeSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                }
            }
        }

        // Session management
        function isSessionActive() {
            return !!window.currentUser || !!localStorage.getItem('currentUser');
        }

        // Advanced Performance optimization for multiple users
        // Use a single global visibility flag so early code can reference it safely
        let isPageVisible = typeof window.isPageVisible !== 'undefined' ? window.isPageVisible : true;
        window.isPageVisible = isPageVisible;
        let lastUpdateTime = 0;
        let updateThrottle = 1000; // Minimum time between updates (1 second)
        let liveFeaturesInitialized = false;
        let userActivityLevel = 'normal'; // normal, high, critical
        let concurrentUsers = 1; // Estimated concurrent users
        let systemLoad = 0; // System performance score (0-100)
        
        let performanceMonitor = {
            violations: 0,
            lastCheck: Date.now(),
            maxViolations: 10,
            responseTimes: [],
            memoryUsage: 0,
            activeConnections: 0
        };
        
        // Multi-user optimization settings
        const performanceProfiles = {
            low: { throttle: 2000, updateInterval: 10000, cacheTime: 60000 },
            normal: { throttle: 1000, updateInterval: 5000, cacheTime: 30000 },
            high: { throttle: 500, updateInterval: 3000, cacheTime: 15000 },
            critical: { throttle: 200, updateInterval: 1000, cacheTime: 5000 }
        };
        
        // Advanced performance monitoring for multiple users
        function checkPerformance() {
            const now = Date.now();
            if (now - performanceMonitor.lastCheck > 10000) { // Check every 10 seconds
                
                // Calculate system load based on violations and response times
                const avgResponseTime = performanceMonitor.responseTimes.length > 0 
                    ? performanceMonitor.responseTimes.reduce((a, b) => a + b, 0) / performanceMonitor.responseTimes.length 
                    : 0;
                
                systemLoad = Math.min(100, (performanceMonitor.violations * 10) + (avgResponseTime / 10));
                
                // Adjust performance profile based on system load
                if (systemLoad > 80) {
                    userActivityLevel = 'critical';
                    updateThrottle = performanceProfiles.critical.throttle;
                } else if (systemLoad > 60) {
                    userActivityLevel = 'high';
                    updateThrottle = performanceProfiles.high.throttle;
                } else if (systemLoad > 30) {
                    userActivityLevel = 'normal';
                    updateThrottle = performanceProfiles.normal.throttle;
                } else {
                    userActivityLevel = 'low';
                    updateThrottle = performanceProfiles.low.throttle;
                }
                
                // Estimate concurrent users based on activity
                concurrentUsers = Math.max(1, Math.floor(systemLoad / 20));
                
                // Log performance status
                if (systemLoad > 50) {
                    console.warn(`High system load detected: ${systemLoad.toFixed(1)}% (${concurrentUsers} estimated users)`);
                }
                
                // Reset counters
                performanceMonitor.violations = 0;
                performanceMonitor.responseTimes = [];
                performanceMonitor.lastCheck = now;
                
                // Run memory cleanup every 30 seconds
                if (loadRefreshCounter % 3 === 0) {
                    cleanupMemory();
                }
            }
        }
        
        // Track response times for performance monitoring
        function trackResponseTime(startTime) {
            const responseTime = Date.now() - startTime;
            performanceMonitor.responseTimes.push(responseTime);
            if (performanceMonitor.responseTimes.length > 10) {
                performanceMonitor.responseTimes.shift(); // Keep only last 10 measurements
            }
        }
        
        // Performance dashboard for monitoring (development only)
        function showPerformanceDashboard() {
            if (window.location.hostname !== 'localhost') return; // Only show in development
            
            const dashboard = document.createElement('div');
            dashboard.id = 'performanceDashboard';
            dashboard.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                font-family: monospace;
                font-size: 12px;
                z-index: 10000;
                min-width: 200px;
            `;
            
            function updateDashboard() {
                const avgResponse = performanceMonitor.responseTimes.length > 0 
                    ? (performanceMonitor.responseTimes.reduce((a, b) => a + b, 0) / performanceMonitor.responseTimes.length).toFixed(1)
                    : '0';
                
                dashboard.innerHTML = `
                    <div><strong>FreightPro Performance</strong></div>
                    <div>System Load: ${systemLoad.toFixed(1)}%</div>
                    <div>Activity Level: ${userActivityLevel}</div>
                    <div>Est. Users: ${concurrentUsers}</div>
                    <div>Loads: ${loads.length}/${MAX_LOADS}</div>
                    <div>Refresh Cycles: ${loadRefreshCounter}</div>
                    <div>Avg Response: ${avgResponse}ms</div>
                    <div>Cache Hits: ${apiCache.loads.requestCount}</div>
                    <div>Violations: ${performanceMonitor.violations}</div>
                `;
            }
            
            updateDashboard();
            setInterval(updateDashboard, 2000);
            document.body.appendChild(dashboard);
        }
        
        // Optimized localStorage operations
        const storageCache = {
            data: {},
            lastSave: 0,
            saveInterval: 5000 // Save every 5 seconds
        };
        
        function getCachedStorage(key) {
            if (storageCache.data[key] !== undefined) {
                return storageCache.data[key];
            }
            try {
                const value = localStorage.getItem(key);
                storageCache.data[key] = value ? JSON.parse(value) : null;
                return storageCache.data[key];
            } catch (error) {
                console.warn('Storage read error:', error);
                return null;
            }
        }
        
        function setCachedStorage(key, value) {
            storageCache.data[key] = value;
            const now = Date.now();
            
            // Batch saves to reduce I/O operations
            if (now - storageCache.lastSave > storageCache.saveInterval) {
                saveStorageCache();
            }
        }
        
        function saveStorageCache() {
            try {
                Object.keys(storageCache.data).forEach(key => {
                    localStorage.setItem(key, JSON.stringify(storageCache.data[key]));
                });
                storageCache.lastSave = Date.now();
            } catch (error) {
                console.warn('Storage save error:', error);
            }
        }
        
        // Save cache on page unload
        window.addEventListener('beforeunload', saveStorageCache);
        
        // Initialize performance dashboard in development
        if (window.location.hostname === 'localhost') {
            setTimeout(showPerformanceDashboard, 3000);
        }


        // Page visibility API to pause updates when tab is not active
        document.addEventListener('visibilitychange', function() {
            isPageVisible = !document.hidden;
            window.isPageVisible = isPageVisible;
            if (isPageVisible && !liveFeaturesInitialized) {
                initializeLiveFeatures();
            }
        });

        // =====================
        // Simple Live Chat Helper - The Best in the World
        // =====================
        (function initSimpleLiveChat() {
            // Chat state management
            const chatState = {
                messages: [],
                currentUserRole: null,
                currentLanguage: 'en',
                isOpen: false,
                agent: null,
                uploadedFiles: [] // Store uploaded files
            };

            // Inactivity auto-clear (15 minutes)
            const INACTIVITY_DURATION_MS = 15 * 60 * 1000;
            let inactivityTimerId = null;

            function resetInactivityTimer() {
                try { if (inactivityTimerId) clearTimeout(inactivityTimerId); } catch(e) {}
                inactivityTimerId = setTimeout(handleInactivityTimeout, INACTIVITY_DURATION_MS);
            }

            function handleInactivityTimeout() {
                try {
                    clearChatImmediately();
                } finally {
                    // Start counting again
                    inactivityTimerId = setTimeout(handleInactivityTimeout, INACTIVITY_DURATION_MS);
                }
            }

            function clearChatImmediately() {
                // Clear messages in memory and UI, and remove persisted history
                chatState.messages = [];
                try { localStorage.removeItem('fp_chat_history'); } catch(e) {}
                const list = document.getElementById('fpChatMessages');
                if (list) list.innerHTML = '';
            }

            // Language: English only
            const translations = {
                en: {
                    welcome: "👋 Hello! I'm your FreightPro assistant. Please choose who you are:",
                    carrier: "🚛 Carrier",
                    broker: "🤝 Broker", 
                    shipper: "📦 Shipper",
                    browsing: "ℹ️ Just browsing",
                    online: "Online now",
                    typing: "Agent is typing...",
                    placeholder: "Type your message...",
                    needHelp: "Need help?",
                    wasHelpful: "Was this helpful?",
                    yes: "👍 Yes",
                    no: "👎 No"
                }
            };

            // Support agent names
            function getSupportAgentName() {
                const supportAgents = [
                    'Alex Johnson', 'Sarah Chen', 'Mike Rodriguez', 'Emily Davis', 'David Kim',
                    'Lisa Thompson', 'James Wilson', 'Maria Garcia', 'Robert Brown', 'Jennifer Lee',
                    'Christopher Taylor', 'Amanda White', 'Daniel Martinez', 'Jessica Anderson', 'Matthew Thomas',
                    'Ashley Jackson', 'Joshua Harris', 'Stephanie Martin', 'Andrew Thompson', 'Nicole Garcia',
                    'Kevin Martinez', 'Rachel Davis', 'Ryan Miller', 'Samantha Wilson', 'Brandon Anderson',
                    'Lauren Taylor', 'Justin Brown', 'Megan Johnson', 'Tyler Davis', 'Kayla Rodriguez',
                    'Jordan Smith', 'Brittany Wilson', 'Zachary Martinez', 'Courtney Anderson', 'Nathan Taylor',
                    'Destiny Brown', 'Cody Johnson', 'Haley Davis', 'Austin Rodriguez', 'Paige Wilson',
                    'Logan Martinez', 'Jenna Anderson', 'Connor Taylor', 'Mackenzie Brown', 'Hunter Johnson',
                    'Savannah Davis', 'Blake Rodriguez', 'Madison Wilson', 'Caleb Martinez', 'Chloe Anderson'
                ];
                
                let sessionAgent = localStorage.getItem('fp_chat_agent');
                if (!sessionAgent) {
                    sessionAgent = supportAgents[Math.floor(Math.random() * supportAgents.length)];
                    localStorage.setItem('fp_chat_agent', sessionAgent);
                }
                
                return sessionAgent;
            }

            // Create chat UI
            function createChatUI() {
                if (document.getElementById('fpChatLauncher')) return;

                // Create enhanced launcher button
                const launcher = document.createElement('button');
                launcher.id = 'fpChatLauncher';
                launcher.setAttribute('aria-label', 'Open chat');
                launcher.className = 'fixed z-50 bottom-6 right-6 w-24 h-24 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 hover:from-blue-600 hover:via-purple-600 hover:to-pink-600 text-white rounded-full shadow-2xl flex items-center justify-center focus:outline-none transform transition-all duration-300 hover:scale-110 hover:shadow-3xl animate-float';
                launcher.innerHTML = `
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10 animate-pulse">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75c0 2.904 2.42 5.25 5.4 5.25h.9c.373 0 .738.074 1.08.217l3.487 1.41a.75.75 0 001.033-.7l-.004-1.086c0-.463.188-.907.522-1.235A5.19 5.19 0 0019.35 12.75c0-2.904-2.42-5.25-5.4-5.25H7.65c-2.98 0-5.4 2.346-5.4 5.25z"/>
                        </svg>
                        <div class="absolute -top-1 -right-1 w-5 h-5 bg-green-400 rounded-full animate-ping border-2 border-white"></div>
                        <div class="absolute -bottom-1 -left-1 w-3 h-3 bg-yellow-400 rounded-full animate-ping"></div>
                    </div>
                    <div class="absolute -top-12 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white text-xs px-2 py-1 rounded opacity-0 hover:opacity-100 transition-opacity whitespace-nowrap">
                        ${translations[chatState.currentLanguage].needHelp}
                    </div>
                `;

                // Create chat panel
                const panel = document.createElement('div');
                panel.id = 'fpChatPanel';
                panel.className = 'fixed z-50 bottom-20 right-4 w-[380px] max-w-[90vw] bg-white rounded-2xl shadow-2xl border border-gray-200 hidden transform transition-all duration-300';
                panel.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
                panel.innerHTML = `
                    <div class="flex items-center justify-between px-4 py-3 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 text-white rounded-t-xl">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center relative">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75c0 2.904 2.42 5.25 5.4 5.25h.9c.373 0 .738.074 1.08.217l3.487 1.41a.75.75 0 001.033-.7l-.004-1.086c0-.463.188-.907.522-1.235A5.19 5.19 0 0019.35 12.75c0-2.904-2.42-5.25-5.4-5.25H7.65c-2.98 0-5.4 2.346-5.4 5.25z"/>
                                </svg>
                                <div class="absolute -bottom-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white"></div>
                            </div>
                            <div>
                                <h3 class="font-semibold text-lg" id="fpChatAgentName">${getSupportAgentName()}</h3>
                                <p class="text-sm opacity-90" id="fpChatStatus">${translations[chatState.currentLanguage].online}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="fpChatClose" class="text-white hover:text-gray-200 focus:outline-none hover:bg-white/20 rounded-full p-1">✕</button>
                        </div>
                    </div>
                    
                    <div id="fpChatMessages" class="px-4 py-3 space-y-3 max-h-80 overflow-y-auto bg-gradient-to-b from-gray-50 to-gray-100 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100"></div>
                    
                    <div class="p-3 border-t bg-white">
                        <!-- Quick Actions -->
                        <div class="flex flex-wrap gap-2 mb-3">
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-blue-50 to-purple-50 hover:from-blue-100 hover:to-purple-100 text-blue-700 px-3 py-2 rounded-full transition-all duration-200 border border-blue-200 hover:border-blue-300 hover:shadow-sm" data-text="How do I register?">📝 Register</button>
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 text-green-700 px-3 py-2 rounded-full transition-all duration-200 border border-green-200 hover:border-green-300 hover:shadow-sm" data-text="Find loads near me">🔍 Find Loads</button>
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-orange-50 to-red-50 hover:from-orange-100 hover:to-red-100 text-orange-700 px-3 py-2 rounded-full transition-all duration-200 border border-orange-200 hover:border-orange-300 hover:shadow-sm" data-text="Post a broker load">📋 Post Load</button>
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-purple-50 to-pink-50 hover:from-purple-100 hover:to-pink-100 text-purple-700 px-3 py-2 rounded-full transition-all duration-200 border border-purple-200 hover:border-purple-300 hover:shadow-sm" data-text="Pricing plans">💰 Pricing</button>
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-yellow-50 to-amber-50 hover:from-yellow-100 hover:to-amber-100 text-yellow-700 px-3 py-2 rounded-full transition-all duration-200 border border-yellow-200 hover:border-yellow-300 hover:shadow-sm" data-text="How to book a load as a carrier?">✅ Book Load</button>
                            <button class="quick-reply-btn text-xs bg-gradient-to-r from-sky-50 to-blue-50 hover:from-sky-100 hover:to-blue-100 text-sky-700 px-3 py-2 rounded-full transition-all duration-200 border border-sky-200 hover:border-sky-300 hover:shadow-sm" data-text="How to create a shipment as shipper?">📦 Shipment</button>
                        </div>
                        
                        <!-- Message Input with inline file upload -->
                        <div class="flex items-center space-x-2">
                            <div class="flex-1 relative">
                                <textarea id="fpChatInput" rows="1" placeholder="${translations[chatState.currentLanguage].placeholder}" class="w-full resize-none rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 px-3 py-2 pr-10 text-sm transition-all duration-200"></textarea>
                                <button id="fpFileUpload" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-blue-500 transition-colors" onclick="triggerFileUpload()" title="Upload file">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                    </svg>
                                </button>
                                <input type="file" id="fpFileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" style="display: none;" onchange="handleFileUpload(event)">
                            </div>
                            <button id="fpChatSend" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-lg px-4 py-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg">Send</button>
                        </div>
                    </div>`;

                document.body.appendChild(launcher);
                document.body.appendChild(panel);

                // Event listeners
                launcher.addEventListener('click', toggleChatOpen);
                panel.querySelector('#fpChatClose').addEventListener('click', toggleChatOpen);
                panel.querySelector('#fpChatSend').addEventListener('click', function(){ resetInactivityTimer(); handleChatSend(); });
                const inputEl = panel.querySelector('#fpChatInput');
                inputEl.addEventListener('keydown', function(e){
                    resetInactivityTimer();
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatSend(); }
                });
                inputEl.addEventListener('input', resetInactivityTimer);
                inputEl.addEventListener('focus', resetInactivityTimer);
                
                // Quick reply buttons
                panel.querySelectorAll('.quick-reply-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const text = this.getAttribute('data-text');
                        document.getElementById('fpChatInput').value = text;
                        handleChatSend();
                    });
                });

                // File upload functionality
                const fileUpload = panel.querySelector('#fpFileUpload');
                const fileInput = panel.querySelector('#fpFileInput');
                
                // Handle file upload button click
                fileUpload.addEventListener('click', function(e) {
                    e.preventDefault();
                    resetInactivityTimer();
                    fileInput.click();
                });
                
                // Handle file input change
                fileInput.addEventListener('change', function(ev){ resetInactivityTimer(); handleFileUpload(ev); });

                // Load chat state
                loadChatState();
                // Start inactivity timer once UI is ready
                resetInactivityTimer();
                loadChatHistory();
                loadUploadedFiles();
                
                // Show welcome message if first time
                if (chatState.messages.length === 0) {
                    showWelcomeMessage();
                }
            }

            // Expose for external readiness checks and ensure initialization timing
            if (typeof window !== 'undefined') { window.createChatUI = createChatUI; }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createChatUI);
            } else {
                try { createChatUI(); } catch(e) { console.error('createChatUI init error:', e); }
            }

            // Chat functions
            function toggleChatOpen() {
                if (chatState.isOpen) {
                    closeChat();
                } else {
                    openChat();
                }
            }

            function openChat() {
                const panel = document.getElementById('fpChatPanel');
                const launcher = document.getElementById('fpChatLauncher');
                
                if (panel && launcher) {
                    panel.classList.remove('hidden');
                    panel.classList.add('animate-fadeIn');
                    launcher.style.transform = 'scale(0.9)';
                    chatState.isOpen = true;
                    
                    // Focus input
                    const input = document.getElementById('fpChatInput');
                    if (input) {
                        setTimeout(() => input.focus(), 300);
                    }
                    
                    localStorage.setItem('fp_chat_open', '1');
                }
            }

            function closeChat() {
                const panel = document.getElementById('fpChatPanel');
                const launcher = document.getElementById('fpChatLauncher');
                
                if (panel && launcher) {
                    panel.classList.add('hidden');
                    launcher.style.transform = 'scale(1)';
                    chatState.isOpen = false;
                    
                    localStorage.setItem('fp_chat_open', '0');
                }
            }

            function showWelcomeMessage() {
                const welcomeMsg = {
                    role: 'assistant',
                    text: translations[chatState.currentLanguage].welcome,
                    timestamp: new Date().toLocaleTimeString(),
                    buttons: [
                        { text: translations[chatState.currentLanguage].carrier, action: 'select-role', data: 'carrier' },
                        { text: translations[chatState.currentLanguage].broker, action: 'select-role', data: 'broker' },
                        { text: translations[chatState.currentLanguage].shipper, action: 'select-role', data: 'shipper' },
                        { text: translations[chatState.currentLanguage].browsing, action: 'select-role', data: 'browsing' }
                    ]
                };
                
                addMessage(welcomeMsg);
            }

            function addMessage(message) {
                chatState.messages.push(message);
                const messagesContainer = document.getElementById('fpChatMessages');
                if (!messagesContainer) return;

                const messageDiv = document.createElement('div');
                messageDiv.className = `flex items-start space-x-2 ${message.role === 'user' ? 'flex-row-reverse space-x-reverse' : ''} animate-fadeIn`;
                
                const avatar = message.role === 'user' ? 
                    `<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>` :
                    `<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </div>`;

                const messageClass = message.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-200';
                
                messageDiv.innerHTML = `
                    ${avatar}
                    <div class="${messageClass} rounded-lg p-3 max-w-xs shadow-sm">
                        <p class="text-sm">${escapeHTML(message.text)}</p>
                        ${message.filePreview || ''}
                        ${message.timestamp ? `<p class="text-xs opacity-70 mt-1">${message.timestamp}</p>` : ''}
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Add buttons if present
                if (message.buttons) {
                    addMessageButtons(message.buttons);
                }
                
                saveChatHistory();
            }

            function addMessageButtons(buttons) {
                const messagesContainer = document.getElementById('fpChatMessages');
                if (!messagesContainer) return;
                
                const buttonsHTML = `
                    <div class="flex flex-wrap gap-2 mt-2 animate-fadeIn">
                        ${buttons.map(btn => `
                            <button onclick="handleButtonClick('${btn.action}', '${btn.data}')" 
                                    class="px-3 py-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white text-xs rounded-full hover:from-blue-600 hover:to-purple-600 transition-all">
                                ${btn.text}
                            </button>
                        `).join('')}
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', buttonsHTML);
            }

            function handleButtonClick(action, data) {
                switch(action) {
                    case 'select-role':
                        selectUserRole(data);
                        break;
                    case 'navigate':
                        showPage(data);
                        break;
                    case 'quick-reply':
                        sendQuickReply(data);
                        break;
                }
            }

            function selectUserRole(role) {
                chatState.currentUserRole = role;
                localStorage.setItem('fpUserRole', role);
                
                let response = '';
                switch(role) {
                    case 'carrier':
                        response = `Great! I see you're a Carrier 🚛. How can I help you today?`;
                        break;
                    case 'broker':
                        response = `Perfect! You're a Broker 🤝. What would you like to do?`;
                        break;
                    case 'shipper':
                        response = `Excellent! You're a Shipper 📦. How can I assist you?`;
                        break;
                    case 'browsing':
                        response = `No problem! Feel free to explore our platform. Here are some quick links:`;
                        break;
                }
                
                addMessage({
                    role: 'assistant',
                    text: response,
                    timestamp: new Date().toLocaleTimeString(),
                    buttons: getRoleSpecificButtons(role)
                });
            }

            function getRoleSpecificButtons(role) {
                switch(role) {
                    case 'carrier':
                        return [
                            { text: '🔍 Find Loads', action: 'navigate', data: 'loadboard' },
                            { text: '📊 My Dashboard', action: 'navigate', data: 'dashboard' },
                            { text: '💰 Get Paid', action: 'navigate', data: 'payments' },
                            { text: '❓ Get Help', action: 'quick-reply', data: 'help' }
                        ];
                    case 'broker':
                        return [
                            { text: '📝 Post Load', action: 'navigate', data: 'postload' },
                            { text: '🚛 Find Carriers', action: 'navigate', data: 'carriers' },
                            { text: '📊 Analytics', action: 'navigate', data: 'analytics' },
                            { text: '❓ Get Help', action: 'quick-reply', data: 'help' }
                        ];
                    case 'shipper':
                        return [
                            { text: '💰 Get Quote', action: 'navigate', data: 'quote' },
                            { text: '📦 Track Shipment', action: 'navigate', data: 'tracking' },
                            { text: '📞 Contact Team', action: 'quick-reply', data: 'contact' },
                            { text: '❓ Get Help', action: 'quick-reply', data: 'help' }
                        ];
                    case 'browsing':
                        return [
                            { text: '🏠 Home', action: 'navigate', data: 'home' },
                            { text: '🚚 Load Board', action: 'navigate', data: 'loadboard' },
                            { text: '📞 Contact', action: 'navigate', data: 'contact' },
                            { text: 'ℹ️ About', action: 'navigate', data: 'about' }
                        ];
                }
            }

            function sendQuickReply(message) {
                const input = document.getElementById('fpChatInput');
                if (input) {
                    input.value = message;
                    handleChatSend();
                }
            }

            function escapeHTML(s) {
                return String(s).replace(/[&<>"']/g, m => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    '\'': '&#39;'
                }[m]));
            }

            function handleChatSend() {
                const input = document.getElementById('fpChatInput');
                if (!input || !input.value.trim()) return;

                const message = input.value.trim();
                input.value = '';
                
                // Add user message
                addMessage({
                    role: 'user',
                    text: message,
                    timestamp: new Date().toLocaleTimeString()
                });
                
                // Show typing indicator
                showTypingIndicator();
                
                // Generate response after delay
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAssistantResponse(message);
                    addMessage({
                        role: 'assistant',
                        text: response,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }, Math.random() * 1200 + 800);
            }

            function showTypingIndicator() {
                const messagesContainer = document.getElementById('fpChatMessages');
                if (!messagesContainer) return;

                const typingDiv = document.createElement('div');
                typingDiv.id = 'fpTypingIndicator';
                typingDiv.className = 'flex items-start space-x-2 animate-fadeIn';
                typingDiv.innerHTML = `
                    <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                        </svg>
                    </div>
                    <div class="bg-gray-100 rounded-lg p-3 max-w-xs">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <span class="text-sm text-gray-600 ml-2">${translations[chatState.currentLanguage].typing}</span>
                        </div>
                    </div>
                `;
                
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('fpTypingIndicator');
                if (typingIndicator) {
                    typingIndicator.style.opacity = '0';
                    typingIndicator.style.transform = 'translateY(10px)';
                    setTimeout(() => {
                        if (typingIndicator.parentNode) {
                            typingIndicator.parentNode.removeChild(typingIndicator);
                        }
                    }, 300);
                }
            }

            // Simple but intelligent response generation
            function generateAssistantResponse(message) {
                const normalizedMessage = message.toLowerCase().trim();
                const agent = getSupportAgentName();
                
                // Role-based responses
                if (chatState.currentUserRole) {
                    return generateRoleBasedResponse(normalizedMessage, chatState.currentUserRole, agent);
                }
                
                // General responses
                return generateGeneralResponse(normalizedMessage, agent);
            }

            function generateRoleBasedResponse(message, role, agent) {
                const responses = {
                    carrier: {
                        'find loads': `Perfect! As a carrier, you can find loads on our Load Board. Click "Load Board" to browse available loads. You can filter by origin, destination, equipment type, and rate. I can also help you set up load alerts! 🚛`,
                        'post load': `I think you meant to find loads to haul! As a carrier, you find and book loads rather than post them. Would you like me to show you how to find the best loads for your equipment? 🔍`,
                        'get paid': `Great question! FreightPro offers automated payments. Once you complete a load, payment is processed automatically. You can track your earnings in your dashboard. Need help setting up payment methods? 💰`,
                        'help': `I'm here to help you succeed as a carrier! I can assist with finding loads, setting up your profile, understanding rates, tracking shipments, and getting paid. What specific help do you need? 🚛`
                    },
                    broker: {
                        'post load': `Excellent! To post a load, click "Post Load" in the navigation. You'll need to provide origin, destination, equipment type, pickup date, and rate. I can help you optimize your posting for better carrier matches! 📝`,
                        'find carriers': `Great! You can find qualified carriers in our carrier directory. Filter by equipment type, location, and ratings. I can also help you set up carrier alerts for specific lanes! 🚛`,
                        'analytics': `Analytics help you track performance! View load posting success rates, carrier response times, and revenue trends. Access your analytics dashboard to optimize your operations! 📊`,
                        'help': `I'm here to help you succeed as a broker! I can assist with posting loads, finding carriers, managing shipments, understanding rates, and growing your business. What do you need help with? 🤝`
                    },
                    shipper: {
                        'get quote': `Perfect! To get a quote, click "Get Quote" and fill out the form with your shipment details. I can help you understand the process and find the best rates for your freight! 💰`,
                        'track shipment': `Great! You can track your shipments in real-time. Enter your tracking number or load ID to see current location, ETA, and delivery status. Need help finding your tracking info? 📦`,
                        'contact team': `I'm here to help! You can also contact our support team at support@freightpro.com or call (555) 123-4567. What specific assistance do you need? 📞`,
                        'help': `I'm here to help you with all your shipping needs! I can assist with getting quotes, booking shipments, tracking deliveries, and understanding our services. How can I help? 📦`
                    }
                };
                
                const roleResponses = responses[role] || {};
                for (const [key, response] of Object.entries(roleResponses)) {
                    if (message.includes(key)) {
                        return response;
                    }
                }
                
                return `I understand you're a ${role}. How can I help you with your ${role} needs today?`;
            }

            function generateGeneralResponse(message, agent) {
                const msg = message.toLowerCase();
                
                // Greetings
                if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey') || msg.includes('good morning') || msg.includes('good afternoon') || msg.includes('good evening') || msg.includes('greetings') || msg.includes('welcome')) {
                    return `Hello! I'm ${agent} from FreightPro support. Welcome! 🚛 How can I help you today?`;
                }
                
                // Help and Support
                if (msg.includes('help') || msg.includes('support') || msg.includes('assist') || msg.includes('guide') || msg.includes('how to') || msg.includes('tutorial') || msg.includes('instructions')) {
                    return `I'm here to help! I can assist you with finding loads, posting loads, registration, login, pricing, and general navigation. What specific help do you need? 🚛`;
                }
                
                // Load Board and Finding Loads
                if (msg.includes('loads') || msg.includes('load board') || msg.includes('find loads') || msg.includes('search loads') || msg.includes('available loads') || msg.includes('freight') || msg.includes('shipment') || msg.includes('cargo') || msg.includes('hauling') || msg.includes('transport')) {
                    return `Great! You can find loads on our Load Board. Click "Load Board" in the navigation to browse available loads. You can filter by origin, destination, equipment type, and rate. Need help with the search? 🔍`;
                }
                
                // Posting Loads (broker only)
                if (msg.includes('post') || msg.includes('create') || msg.includes('add load') || msg.includes('new load') || msg.includes('list load') || msg.includes('publish load') || msg.includes('submit load')) {
                    return `Only brokers can post loads. If your load is tied to a shipment, include the Shipment ID from the shipper. Otherwise, you can post a standalone load. Need help with broker posting? 📝`;
                }
                
                // Registration and Account
                if (msg.includes('register') || msg.includes('sign up') || msg.includes('create account') || msg.includes('new account') || msg.includes('join') || msg.includes('membership') || msg.includes('account')) {
                    return `To register, click "Register" in the navigation. You can choose to be a Carrier, Broker, or Shipper. The process is quick and free! Need help with registration? 📝`;
                }
                
                // Login and Authentication
                if (msg.includes('login') || msg.includes('sign in') || msg.includes('log in') || msg.includes('access') || msg.includes('password') || msg.includes('forgot password') || msg.includes('reset password')) {
                    return `To login, click "Login" in the navigation. If you forgot your password, there's a reset option. Need help with login issues? 🔐`;
                }
                
                // Pricing and Plans
                if (msg.includes('pricing') || msg.includes('price') || msg.includes('cost') || msg.includes('fee') || msg.includes('subscription') || msg.includes('plan') || msg.includes('billing') || msg.includes('payment') || msg.includes('money') || msg.includes('rate')) {
                    return `Our pricing is competitive and transparent! Click "Pricing" to see our plans. We offer different options for Carriers, Brokers, and Shippers. Need help understanding our pricing? 💰`;
                }
                
                // Equipment and Trucks
                if (msg.includes('equipment') || msg.includes('truck') || msg.includes('trailer') || msg.includes('vehicle') || msg.includes('flatbed') || msg.includes('dry van') || msg.includes('reefer') || msg.includes('container') || msg.includes('tanker')) {
                    return `We support all types of equipment! You can filter loads by equipment type on our Load Board. Need help finding loads for your specific equipment? 🚛`;
                }
                
                // Location and Routes
                if (msg.includes('location') || msg.includes('route') || msg.includes('origin') || msg.includes('destination') || msg.includes('pickup') || msg.includes('delivery') || msg.includes('address') || msg.includes('city') || msg.includes('state') || msg.includes('zip')) {
                    return `You can search loads by origin and destination! Use our advanced filters to find loads on your preferred routes. Need help with location-based searches? 🗺️`;
                }
                
                // Booking and Contact (carrier)
                if (msg.includes('book') || msg.includes('contact') || msg.includes('call') || msg.includes('phone') || msg.includes('email') || msg.includes('message') || msg.includes('reach out') || msg.includes('get in touch')) {
                    return `Carriers can book available loads directly. If a load is already taken, you'll get a conflict message. For contact, use the details in the load or our messaging. Need help with booking? 📞`;
                }
                
                // Features and Functionality
                if (msg.includes('feature') || msg.includes('function') || msg.includes('how does') || msg.includes('what can') || msg.includes('capabilities') || msg.includes('options') || msg.includes('tools')) {
                    return `FreightPro offers many features: real-time load board, advanced search, load posting, user profiles, and more! What specific feature are you interested in? ⚡`;
                }
                
                // Technical Issues
                if (msg.includes('error') || msg.includes('problem') || msg.includes('issue') || msg.includes('bug') || msg.includes('not working') || msg.includes('broken') || msg.includes('trouble') || msg.includes('fix')) {
                    return `I'm sorry you're experiencing issues! Please describe the problem and I'll help you resolve it. You can also try refreshing the page or clearing your browser cache. 🔧`;
                }
                
                // About and Information
                if (msg.includes('about') || msg.includes('what is') || msg.includes('tell me') || msg.includes('information') || msg.includes('details') || msg.includes('explain')) {
                    return `FreightPro is a comprehensive freight matching platform connecting Carriers, Brokers, and Shippers. We make freight transportation efficient and profitable for everyone! 🚛✨`;
                }
                
                // Thank you and Appreciation
                if (msg.includes('thank') || msg.includes('thanks') || msg.includes('appreciate') || msg.includes('great') || msg.includes('awesome') || msg.includes('excellent') || msg.includes('good job')) {
                    return `You're very welcome! I'm glad I could help. Is there anything else you'd like to know about FreightPro? 😊`;
                }
                
                // Goodbye and Farewell
                if (msg.includes('bye') || msg.includes('goodbye') || msg.includes('see you') || msg.includes('farewell') || msg.includes('later') || msg.includes('take care')) {
                    return `Goodbye! Thanks for using FreightPro. Feel free to come back anytime if you need help! Have a great day! 👋`;
                }
                
                // Default response with more context
                return `I'm here to help! I can assist with shipments (shipper), posting loads (broker), booking loads (carrier), registration, login, pricing, equipment, and routes. What do you need? Use the quick action buttons for common tasks! 🚛`;
            }

            // File upload functionality
            function triggerFileUpload() {
                document.getElementById('fpFileInput').click();
            }

            function handleFileUpload(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        alert('File size must be less than 10MB');
                        return;
                    }
                    
                    // Store file in chatState
                    const fileData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified,
                        data: null // Will store base64 data for images
                    };
                    
                    // For images, convert to base64 for display
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            fileData.data = e.target.result;
                            chatState.uploadedFiles.push(fileData);
                            saveUploadedFiles();
                            displayFileInChat(fileData);
                        };
                        reader.readAsDataURL(file);
                    } else {
                        chatState.uploadedFiles.push(fileData);
                        saveUploadedFiles();
                        displayFileInChat(fileData);
                    }
                });
                
                // Clear the input
                event.target.value = '';
            }
            
            function displayFileInChat(fileData) {
                let messageText = `📎 Uploaded: ${fileData.name} (${(fileData.size / 1024 / 1024).toFixed(2)} MB)`;
                let filePreview = '';
                
                // Display image preview
                if (fileData.type.startsWith('image/') && fileData.data) {
                    filePreview = `<div class="mt-2 max-w-xs"><img src="${fileData.data}" alt="${fileData.name}" class="rounded-lg border border-gray-200 max-w-full h-auto cursor-pointer" onclick="openFileViewer('${fileData.id}')"></div>`;
                }
                
                addMessage({
                    role: 'user',
                    text: messageText,
                    timestamp: new Date().toLocaleTimeString(),
                    filePreview: filePreview,
                    fileId: fileData.id
                });
                
                // Generate AI response about the file
                setTimeout(() => {
                    const response = generateFileResponse(fileData);
                    addMessage({
                        role: 'assistant',
                        text: response,
                        timestamp: new Date().toLocaleTimeString()
                    });
                }, 1000);
            }
            
            function generateFileResponse(fileData) {
                const agent = getSupportAgentName();
                const fileType = fileData.type.split('/')[0];
                const fileName = fileData.name.toLowerCase();
                
                if (fileType === 'image') {
                    return `Thanks for sharing the image "${fileData.name}"! 📸 I can see this file. How can I help you with this image? Are you looking for help with documentation, load details, or something else?`;
                } else if (fileName.includes('invoice') || fileName.includes('bill')) {
                    return `I see you've uploaded "${fileData.name}" - looks like an invoice or billing document! 💰 I can help you with payment questions, billing issues, or invoice processing. What do you need assistance with?`;
                } else if (fileName.includes('contract') || fileName.includes('agreement')) {
                    return `Thanks for sharing "${fileData.name}" - appears to be a contract or agreement! 📋 I can help you understand terms, rates, or any questions about this document. What would you like to know?`;
                } else if (fileName.includes('load') || fileName.includes('shipment')) {
                    return `I can see you've uploaded "${fileData.name}" - looks like load or shipment information! 🚛 I can help you with load details, tracking, or any questions about this shipment. What do you need help with?`;
                } else {
                    return `Thanks for uploading "${fileData.name}"! 📄 I can see this document. How can I help you with this file? Are you looking for assistance with its contents, processing, or something specific?`;
                }
            }
            
            function openFileViewer(fileId) {
                const file = chatState.uploadedFiles.find(f => f.id == fileId);
                if (!file) return;
                
                // Create modal for file viewing
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-4 max-w-4xl max-h-4xl overflow-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">${file.name}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">✕</button>
                        </div>
                        <div class="text-center">
                            ${file.type.startsWith('image/') ? 
                                `<img src="${file.data}" alt="${file.name}" class="max-w-full h-auto rounded-lg">` :
                                `<div class="p-8 text-gray-500">
                                    <svg class="w-16 h-16 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                    </svg>
                                    <p>File: ${file.name}</p>
                                    <p>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                                    <p>Type: ${file.type}</p>
                                </div>`
                            }
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            function saveUploadedFiles() {
                try {
                    localStorage.setItem('fp_uploaded_files', JSON.stringify(chatState.uploadedFiles));
                } catch(e) {
                    console.log('Could not save uploaded files');
                }
            }
            
            function loadUploadedFiles() {
                try {
                    chatState.uploadedFiles = JSON.parse(localStorage.getItem('fp_uploaded_files') || '[]') || [];
                } catch(e) {
                    chatState.uploadedFiles = [];
                }
            }

            // Language fixed to English; helpers kept for future expansion
            function changeLanguage() { /* no-op: English only */ }
            function updateChatLanguage() {
                const elementStatus = document.getElementById('fpChatStatus');
                if (elementStatus) elementStatus.textContent = translations.en.online;
                const input = document.getElementById('fpChatInput');
                if (input) input.placeholder = translations.en.placeholder;
            }

            // State management
            function loadChatState() {
                const savedState = localStorage.getItem('fp_chat_open');
                const savedRole = localStorage.getItem('fpUserRole');
                const savedLanguage = localStorage.getItem('fpChatLanguage');
                
                if (savedState === '1') {
                    openChat();
                }
                
                if (savedRole) {
                    chatState.currentUserRole = savedRole;
                } else {
                    try {
                        const token = localStorage.getItem('fp_token') || '';
                        if (token) {
                            fetch(`${window.API_BASE_URL}/auth/me`, { headers: { 'Authorization': `Bearer ${token}` } })
                                .then(r => r.ok ? r.json() : null)
                                .then(data => {
                                    const role = data?.user?.accountType || data?.user?.role;
                                    if (role) {
                                        chatState.currentUserRole = role;
                                        localStorage.setItem('fpUserRole', role);
                                    }
                                })
                                .catch(() => {});
                        }
                    } catch(e) {}
                }
                
                // Force English only
                chatState.currentLanguage = 'en';
                updateChatLanguage();
            }

            function saveChatHistory() {
                try {
                    localStorage.setItem('fp_chat_history', JSON.stringify(chatState.messages));
                } catch(e) {
                    console.log('Could not save chat history');
                }
            }

            function loadChatHistory() {
                try {
                    chatState.messages = JSON.parse(localStorage.getItem('fp_chat_history') || '[]') || [];
                    const messagesContainer = document.getElementById('fpChatMessages');
                    if (!messagesContainer) return;
                    
                    chatState.messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `flex items-start space-x-2 ${msg.role === 'user' ? 'flex-row-reverse space-x-reverse' : ''}`;
                        
                        const avatar = msg.role === 'user' ? 
                            `<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </div>` :
                            `<div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-4 h-4 text-blue-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
                                </svg>
                            </div>`;

                        const messageClass = msg.role === 'user' ? 'bg-blue-600 text-white' : 'bg-white text-gray-800 border border-gray-200';
                        
                        messageDiv.innerHTML = `
                            ${avatar}
                            <div class="${messageClass} rounded-lg p-3 max-w-xs shadow-sm">
                                <p class="text-sm">${escapeHTML(msg.text)}</p>
                                ${msg.timestamp ? `<p class="text-xs opacity-70 mt-1">${msg.timestamp}</p>` : ''}
                            </div>
                        `;
                        
                        messagesContainer.appendChild(messageDiv);
                    });
                    
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                } catch(e) {
                    chatState.messages = [];
                }
            }

            // Initialize chat when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', createChatUI);
            } else {
                createChatUI();
            }
        })();
        
        // Live Features - Multi-User Optimized
        function initializeLiveFeatures() {
            if (liveFeaturesInitialized) return;
            liveFeaturesInitialized = true;
            
            // Dynamic scheduling based on system load
            function getUpdateInterval() {
                const profile = performanceProfiles[userActivityLevel];
                return profile.updateInterval;
            }
            
            // Use requestAnimationFrame for smoother updates
            function scheduleUpdate() {
                if (isPageVisible) {
                    requestAnimationFrame(() => {
                        checkPerformance(); // Monitor performance
                        const now = Date.now();
                        if (now - lastUpdateTime > updateThrottle) {
                            updateLiveStatistics();
                            lastUpdateTime = now;
                        }
                        setTimeout(scheduleUpdate, getUpdateInterval());
                    });
                } else {
                    setTimeout(scheduleUpdate, getUpdateInterval() * 2); // Check less frequently when hidden
                }
            }
            
            // Update activity feed with dynamic frequency
            function scheduleActivityUpdate() {
                if (isPageVisible) {
                    updateActivityFeed();
                }
                const interval = userActivityLevel === 'critical' ? 15000 : 
                                userActivityLevel === 'high' ? 10000 : 8000;
                setTimeout(scheduleActivityUpdate, interval);
            }
            
            // Intelligent load refresh with adaptive throttling
            function scheduleLoadRefresh() {
                if (isPageVisible && document.getElementById('loadboard') && 
                    !document.getElementById('loadboard').classList.contains('hidden')) {
                    refreshLoadsIntelligently();
                }
                const interval = userActivityLevel === 'critical' ? 60000 : 
                                userActivityLevel === 'high' ? 45000 : 30000;
                setTimeout(scheduleLoadRefresh, interval);
            }
            
            // Start the update cycles
            scheduleUpdate();
            scheduleActivityUpdate();
            scheduleLoadRefresh();
        }

            // FreightPro Knowledge Base
            const freightProKnowledge = {
                // Filtering Options
                filteringOptions: {
                    rate: 'Minimum rate filtering',
                    miles: 'Maximum miles filtering'
                },
                
                // Sorting Options
                sortingOptions: [
                    'Rate (High to Low)',
                    'Rate (Low to High)', 
                    'Distance (Near to Far)',
                    'Pickup Date (Earliest)',
                    'Recently Posted'
                ],
                
                // View Modes
                viewModes: ['List View', 'Card View', 'Compact View'],
                
                // Pages & Navigation
                pages: {
                    home: 'Landing page with hero section and stats',
                    register: 'User registration with account type selection',
                    login: 'User authentication',
                    loadboard: 'Main load board with search and filters',
                    postload: 'Post new loads (Broker/Shipper only)',
                    profile: 'User profile and account management',
                    pricing: 'Subscription plans and billing'
                },
                
                // Features
                features: [
                    'Real-time load board',
                    'Advanced search and filtering',
                    'Load posting and booking',
                    'User authentication',
                    'Email verification',
                    'Profile management',
                    'Auto-refresh system',
                    'Performance optimization',
                    'Mobile responsive design',
                    'Live chat support'
                ],
                
                // Technical Details
                technical: {
                    backend: 'Node.js with MongoDB',
                    frontend: 'HTML5, CSS3, JavaScript',
                    api: 'RESTful API endpoints',
                    database: 'MongoDB Atlas',
                    deployment: 'Render (backend), Netlify (frontend)',
                    security: 'JWT tokens, password hashing, rate limiting'
                }
            };

            // AI-powered response generation
            function generateAIResponse(question, agent) {
                // AI Intent Analysis with enhanced knowledge
                const intent = analyzeIntent(question, freightProKnowledge);
                
                // Generate contextual response with complete knowledge
                return generateContextualResponse(intent, question, agent, freightProKnowledge);
            }

            function analyzeIntent(question, knowledge) {
                const q = question.toLowerCase();
                const words = q.split(/\s+/);
                
                // Enhanced AI scoring system for intent detection
                const intents = {
                    greeting: 0,
                    registration: 0,
                    login: 0,
                    loadSearch: 0,
                    loadPost: 0,
                    loadBook: 0,
                    pricing: 0,
                    profile: 0,
                    navigation: 0,
                    help: 0,
                    equipment: 0,
                    userTypes: 0,
                    features: 0,
                    technical: 0
                };

                // Greeting patterns
                if (/^(hi|hello|hey|good morning|good evening|howdy)/.test(q)) intents.greeting += 10;
                if (/how are you|what's up|how's it going/.test(q)) intents.greeting += 5;

                // Registration patterns
                if (/sign up|register|create account|new account|join/.test(q)) intents.registration += 10;
                if (/account|signup|registration/.test(q)) intents.registration += 5;

                // Login patterns
                if (/log in|login|sign in|signin|access account/.test(q)) intents.login += 10;
                if (/password|forgot|reset|can't login/.test(q)) intents.login += 5;

                // Load search patterns
                if (/find loads|search loads|load board|browse loads|available loads/.test(q)) intents.loadSearch += 10;
                if (/loads from|loads to|loads near|freight|shipping/.test(q)) intents.loadSearch += 8;
                if (/origin|destination|pickup|delivery/.test(q)) intents.loadSearch += 5;
                if (/filter|sort|search/.test(q)) intents.loadSearch += 3;

                // Load posting patterns
                if (/post load|create load|new load|add load|list load/.test(q)) intents.loadPost += 10;
                if (/broker|shipper|posting|listing/.test(q)) intents.loadPost += 5;

                // Load booking patterns
                if (/book load|accept load|take load|claim load/.test(q)) intents.loadBook += 10;
                if (/carrier|booking|accepting/.test(q)) intents.loadBook += 5;

                // Pricing patterns
                if (/price|pricing|plan|subscription|billing|cost/.test(q)) intents.pricing += 10;
                if (/monthly|yearly|payment|upgrade|basic|advanced|ultima/.test(q)) intents.pricing += 5;

                // Profile patterns
                if (/profile|settings|account details|company info/.test(q)) intents.profile += 10;
                if (/update|change|edit|modify/.test(q)) intents.profile += 5;

                // Navigation patterns
                if (/go to|open|navigate|show me/.test(q)) intents.navigation += 10;
                if (/page|section|menu/.test(q)) intents.navigation += 5;

                // Equipment patterns
                if (/equipment|van|flatbed|reefer|tanker|container|step deck|lowboy|car carrier|power only/.test(q)) intents.equipment += 10;
                if (/dry van|refrigerated|temperature|open deck/.test(q)) intents.equipment += 5;

                // User type patterns
                if (/carrier|broker|shipper|usdot|mc number|authority/.test(q)) intents.userTypes += 10;
                if (/transport|freight|ship|move/.test(q)) intents.userTypes += 5;

                // Features patterns
                if (/feature|function|capability|what can|how does/.test(q)) intents.features += 10;
                if (/api|database|backend|frontend|technical/.test(q)) intents.technical += 10;

                // Help patterns
                if (/help|how to|what is|explain|tutorial/.test(q)) intents.help += 10;
                if (/don't know|confused|stuck/.test(q)) intents.help += 5;

                // Find highest scoring intent
                const topIntent = Object.keys(intents).reduce((a, b) => intents[a] > intents[b] ? a : b);
                const confidence = intents[topIntent];

                return {
                    intent: topIntent,
                    confidence: confidence,
                    originalQuestion: question,
                    extractedInfo: extractInfo(question, knowledge)
                };
            }

            function extractInfo(question, knowledge) {
                const q = question.toLowerCase();
                const info = {};

                // Extract cities (expanded list)
                const cities = [
                    'chicago', 'atlanta', 'dallas', 'houston', 'los angeles', 'new york', 'miami', 'denver', 'phoenix', 'seattle',
                    'boston', 'philadelphia', 'san antonio', 'san diego', 'san jose', 'austin', 'jacksonville', 'fort worth',
                    'columbus', 'charlotte', 'san francisco', 'indianapolis', 'seattle', 'denver', 'washington', 'boston',
                    'el paso', 'nashville', 'detroit', 'oklahoma city', 'portland', 'las vegas', 'memphis', 'louisville',
                    'baltimore', 'milwaukee', 'albuquerque', 'tucson', 'fresno', 'sacramento', 'mesa', 'kansas city',
                    'atlanta', 'omaha', 'colorado springs', 'raleigh', 'virginia beach', 'miami', 'oakland', 'minneapolis'
                ];
                cities.forEach(city => {
                    if (q.includes(city)) {
                        if (!info.cities) info.cities = [];
                        info.cities.push(city);
                    }
                });

                // Extract equipment (all types from knowledge base)
                knowledge.equipmentTypes.forEach(eq => {
                    if (q.includes(eq.name.toLowerCase()) || q.includes(eq.description.toLowerCase())) {
                        if (!info.equipment) info.equipment = [];
                        info.equipment.push(eq.name);
                    }
                });

                // Extract load types
                knowledge.loadTypes.forEach(lt => {
                    if (q.includes(lt.name.toLowerCase()) || q.includes(lt.description.toLowerCase())) {
                        if (!info.loadTypes) info.loadTypes = [];
                        info.loadTypes.push(lt.name);
                    }
                });

                // Extract user types
                Object.keys(knowledge.userTypes).forEach(userType => {
                    if (q.includes(userType) || q.includes(knowledge.userTypes[userType].name.toLowerCase())) {
                        info.userType = userType;
                    }
                });

                // Extract pricing plans
                Object.keys(knowledge.pricingPlans).forEach(plan => {
                    if (q.includes(plan) || q.includes(knowledge.pricingPlans[plan].name.toLowerCase())) {
                        info.pricingPlan = plan;
                    }
                });

                // Extract features
                knowledge.features.forEach(feature => {
                    if (q.includes(feature.toLowerCase())) {
                        if (!info.features) info.features = [];
                        info.features.push(feature);
                    }
                });

                return info;
            }

            function generateContextualResponse(intent, question, agent, knowledge) {
                const { intent: intentType, confidence, extractedInfo } = intent;

                // Add typing indicator for more realistic feel
                showTypingIndicator();

                // High confidence responses with personality and emojis
                if (confidence >= 8) {
                    switch (intentType) {
                        case 'greeting':
                            const greetings = [
                                `Hey there! 👋 ${agent} here. Ready to help you with FreightPro! What can I do for you today?`,
                                `Hello! 😊 ${agent} at your service. How can I make your FreightPro experience better?`,
                                `Hi! 🚛 ${agent} here. Let's get you moving with freight! What do you need help with?`,
                                `Good to see you! ✨ ${agent} here. What brings you to FreightPro today?`
                            ];
                            return greetings[Math.floor(Math.random() * greetings.length)];
                        
                        case 'registration':
                            let regResponse = `Great choice! 🎉 To get started, click "Register" in the top navigation. Choose your role: `;
                            Object.values(knowledge.userTypes).forEach((type, index) => {
                                regResponse += `${type.icon} ${type.name} (${type.description})`;
                                if (index < Object.values(knowledge.userTypes).length - 1) regResponse += ', ';
                            });
                            regResponse += `. Fill out the form and verify your email. What type of account are you looking to create?`;
                            return regResponse;
                        
                        case 'login':
                            const loginResponses = [
                                `No problem! 🔑 Use the "Login" button in the header. Enter your email and password. Having trouble? I can help with password reset!`,
                                `Easy peasy! 😊 Click "Login" in the top navigation, enter your credentials, and you're in! Need help with password recovery?`,
                                `Let's get you logged in! 🚀 Use the "Login" button, enter your email and password. Forgot your password? I can guide you through reset!`
                            ];
                            return loginResponses[Math.floor(Math.random() * loginResponses.length)];
                        
                        case 'loadSearch':
                            let searchResponse = `Perfect! 🔍 Let's find you some loads. Open the Load Board and `;
                            if (extractedInfo.cities && extractedInfo.cities.length > 0) {
                                searchResponse += `I see you're interested in loads involving ${extractedInfo.cities.join(' and ')}. `;
                            }
                            if (extractedInfo.equipment && extractedInfo.equipment.length > 0) {
                                searchResponse += `For ${extractedInfo.equipment.join(' or ')} equipment, `;
                            }
                            searchResponse += `set your filters and click Search. You can sort by rate 💰, miles 📍, or pickup date 📅. Available filters: ${Object.keys(knowledge.searchFilters).join(', ')}. Need help with specific filters?`;
                            return searchResponse;
                        
                        case 'loadPost':
                            let postResponse = `Awesome! 📋 To post a load, you need to be a Broker or Shipper. Go to "Post Load" and provide: `;
                            postResponse += `origin, destination, equipment type (${knowledge.equipmentTypes.map(e => e.name).join(', ')}), `;
                            postResponse += `load type (${knowledge.loadTypes.map(l => l.name).join(', ')}), weight, pickup date, and rate. Your load will appear on the board for carriers to book! 🚛`;
                            return postResponse;
                        
                        case 'loadBook':
                            const bookResponses = [
                                `Excellent choice! 🎯 Browse the Load Board, click on a load for details, then hit "Book". Confirm your booking and the load status changes to "Booked" ✅. You're all set!`,
                                `Let's book that load! 🚛 Find your perfect load on the board, click for details, then "Book". Confirm and you're ready to roll! 🎉`,
                                `Great! 📋 Click on any load in the board to see details, then "Book" it. Confirm your booking and you're officially on the job! 💪`
                            ];
                            return bookResponses[Math.floor(Math.random() * bookResponses.length)];
                        
                        case 'pricing':
                            let pricingResponse = `Check out our amazing plans! 💎 Go to the Pricing section, toggle between Monthly and Yearly billing (save money with yearly! 💰). `;
                            pricingResponse += `Available plans: `;
                            Object.values(knowledge.pricingPlans).forEach((plan, index) => {
                                pricingResponse += `${plan.badge} ${plan.name} ($${plan.price.monthly}/mo, $${plan.price.yearly}/year)`;
                                if (index < Object.values(knowledge.pricingPlans).length - 1) pricingResponse += ', ';
                            });
                            pricingResponse += `. Any questions about the plans?`;
                            return pricingResponse;
                        
                        case 'profile':
                            const profileResponses = [
                                `Sure thing! 👤 Access your profile from the top-right menu. You can update company info, contact details, and change your password there. Everything in one place! 🎯`,
                                `Easy! ⚙️ Click your profile in the top-right corner. Update company details, contacts, password - whatever you need! All your settings in one spot.`,
                                `No problem! 🔧 Go to your profile (top-right menu) to update company information, contact details, and password. Keep everything current! ✨`
                            ];
                            return profileResponses[Math.floor(Math.random() * profileResponses.length)];
                        
                        case 'equipment':
                            let equipmentResponse = `Great question about equipment! 🚛 FreightPro supports all major equipment types: `;
                            knowledge.equipmentTypes.forEach((eq, index) => {
                                equipmentResponse += `${eq.icon} ${eq.name} (${eq.description})`;
                                if (index < knowledge.equipmentTypes.length - 1) equipmentResponse += ', ';
                            });
                            equipmentResponse += `. You can filter loads by equipment type on the Load Board!`;
                            return equipmentResponse;
                        
                        case 'userTypes':
                            let userTypeResponse = `Perfect! FreightPro serves three main user types: `;
                            Object.values(knowledge.userTypes).forEach((type, index) => {
                                userTypeResponse += `${type.icon} ${type.name} - ${type.description} (${type.requirements})`;
                                if (index < Object.values(knowledge.userTypes).length - 1) userTypeResponse += ', ';
                            });
                            userTypeResponse += `. Which type are you interested in?`;
                            return userTypeResponse;
                        
                        case 'features':
                            let featuresResponse = `FreightPro is packed with amazing features! 🚀 Here's what we offer: `;
                            featuresResponse += knowledge.features.slice(0, 5).join(', ') + `, and much more! `;
                            featuresResponse += `Our platform includes ${knowledge.features.length} total features to make freight management easy. What specific feature interests you?`;
                            return featuresResponse;
                        
                        case 'technical':
                            let techResponse = `Great technical question! 🔧 FreightPro is built with: `;
                            techResponse += `${knowledge.technical.backend} backend, ${knowledge.technical.frontend} frontend, `;
                            techResponse += `${knowledge.technical.database} database, and ${knowledge.technical.security} security. `;
                            techResponse += `We use ${knowledge.technical.api} and deploy on ${knowledge.technical.deployment}. Need more technical details?`;
                            return techResponse;
                        
                        case 'navigation':
                            const navMatch = question.match(/go to|open|navigate to|show me/i);
                            if (navMatch) {
                                const target = question.replace(/go to|open|navigate to|show me/i, '').trim();
                                try {
                                    if (target.includes('load board')) showPage('loadboard');
                                    else if (target.includes('post load')) showPage('postload');
                                    else if (target.includes('profile')) showPage('profile');
                                    else if (target.includes('pricing')) showPage('pricing');
                                } catch(e) {}
                                return `Taking you to ${target} right now! 🚀`;
                            }
                            return `I can help you navigate anywhere! 🗺️ Available pages: ${Object.keys(knowledge.pages).join(', ')}. Just tell me where you'd like to go!`;
                        
                        case 'help':
                            const helpResponses = [
                                `I'm your FreightPro expert! 🎓 I can help with registration, finding loads, posting loads, booking, pricing, profile management, equipment types, user types, and more! What specific area needs attention?`,
                                `Happy to help! 🤝 I know everything about FreightPro - registration, load management, pricing, profiles, navigation, equipment, user types. What would you like to master today?`,
                                `I'm here for you! 💪 Whether it's registration, load search, posting, booking, pricing, account settings, equipment, or user types - I've got you covered! What can I help you with?`
                            ];
                            return helpResponses[Math.floor(Math.random() * helpResponses.length)];
                    }
                }

                // Medium confidence - ask for clarification with personality
                if (confidence >= 5) {
                    const clarifications = [
                        `I think you're asking about ${intentType.replace(/([A-Z])/g, ' $1').toLowerCase()}, but I want to make sure I give you the perfect answer! 😊 Could you be more specific?`,
                        `Hmm, sounds like you need help with ${intentType.replace(/([A-Z])/g, ' $1').toLowerCase()} 🤔. Can you give me a bit more detail so I can help you better?`,
                        `I'm picking up on ${intentType.replace(/([A-Z])/g, ' $1').toLowerCase()} vibes! 🎯 Help me understand exactly what you need so I can give you the best guidance.`
                    ];
                    return clarifications[Math.floor(Math.random() * clarifications.length)];
                }

                // Low confidence - general help with personality
                const generalHelps = [
                    `I'm ${agent}, your FreightPro support superstar! ⭐ I can help with registration, load management, pricing, account settings, equipment types, user types, and more! What would you like to explore?`,
                    `Hey! 👋 ${agent} here, your FreightPro guide! I'm here to help with everything - registration, loads, pricing, profiles, equipment, user types. What adventure shall we go on? 🚀`,
                    `Hi there! 😊 ${agent} at your service! I know FreightPro inside and out. Whether it's loads, accounts, pricing, equipment, user types, or anything else - I'm your go-to person! What can I help you with?`
                ];
                return generalHelps[Math.floor(Math.random() * generalHelps.length)];
            }

            // Add typing indicator for realistic chat experience
            function showTypingIndicator() {
                const messagesList = document.getElementById('fpChatMessages');
                if (!messagesList) return;
                
                // Remove any existing typing indicator first
                hideTypingIndicator();
                
                const typingEl = document.createElement('div');
                typingEl.id = 'typingIndicator';
                typingEl.className = 'flex justify-start animate-fadeIn';
                typingEl.innerHTML = `
                    <div class="max-w-[85%] bg-white border border-gray-200 text-gray-500 rounded-lg px-3 py-2 text-sm shadow-sm">
                        <div class="flex items-center space-x-1">
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                            <div class="w-2 h-2 bg-blue-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                            <span class="ml-2 text-xs font-medium">${getSupportAgentName()} is typing...</span>
                        </div>
                    </div>
                `;
                messagesList.appendChild(typingEl);
                messagesList.scrollTop = messagesList.scrollHeight;
            }

            function hideTypingIndicator() {
                const typingEl = document.getElementById('typingIndicator');
                if (typingEl) {
                    typingEl.style.opacity = '0';
                    typingEl.style.transform = 'translateY(-10px)';
                    setTimeout(() => {
                        if (typingEl && typingEl.parentNode) {
                            typingEl.parentNode.removeChild(typingEl);
                        }
                    }, 200);
                }
            }

            if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', createChatUI); else createChatUI();

        function saveChatHistory(){ try { localStorage.setItem('fp_chat_history', JSON.stringify(chatState.messages)); } catch(e){} }
        function loadChatHistory(){
            try { chatState.messages = JSON.parse(localStorage.getItem('fp_chat_history') || '[]') || []; } catch(e){ chatState.messages = []; }
            const list = document.getElementById('fpChatMessages'); if (!list) return;
            chatState.messages.forEach(m => addMessage(m.role, m.text));
        }
        
        // Live Features - Multi-User Optimized
        function initializeLiveFeatures() {
            if (liveFeaturesInitialized) return;
            liveFeaturesInitialized = true;
            
            // Dynamic scheduling based on system load
            function getUpdateInterval() {
                const profile = performanceProfiles[userActivityLevel];
                return profile.updateInterval;
            }
            
            // Use requestAnimationFrame for smoother updates
            function scheduleUpdate() {
                if (isPageVisible) {
                    requestAnimationFrame(() => {
                        checkPerformance(); // Monitor performance
                        const now = Date.now();
                        if (now - lastUpdateTime > updateThrottle) {
                            updateLiveStatistics();
                            lastUpdateTime = now;
                        }
                        setTimeout(scheduleUpdate, getUpdateInterval());
                    });
                } else {
                    setTimeout(scheduleUpdate, getUpdateInterval() * 2); // Check less frequently when hidden
                }
            }
            
            // Update activity feed with dynamic frequency
            function scheduleActivityUpdate() {
                if (isPageVisible) {
                    updateActivityFeed();
                }
                const interval = userActivityLevel === 'critical' ? 15000 : 
                                userActivityLevel === 'high' ? 10000 : 8000;
                setTimeout(scheduleActivityUpdate, interval);
            }
            
            // Intelligent load refresh with adaptive throttling
            function scheduleLoadRefresh() {
                if (isPageVisible && document.getElementById('loadboard') && 
                    !document.getElementById('loadboard').classList.contains('hidden')) {
                    refreshLoadsIntelligently();
                }
                const interval = userActivityLevel === 'critical' ? 60000 : 
                                userActivityLevel === 'high' ? 45000 : 30000;
                setTimeout(scheduleLoadRefresh, interval);
            }
            
            // Start the update cycles
            scheduleUpdate();
            scheduleActivityUpdate();
            scheduleLoadRefresh();
            
            // Initial update
            updateLiveStatistics();
            updateActivityFeed();
        }

        function refreshLoadsIntelligently() {
            // Only refresh if user is on load board page and not actively searching
            if (!isPageVisible || !document.getElementById('loadboard') || 
                document.getElementById('loadboard').classList.contains('hidden')) {
                return;
            }

            try {
                // Generate new loads to replace some existing ones
                const newLoads = generateDynamicLoads();
                
                // Replace 15% of existing loads with new ones (but max 50 loads)
                const replacementCount = Math.min(50, Math.floor(loads.length * 0.15));
                
                // Remove old loads from the beginning
                loads = loads.slice(replacementCount);
                
                // Add new loads at the end
                const loadsToAdd = newLoads.slice(0, replacementCount);
                loads = [...loads, ...loadsToAdd];
                
                // Ensure we don't exceed MAX_LOADS
                if (loads.length > MAX_LOADS) {
                    loads = loads.slice(-MAX_LOADS); // Keep only the last MAX_LOADS
                }
                
                // Update filtered loads
                filteredLoads = [...loads];
                
                // Update window.loads for consistency
                window.loads = loads;
                
                // Re-apply current filters only if page is still visible
                if (filteredLoads.length > 0 && isPageVisible) {
                    applyFiltersAndRender();
                }
                
                console.log(`Intelligent refresh complete - Managing ${loads.length} loads`);
            } catch (error) {
                console.warn('Error in intelligent load refresh:', error);
                // Fallback to regular refresh if intelligent refresh fails
                if (isPageVisible) {
                    debouncedRefreshLoads();
                }
            }
        }

        // Advanced DOM element cache to reduce queries
        const domCache = {
            liveStats: {
                carriers: null,
                shippers: null,
                freightValue: null,
                loads: null,
                totalLoads: null
            },
            loadBoard: {
                container: null,
                results: null,
                filters: null,
                pagination: null
            },
            modals: {
                loadDetails: null,
                postLoad: null,
                login: null,
                register: null
            },
            forms: {
                search: null,
                postLoad: null,
                login: null,
                register: null
            }
        };
        
        // Smart DOM element getter with caching
        function getCachedElement(id, category = 'general') {
            if (!domCache[category]) domCache[category] = {};
            if (!domCache[category][id]) {
                domCache[category][id] = document.getElementById(id);
            }
            return domCache[category][id];
        }
        
        // Clear DOM cache when elements might be removed
        function clearDOMCache(category = null) {
            if (category) {
                if (domCache[category]) {
                    Object.keys(domCache[category]).forEach(key => {
                        if (domCache[category][key] && !document.contains(domCache[category][key])) {
                            domCache[category][key] = null;
                        }
                    });
                }
            } else {
                Object.keys(domCache).forEach(cat => {
                    Object.keys(domCache[cat]).forEach(key => {
                        if (domCache[cat][key] && !document.contains(domCache[cat][key])) {
                            domCache[cat][key] = null;
                        }
                    });
                });
            }
        }

        function updateLiveStatistics() {
            // Only update if page is visible
            if (!isPageVisible) return;
            
            // Use cached DOM elements
            const carriersEl = getCachedElement('liveCarriers', 'liveStats');
            const shippersEl = getCachedElement('liveShippers', 'liveStats');
            const freightValueEl = getCachedElement('liveFreightValue', 'liveStats');
            const loadsEl = getCachedElement('liveLoads', 'liveStats');
            const totalLoadsEl = getCachedElement('totalLoads', 'liveStats');

            // Batch DOM updates to reduce reflows
            const updates = [];
            
            if (carriersEl) {
                const baseValue = 1247892;
                const variation = Math.floor(Math.random() * 100) - 50;
                const newValue = baseValue + variation;
                updates.push({ element: carriersEl, value: newValue.toLocaleString() });
            }

            if (shippersEl) {
                const baseValue = 85432;
                const variation = Math.floor(Math.random() * 20) - 10;
                const newValue = baseValue + variation;
                updates.push({ element: shippersEl, value: newValue.toLocaleString() });
            }

            if (freightValueEl) {
                const baseValue = 180.2;
                const variation = (Math.random() * 0.4) - 0.2;
                const newValue = (baseValue + variation).toFixed(1);
                updates.push({ element: freightValueEl, value: `$${newValue}B` });
            }

            // Calculate available loads once and reuse
            const availableLoads = loads ? loads.filter(load => load.status === 'available').length : 0;
            
            if (loadsEl) {
                const variation = Math.floor(Math.random() * 100) - 50;
                const newValue = Math.max(800, availableLoads + variation);
                updates.push({ element: loadsEl, value: newValue.toLocaleString() });
            }

            if (totalLoadsEl) {
                const variation = Math.floor(Math.random() * 50) - 25;
                const newValue = Math.max(800, availableLoads + variation);
                updates.push({ element: totalLoadsEl, value: newValue.toLocaleString() });
            }

            // Apply all updates in a single batch
            updates.forEach(update => {
                if (update.element && update.element.textContent !== update.value) {
                    update.element.textContent = update.value;
                }
            });
        }

        function updateActivityFeed() {
            const activityFeed = document.getElementById('activityFeed');
            if (!activityFeed) return;

            const activities = [
                {
                    type: 'load_posted',
                    message: 'New load posted: Chicago → Atlanta',
                    company: 'ABC Logistics',
                    time: '2 minutes ago',
                    amount: '$2,150',
                    color: 'green'
                },
                {
                    type: 'load_booked',
                    message: 'Load booked: Miami → New York',
                    company: 'Fresh Transport',
                    time: '4 minutes ago',
                    amount: '$3,840',
                    color: 'blue'
                },
                {
                    type: 'carrier_registered',
                    message: 'New carrier registered: Texas Cold Chain',
                    company: 'Houston, TX',
                    time: '6 minutes ago',
                    amount: 'Reefer',
                    color: 'orange'
                },
                {
                    type: 'load_posted',
                    message: 'Load posted: Denver → Salt Lake City',
                    company: 'Mountain Peak Transport',
                    time: '8 minutes ago',
                    amount: '$2,200',
                    color: 'purple'
                },
                {
                    type: 'load_booked',
                    message: 'Load booked: New York → Boston',
                    company: 'Northeast Express',
                    time: '12 minutes ago',
                    amount: '$1,800',
                    color: 'green'
                },
                {
                    type: 'shipper_registered',
                    message: 'New shipper registered: Bay Area Logistics',
                    company: 'San Francisco, CA',
                    time: '15 minutes ago',
                    amount: 'Technology',
                    color: 'blue'
                },
                {
                    type: 'load_posted',
                    message: 'Load posted: Los Angeles → Phoenix',
                    company: 'West Coast Freight',
                    time: '18 minutes ago',
                    amount: '$1,890',
                    color: 'green'
                },
                {
                    type: 'load_booked',
                    message: 'Load booked: Dallas → Denver',
                    company: 'Lone Star Logistics',
                    time: '22 minutes ago',
                    amount: '$2,340',
                    color: 'blue'
                }
            ];

            // Randomly select 6 activities
            const selectedActivities = activities.sort(() => 0.5 - Math.random()).slice(0, 6);
            
            // Update time stamps to be more recent
            const timeOptions = ['1 minute ago', '2 minutes ago', '3 minutes ago', '4 minutes ago', '5 minutes ago', '7 minutes ago'];
            selectedActivities.forEach((activity, index) => {
                activity.time = timeOptions[index] || activity.time;
            });

            // Generate HTML for activities
            const activitiesHTML = selectedActivities.map(activity => {
                const colorClasses = {
                    green: 'bg-green-50 border-green-500 text-green-600',
                    blue: 'bg-blue-50 border-blue-500 text-blue-600',
                    orange: 'bg-orange-50 border-orange-500 text-orange-600',
                    purple: 'bg-purple-50 border-purple-500 text-purple-600'
                };
                
                const colorClass = colorClasses[activity.color] || colorClasses.green;
                const dotColor = activity.color === 'green' ? 'bg-green-500' : 
                                activity.color === 'blue' ? 'bg-blue-500' :
                                activity.color === 'orange' ? 'bg-orange-500' : 'bg-purple-500';

                return `
                    <div class="flex items-center space-x-3 p-3 ${colorClass.split(' ')[0]} rounded-lg border-l-4 ${colorClass.split(' ')[1]}">
                        <div class="w-2 h-2 ${dotColor} rounded-full animate-pulse"></div>
                        <div class="flex-1">
                            <div class="text-sm font-medium text-gray-800">${activity.message}</div>
                            <div class="text-xs text-gray-500">${activity.company} • ${activity.time}</div>
                        </div>
                        <div class="text-xs ${colorClass.split(' ')[2]} font-medium">${activity.amount}</div>
                    </div>
                `;
            }).join('');

            activityFeed.innerHTML = activitiesHTML;
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    window.currentUser = JSON.parse(storedUser);
                    currentUser = window.currentUser;
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                    window.currentUser = null;
                    currentUser = null;
                }
            }

            const initialContainer = getLoadResultsContainer();
            if (initialContainer) {
                renderLoads(filteredLoads);
                updateLoadStats(filteredLoads);
            }

            // Initialize navigation
            initNavigation();
            updateNavigation();

            // Load initial load board data in background so dashboard is ready
            initializeLoadBoard();

            // Initialize live statistics and activity feed
            initializeLiveFeatures();

            const backBtn = document.getElementById('navBackBtn');
            const forwardBtn = document.getElementById('navForwardBtn');
            if (backBtn) backBtn.addEventListener('click', navigateBack);
            if (forwardBtn) forwardBtn.addEventListener('click', navigateForward);
        });

        function resetAuthorityForm() {
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');
            if (authorityVerificationSection) {
                authorityVerificationSection.classList.add('hidden');
            }
            const brokerMCQuestionSection = document.getElementById('brokerMCQuestionSection');
            const brokerUSDOTQuestionSection = document.getElementById('brokerUSDOTQuestionSection');
            const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
            if (brokerMCQuestionSection) brokerMCQuestionSection.classList.add('hidden');
            if (brokerUSDOTQuestionSection) brokerUSDOTQuestionSection.classList.add('hidden');
            if (carrierQuestionSection) carrierQuestionSection.classList.add('hidden');
        }

        function goBackToUSDOTQuestion() {
            const brokerMCQuestionSection = document.getElementById('brokerMCQuestionSection');
            const brokerUSDOTQuestionSection = document.getElementById('brokerUSDOTQuestionSection');
            const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
            const authorityVerificationSection = document.getElementById('authorityVerificationSection');

            if (authorityVerificationSection) authorityVerificationSection.classList.add('hidden');

            if (window.selectedAccountType === 'broker') {
                if (brokerUSDOTQuestionSection) brokerUSDOTQuestionSection.classList.remove('hidden');
                // showNotification('Please answer the USDOT question first.', 'info');
            } else if (window.selectedAccountType === 'carrier') {
                if (carrierQuestionSection) carrierQuestionSection.classList.remove('hidden');
                // showNotification('Please confirm your MC authority first.', 'info');
            } else if (window.brokerHasMC === true || window.brokerHasMC === false) {
                if (brokerMCQuestionSection) brokerMCQuestionSection.classList.remove('hidden');
                // showNotification('Return to the MC authority question.', 'info');
            } else {
                goBackToAccountType();
            }
        }

        function validateAuthorityFields(requireMC) {
            const usdField = document.getElementById('authorityUSDOT');
            const mcField = document.getElementById('authorityMC');
            const usdRequired = !usdField?.closest('#usdotFieldContainer')?.classList.contains('hidden');
            const mcRequired = requireMC && !document.getElementById('mcFieldContainer')?.classList.contains('hidden');
            const missingUsd = usdRequired && usdField && !usdField.value.trim();
            const missingMc = mcRequired && mcField && !mcField.value.trim();
            
            // Validate company information fields
            const companyLegalName = document.querySelector('input[name="companyLegalName"]');
            const companyEmail = document.querySelector('input[name="companyEmail"]');
            const businessAddress = document.querySelector('input[name="companyAddress"]');
            const companyPhone = document.querySelector('input[name="companyPhone"]');
            
            const missingCompanyName = companyLegalName && !companyLegalName.value.trim();
            const missingCompanyEmail = companyEmail && !companyEmail.value.trim();
            const missingBusinessAddress = businessAddress && !businessAddress.value.trim();
            const missingCompanyPhone = companyPhone && !companyPhone.value.trim();
            
            if (missingUsd || missingMc || missingCompanyName || missingCompanyEmail || missingBusinessAddress || missingCompanyPhone) {
                if (usdField) usdField.classList.toggle('border-red-400', missingUsd);
                if (mcField) mcField.classList.toggle('border-red-400', missingMc);
                if (companyLegalName) companyLegalName.classList.toggle('border-red-400', missingCompanyName);
                if (companyEmail) companyEmail.classList.toggle('border-red-400', missingCompanyEmail);
                if (businessAddress) businessAddress.classList.toggle('border-red-400', missingBusinessAddress);
                if (companyPhone) companyPhone.classList.toggle('border-red-400', missingCompanyPhone);
                
                let errorMessage = 'Please fill in all required fields before continuing:';
                if (missingUsd) errorMessage += ' USDOT number,';
                if (missingMc) errorMessage += ' MC number,';
                if (missingCompanyName) errorMessage += ' Company legal name,';
                if (missingCompanyEmail) errorMessage += ' Company email,';
                if (missingBusinessAddress) errorMessage += ' Business address,';
                if (missingCompanyPhone) errorMessage += ' Phone number,';
                
                errorMessage = errorMessage.replace(/,$/, ''); // Remove trailing comma
                showNotification(errorMessage, 'warning');
                return false;
            }
            
            // Clear error styling
            usdField?.classList.remove('border-red-400');
            mcField?.classList.remove('border-red-400');
            companyLegalName?.classList.remove('border-red-400');
            companyEmail?.classList.remove('border-red-400');
            businessAddress?.classList.remove('border-red-400');
            
            return true;
        }

        function selectUSDOTOption(answer) {
            const hasUSDOT = answer === 'yes';
            const usdotQuestionSection = document.getElementById('usdotQuestionSection');
            if (usdotQuestionSection) usdotQuestionSection.classList.add('hidden');
            if (window.selectedAccountType === 'broker') {
                if (hasUSDOT) {
                    window.brokerHasMC = isMcStillRequired();
                    if (isMcStillRequired()) {
                        showBrokerAuthorityQuestion();
                    } else {
                        handleBrokerUSDOTResponse(true);
                    }
                } else {
                    handleBrokerUSDOTResponse(false);
                }
            } else if (window.selectedAccountType === 'carrier') {
                if (hasUSDOT) {
                    const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
                    if (carrierQuestionSection) carrierQuestionSection.classList.remove('hidden');
                } else {
                    // Only show notification if not resetting form
                    if (!window.isResettingForm) {
                        showNotification('Carriers must have a USDOT number to continue.', 'warning');
                    }
                    goBackToAccountType();
                }
            }
        }

        function showCarrierAuthorityQuestion() {
            const carrierQuestionSection = document.getElementById('carrierAuthorityQuestionSection');
            if (carrierQuestionSection) {
                carrierQuestionSection.classList.remove('hidden');
                // showNotification('Carrier authority question shown', 'info');
            }
        }

        // Missing functions that were referenced but not defined
        function useFMCSAData() {
            console.log('useFMCSAData called - this function is no longer needed');
            // This function is no longer needed since we removed FMCSA integration
            proceedToRegistration();
        }

        function showManualCompanyInfo() {
            console.log('showManualCompanyInfo called - this function is no longer needed');
            // This function is no longer needed since we always show manual entry
            proceedToRegistration();
        }

        function submitManualCompanyInfo() {
            console.log('submitManualCompanyInfo called - redirecting to proceedToRegistration');
            // This function is no longer needed since we always show manual entry
            proceedToRegistration();
        }

        function showAPIKeyRequestForm() {
            console.log('showAPIKeyRequestForm called - this function is no longer needed');
            // This function is no longer needed since we removed FMCSA integration
            // showNotification('FMCSA API integration has been removed. Please enter company information manually.', 'info');
        }

        // Transfer authority and company data to main registration form
        function transferAuthorityDataToRegistration() {
            console.log('Transferring authority data to registration form');
            
            // Get authority form data
            const authorityUSDOT = document.getElementById('authorityUSDOT');
            const authorityMC = document.getElementById('authorityMC');
            const companyLegalName = document.querySelector('input[name="companyLegalName"]');
            const dbaName = document.querySelector('input[name="dbaName"]');
            const companyEmail = document.querySelector('input[name="companyEmail"]');
            const businessAddress = document.querySelector('input[name="companyAddress"]');
            const companyPhone = document.querySelector('input[name="companyPhone"]');
            
            // Get registration form fields
            const regCompany = document.querySelector('input[name="company"]');
            const regEmail = document.querySelector('input[name="email"]');
            const regPhone = document.querySelector('input[name="phone"]');
            
            // Transfer data if fields exist
            if (authorityUSDOT && authorityUSDOT.value) {
                // Store USDOT for later use in registration
                window.storedUSDOT = authorityUSDOT.value;
            }
            
            if (authorityMC && authorityMC.value) {
                // Store MC for later use in registration
                window.storedMC = authorityMC.value;
            }
            
            if (companyLegalName && companyLegalName.value && regCompany) {
                regCompany.value = companyLegalName.value;
            }
            
            if (companyEmail && companyEmail.value && regEmail) {
                regEmail.value = companyEmail.value;
            }
            
            if (businessAddress && businessAddress.value) {
                // Store business address for later use
                window.storedBusinessAddress = businessAddress.value;
            }
            
            if (companyPhone && companyPhone.value && regPhone) {
                regPhone.value = companyPhone.value;
            }
            
            console.log('Authority data transferred:', {
                usdot: window.storedUSDOT,
                mc: window.storedMC,
                company: regCompany?.value,
                email: regEmail?.value,
                address: window.storedBusinessAddress,
                phone: regPhone?.value
            });
        }

        // Reset all registration form state to start fresh
        function resetRegistrationForm() {
            console.log('Resetting registration form to start fresh');
            
            // Set flag to prevent notifications during reset
            window.isResettingForm = true;
            
            // Reset all global variables
            window.selectedAccountType = null;
            window.carrierHasMC = null;
            window.brokerHasMC = null;
            window.storedUSDOT = null;
            window.storedMC = null;
            window.storedBusinessAddress = null;
            window.fmcsaCompanyData = null;
            
            // Clear localStorage
            localStorage.removeItem('selectedAccountType');
            
            // Hide all registration sections
            const sectionsToHide = [
                'accountTypeSelectionSection',
                'usdotQuestionSection', 
                'brokerMCQuestionSection',
                'brokerUSDOTQuestionSection',
                'carrierAuthorityQuestionSection',
                'authorityVerificationSection',
                'registrationFormSection',
                'accountTypeStatus'
            ];
            
            sectionsToHide.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section) {
                    section.classList.add('hidden');
                }
            });
            
            // Show only the account type selection section
            const accountTypeSection = document.getElementById('accountTypeSelectionSection');
            if (accountTypeSection) {
                accountTypeSection.classList.remove('hidden');
            }
            
            // Reset all form fields
            const formsToReset = [
                'authorityVerificationForm',
                'registerForm'
            ];
            
            formsToReset.forEach(formId => {
                const form = document.getElementById(formId);
                if (form) {
                    form.reset();
                }
            });
            
            // Clear any error styling
            const errorFields = document.querySelectorAll('.border-red-400');
            errorFields.forEach(field => {
                field.classList.remove('border-red-400');
            });
            
            // Reset authority form fields specifically
            const authorityFields = [
                'authorityUSDOT',
                'authorityMC'
            ];
            
            authorityFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    field.classList.remove('border-red-400');
                }
            });
            
            // Reset company info fields
            const companyFields = document.querySelectorAll('input[name="companyLegalName"], input[name="companyEmail"], input[name="businessAddress"]');
            companyFields.forEach(field => {
                field.value = '';
                field.classList.remove('border-red-400');
            });
            
            // Clear the reset flag
            window.isResettingForm = false;
            
            console.log('Registration form reset complete');
        }

    </script>
</body>
</html>